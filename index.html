<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Честный ипотечный калькулятор — рассчитайте платёж онлайн</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="description" content="Рассчитайте ежемесячный платёж по ипотеке быстро и&nbsp;просто">

  <!-- Open Graph / Link Preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Честный ипотечный калькулятор">
  <meta property="og:description" content="Рассчитайте ежемесячный платёж по ипотеке быстро и просто">
  <meta property="og:image" content="http://honestcalc.ru/og-image.png" id="og-image">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Честный ипотечный калькулятор">
  <meta name="twitter:description" content="Рассчитайте ежемесячный платёж по ипотеке быстро и просто">
  <meta name="twitter:image" content="http://honestcalc.ru/og-image.png" id="twitter-image">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%232D4A3E'/%3E%3Cpath d='M5 15L16 6L27 15' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M8 13V24C8 24.5 8.5 25 9 25H23C23.5 25 24 24.5 24 24V13' stroke='white' stroke-width='2.5' stroke-linecap='round' fill='none'/%3E%3Cpath d='M12 22L14.5 18L17.5 20L21 15' stroke='%23F0C864' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Ccircle cx='21' cy='15' r='1.5' fill='%23F0C864'/%3E%3C/svg%3E">

  <!-- Fonts: Warm, readable choices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,400;7..72,500;7..72,600;7..72,700&family=Onest:wght@100..900&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Warm, trustworthy palette */
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C65D3B;
      --terracotta-light: #E07B5A;
      --terracotta-dark: #A44D2F;
      --forest: #2D4A3E;
      --forest-light: #3D6353;
      --charcoal: #2C2C2C;
      --warm-gray: #6B6560;
      --gold: #D4A03C;
      --gold-light: #F0C864;

      /* Typography scale */
      --text-xs: clamp(0.875rem, 0.8rem + 0.25vw, 1rem);
      --text-sm: clamp(1rem, 0.9rem + 0.35vw, 1.125rem);
      --text-base: clamp(1.125rem, 1rem + 0.5vw, 1.375rem);
      --text-lg: clamp(1.375rem, 1.2rem + 0.75vw, 1.75rem);
      --text-xl: clamp(1.75rem, 1.5rem + 1vw, 2.5rem);
      --text-2xl: clamp(2.25rem, 1.8rem + 1.5vw, 3.5rem);

      /* Spacing */
      --space-xs: clamp(0.5rem, 0.4rem + 0.25vw, 0.75rem);
      --space-sm: clamp(0.75rem, 0.6rem + 0.5vw, 1.25rem);
      --space-md: clamp(1rem, 0.8rem + 0.75vw, 1.75rem);
      --space-lg: clamp(1.5rem, 1.2rem + 1vw, 2.5rem);
      --space-xl: clamp(2rem, 1.5rem + 1.5vw, 4rem);

      /* Borders & shadows */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 32px;
      --shadow-soft: 0 4px 20px rgba(44, 44, 44, 0.08);
      --shadow-medium: 0 8px 40px rgba(44, 44, 44, 0.12);
      --shadow-strong: 0 16px 60px rgba(44, 44, 44, 0.16);

      /* Bento specific */
      --bento-gap: clamp(12px, 1.5vw, 20px);
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--text-base);
      line-height: 1.6;
      color: var(--charcoal);
      background: var(--cream);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Decorative background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(198, 93, 59, 0.04) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(45, 74, 62, 0.04) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(212, 160, 60, 0.03) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--forest);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-weight: 600;
      z-index: 1000;
      transition: top 0.3s ease;
    }

    .skip-link:focus {
      top: var(--space-sm);
    }

    /* Header */
    header {
      padding: var(--space-md) var(--space-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      gap: var(--space-md);
    }

    .logo {
      font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      flex-shrink: 0;
      letter-spacing: -0.02em;
    }

    .logo-icon {
      width: 52px;
      height: 52px;
      background: linear-gradient(145deg, var(--forest) 0%, var(--forest-light) 100%);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 32px;
      height: 32px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      line-height: 1.2;
    }

    .logo-subtitle {
      font-size: 13px;
      font-weight: 400;
      color: var(--warm-gray);
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .header-nav a {
      color: var(--warm-gray);
      text-decoration: none;
      font-size: var(--text-xs);
      font-weight: 500;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      transition: color 0.2s ease, background 0.2s ease;
    }

    .header-nav a:hover {
      color: var(--forest);
      background: rgba(45, 74, 62, 0.06);
    }

    /* Key rate badge */
    .key-rate {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(198, 93, 59, 0.08);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      color: var(--terracotta);
      font-weight: 500;
      flex-shrink: 0;
      text-decoration: none;
      transition: background 0.2s ease;
    }

    .key-rate:hover {
      background: rgba(198, 93, 59, 0.15);
    }

    .key-rate svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .key-rate-label {
      color: inherit;
    }

    @media (max-width: 700px) {
      header {
        flex-wrap: wrap;
        gap: var(--space-sm);
      }

      .logo span:not(.logo-icon) {
        display: none;
      }

      .header-nav {
        order: 3;
        width: 100%;
        justify-content: center;
        border-top: 1px solid var(--cream-dark);
        padding-top: var(--space-sm);
        margin-top: var(--space-xs);
      }

      .key-rate {
        margin-left: auto;
      }
    }

    /* ==========================================
       BENTO GRID LAYOUT
       ========================================== */

    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--space-lg) var(--space-xl);
    }

    .calculator-intro {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .calculator-intro-text {
      font-size: var(--text-sm);
      color: var(--warm-gray);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.5;
    }

    .bento-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--bento-gap);
      grid-auto-flow: dense;
    }

    /* Bento card base styles */
    .bento-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      animation: bentoFadeIn 0.6s ease-out backwards;
      transition: transform 0.3s ease, box-shadow 0.3s ease, height 0.3s ease, max-height 0.3s ease;
    }

    @media (min-width: 901px) {
      .bento-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-medium);
      }
    }

    @keyframes bentoFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Staggered animation delays */
    .bento-card:nth-child(1) { animation-delay: 0.05s; }
    .bento-card:nth-child(2) { animation-delay: 0.1s; }
    .bento-card:nth-child(3) { animation-delay: 0.15s; }
    .bento-card:nth-child(4) { animation-delay: 0.2s; }
    .bento-card:nth-child(5) { animation-delay: 0.25s; }
    .bento-card:nth-child(6) { animation-delay: 0.3s; }
    .bento-card:nth-child(7) { animation-delay: 0.35s; }
    .bento-card:nth-child(8) { animation-delay: 0.4s; }
    .bento-card:nth-child(9) { animation-delay: 0.45s; }
    .bento-card:nth-child(10) { animation-delay: 0.5s; }

    /* Property Price Card */
    .bento-price {
      grid-column: span 7;
      padding: var(--space-lg);
    }

    /* Hero Payment Card - Large featured card */
    .bento-hero {
      grid-column: span 5;
      grid-row: span 3;
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: var(--space-xl);
      overflow: hidden;
    }

    .bento-hero::before,
    .bento-hero::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
    }

    .bento-hero::before {
      width: 300px;
      height: 300px;
      background: white;
      top: -100px;
      right: -100px;
    }

    .bento-hero::after {
      width: 200px;
      height: 200px;
      background: var(--gold);
      bottom: -50px;
      left: -50px;
    }

    .bento-hero:hover {
      transform: translateY(-4px);
    }

    /* Down Payment Card */
    .bento-downpayment {
      grid-column: span 4;
      padding: var(--space-lg);
    }

    /* Interest Rate Card */
    .bento-rate {
      grid-column: span 3;
      padding: var(--space-lg);
    }

    /* Term Selector Card */
    .bento-term {
      grid-column: span 4;
      padding: var(--space-lg);
      overflow: visible;
    }

    /* Start Date Card */
    .bento-date {
      grid-column: span 3;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    /* Pie Chart Card */
    .bento-pie {
      grid-column: span 5;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .bento-pie .chart-title {
      align-self: flex-start;
    }

    /* Hero Actions (inside hero card) */
    .hero-actions {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
    }

    .hero-actions .action-btn {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      backdrop-filter: blur(4px);
    }

    .hero-actions .share-wrapper {
      flex: 1;
      display: flex;
    }

    .hero-actions .share-wrapper .action-btn {
      width: 100%;
    }

    .hero-actions .action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Sticky Early Repayment Panel - Hidden, using bento-early instead */
    .sticky-early-panel {
      display: none;
    }

    .sticky-early-panel.expanded {
      width: 800px;
      max-width: 95vw;
    }

    .sticky-early-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: var(--forest);
      color: white;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .sticky-early-header:hover {
      background: var(--forest-light);
    }

    .sticky-early-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .sticky-early-title svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .sticky-early-badge {
      display: none;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      font-size: 12px;
      font-weight: 600;
    }

    .sticky-early-badge.visible {
      display: inline-flex;
    }

    .sticky-early-summary-mini {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.9);
    }

    .sticky-early-summary-mini span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sticky-early-summary-mini .value {
      font-weight: 600;
      color: var(--gold-light);
    }

    .sticky-early-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .sticky-early-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .sticky-early-toggle svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
      transition: transform 0.3s ease;
    }

    .sticky-early-panel.expanded .sticky-early-toggle svg {
      transform: rotate(180deg);
    }

    .sticky-early-content-wrapper {
      display: none;
    }

    .sticky-early-panel.expanded .sticky-early-content-wrapper {
      display: block;
    }

    .sticky-early-content {
      background: white;
    }

    .sticky-early-content-inner {
      padding: var(--space-md);
      max-height: 50vh;
      overflow-y: auto;
    }

    @media (max-width: 768px) {
      .sticky-early-panel {
        bottom: var(--space-sm);
        max-width: calc(100% - var(--space-md));
      }

      .sticky-early-panel.expanded {
        max-width: 95vw;
      }

      .sticky-early-header {
        padding: var(--space-xs) var(--space-sm);
        gap: var(--space-sm);
      }

      .sticky-early-summary-mini {
        display: none;
      }

      .sticky-early-content-inner {
        max-height: 60vh;
      }
    }

    /* Chart Card */
    .bento-chart {
      grid-column: span 7;
      padding: var(--space-lg);
      overflow: visible;
    }

    /* Early Repayment Bento Card */
    .bento-early {
      grid-column: span 6;
      padding: var(--space-lg);
      overflow: visible; /* Allow dropdowns and tooltips to overflow */
    }

    .bento-early-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .bento-early-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
    }

    .bento-early-title svg {
      width: 34px;
      height: 34px;
      fill: var(--forest);
    }

    .bento-early-badge {
      display: none;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      background: var(--terracotta);
      color: white;
      font-size: var(--text-xs);
      font-weight: 600;
      border-radius: 12px;
    }

    .bento-early-badge.visible {
      display: flex;
    }

    .bento-early-content {
      display: flex;
      flex-direction: column;
    }

    .bento-early-list-section {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .bento-early-summary-section {
      display: block;
      padding-top: var(--space-md);
    }

    .bento-early-summary-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--forest);
      margin-bottom: var(--space-sm);
    }

    .bento-early-summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-sm);
    }

    .bento-early-summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .bento-early-summary-label {
      font-size: var(--text-xs);
      color: var(--warm-gray);
    }

    .bento-early-summary-value {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
    }

    .bento-early-summary-value.positive {
      color: var(--forest);
    }

    .bento-early-empty {
      display: none;
    }

    .bento-early-empty.visible {
      display: block;
    }

    .bento-early-empty-inner {
      overflow: hidden;
      color: var(--warm-gray);
      font-size: var(--text-sm);
      padding: var(--space-sm) 0;
      text-align: center;
    }

    .bento-early-list {
      display: flex;
      flex-direction: column;
    }

    .bento-early-item-wrapper {
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      margin-top: 0;
      background: var(--cream-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: grid-template-rows 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out;
    }

    .bento-early-item-wrapper.visible {
      grid-template-rows: 1fr;
      opacity: 1;
    }

    .bento-early-item-wrapper.has-gap {
      margin-top: var(--space-sm);
    }

    .bento-early-item-wrapper.removing {
      grid-template-rows: 0fr;
      opacity: 0;
      pointer-events: none;
    }

    .bento-early-item-wrapper.removing.has-gap {
      margin-top: 0;
    }

    .bento-early-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
      position: relative;
      min-height: 0;
    }

    /* Primary row: Date + Amount (main inputs) */
    .bento-early-primary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
      align-items: end;
    }

    .bento-early-primary .bento-early-item-field {
      justify-content: flex-end;
    }

    .bento-early-date-hint {
      font-size: 12px;
      font-weight: 500;
      color: var(--forest);
      margin: 2px 0 4px;
    }

    .bento-early-date-hint-value {
      font-weight: 600;
      color: var(--forest);
    }

    /* Secondary row: Frequency + Effect (options) */
    .bento-early-secondary {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding-top: var(--space-xs);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .bento-early-secondary-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .bento-early-secondary-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--warm-gray);
      white-space: nowrap;
    }

    @keyframes slideInFade {
      from {
        opacity: 0;
        transform: translateY(-12px) scale(0.97);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .bento-early-item-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bento-early-remove {
      position: absolute;
      top: var(--space-xs);
      right: var(--space-xs);
    }

    .bento-early-item-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Total payment hint tooltip trigger */
    .total-payment-hint {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(45, 74, 62, 0.1);
      color: var(--forest);
      cursor: help;
      transition: background 0.2s ease;
    }

    .total-payment-hint:hover {
      background: rgba(45, 74, 62, 0.18);
    }

    .total-payment-hint svg {
      width: 10px;
      height: 10px;
    }

    /* Global tooltip rendered in body */
    .global-tooltip {
      position: fixed;
      background: var(--charcoal);
      color: white;
      font-size: 12px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      pointer-events: none;
    }

    .global-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }

    .global-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--charcoal);
    }

    .bento-early-item-input,
    .bento-early-item-select {
      padding: 12px 14px;
      border: 1.5px solid rgba(45, 74, 62, 0.12);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 500;
      font-family: inherit;
      background: white;
      color: var(--charcoal);
      transition: all 0.2s ease;
    }

    .bento-early-item-input::placeholder {
      opacity: 0.3;
    }

    .bento-early-item-select {
      appearance: none;
      padding-right: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%232D4A3E' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px;
      cursor: pointer;
    }

    .bento-early-item-input:hover,
    .bento-early-item-select:hover {
      border-color: rgba(45, 74, 62, 0.25);
    }

    .bento-early-item-input:focus,
    .bento-early-item-select:focus {
      outline: none;
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(45, 74, 62, 0.1);
    }

    .bento-early-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .bento-early-input-wrapper .bento-early-item-input {
      width: 100%;
      padding-right: 36px;
    }

    .bento-early-input-suffix {
      position: absolute;
      right: 14px;
      color: var(--forest);
      font-size: 15px;
      font-weight: 600;
      pointer-events: none;
      opacity: 0.6;
    }

    .bento-early-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 50%;
      color: var(--warm-gray);
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.6;
    }

    .bento-early-item:hover .bento-early-remove {
      opacity: 1;
    }

    .bento-early-remove:hover {
      background: rgba(198, 93, 59, 0.12);
      color: var(--terracotta);
      transform: scale(1.1);
    }

    .bento-early-remove:active {
      transform: scale(0.95);
    }

    .bento-early-remove svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Amount validation error */
    .bento-early-input-wrapper.has-error .bento-early-item-input {
      border-color: var(--terracotta);
      background: rgba(198, 93, 59, 0.04);
    }

    .bento-early-input-wrapper.has-error .bento-early-item-input:focus {
      border-color: var(--terracotta);
      box-shadow: 0 0 0 3px rgba(198, 93, 59, 0.12);
    }

    .repayment-amount-type-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .bento-early-amount-error {
      font-size: 12px;
      font-weight: 500;
      color: var(--terracotta);
      display: none;
      white-space: nowrap;
    }

    .bento-early-amount-error.visible {
      display: inline;
    }

    /* Custom dropdown for month selector */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }

    /* Hide native select on desktop, show custom dropdown */
    @media (hover: hover) and (pointer: fine) {
      .custom-dropdown .bento-early-item-select {
        display: none;
      }
    }

    /* Show native select on mobile/touch devices */
    @media (hover: none), (pointer: coarse) {
      .custom-dropdown-trigger {
        display: none !important;
      }
      .custom-dropdown-menu {
        display: none !important;
      }
    }

    .custom-dropdown-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1.5px solid rgba(45, 74, 62, 0.12);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      gap: 8px;
    }

    .custom-dropdown-trigger:hover {
      border-color: rgba(45, 74, 62, 0.25);
    }

    .custom-dropdown-trigger:focus,
    .custom-dropdown.open .custom-dropdown-trigger {
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(45, 74, 62, 0.1);
    }

    .custom-dropdown-trigger-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .custom-dropdown-trigger-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      color: var(--forest);
      transition: transform 0.2s ease;
    }

    .custom-dropdown.open .custom-dropdown-trigger-icon {
      transform: rotate(180deg);
    }

    .custom-dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      min-width: 100%;
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
      overflow: hidden;
    }

    .custom-dropdown.open .custom-dropdown-menu,
    .custom-dropdown-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Month dropdown specific styles (menu can be in body or inside dropdown) */
    .month-dropdown .custom-dropdown-menu,
    .month-dropdown-menu {
      max-height: 320px;
      overflow-y: auto;
      min-width: 280px;
    }

    .month-dropdown .custom-dropdown-option,
    .month-dropdown-menu .custom-dropdown-option {
      padding: var(--space-sm);
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      position: relative;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .month-dropdown .custom-dropdown-option:hover,
    .month-dropdown-menu .custom-dropdown-option:hover {
      background: var(--cream);
    }

    .month-dropdown .custom-dropdown-option.selected,
    .month-dropdown-menu .custom-dropdown-option.selected {
      background: rgba(45, 74, 62, 0.06);
    }

    .month-dropdown .custom-dropdown-option .custom-dropdown-option-check,
    .month-dropdown-menu .custom-dropdown-option .custom-dropdown-option-check {
      position: absolute;
      right: var(--space-sm);
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--forest);
      opacity: 0;
    }

    .month-dropdown .custom-dropdown-option.selected .custom-dropdown-option-check,
    .month-dropdown-menu .custom-dropdown-option.selected .custom-dropdown-option-check {
      opacity: 1;
    }

    .month-option-main {
      display: flex;
      align-items: baseline;
      gap: 10px;
      width: 100%;
    }

    .month-option-date {
      font-size: 15px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .month-option-payment {
      font-size: 12px;
      color: var(--warm-gray);
      background: var(--cream);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .month-option-balance {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .month-option-remaining {
      font-size: 13px;
      color: var(--forest);
      font-weight: 500;
    }

    .month-option-progress {
      font-size: 12px;
      color: var(--warm-gray);
    }

    .month-dropdown .custom-dropdown-option:hover .month-option-remaining,
    .month-dropdown-menu .custom-dropdown-option:hover .month-option-remaining {
      color: var(--forest-light);
    }

    .month-dropdown .custom-dropdown-option.selected .month-option-payment,
    .month-dropdown-menu .custom-dropdown-option.selected .month-option-payment {
      background: rgba(45, 74, 62, 0.12);
      color: var(--forest);
    }

    .month-dropdown-year-divider {
      padding: 8px var(--space-sm);
      font-size: 11px;
      font-weight: 600;
      color: var(--warm-gray);
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .month-dropdown-year-divider:first-child {
      border-top: none;
    }

    /* Responsive: stack on mobile */
    @media (max-width: 768px) {
      .bento-early {
        padding: var(--space-md);
        display: flex;
        flex-direction: column;
      }

      .bento-early-header {
        display: contents;
      }

      .bento-early-title {
        font-size: var(--text-md);
        order: -1;
        margin-bottom: var(--space-sm);
      }

      .bento-early-toggle-btn {
        order: 2;
        width: 100%;
        justify-content: center;
        padding: var(--space-sm);
        margin-top: var(--space-sm);
      }

      .bento-early-content {
        order: 1;
        display: contents;
      }

      .bento-early-list-section {
        order: 1;
      }

      .bento-early-summary-section {
        order: 3;
        margin-top: var(--space-md);
      }

      .bento-early-item {
        padding: var(--space-sm);
      }

      .bento-early-primary {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }

      .bento-early-secondary {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
      }

      .bento-early-secondary-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .repayment-frequency-toggle,
      .repayment-effect-toggle {
        width: 100%;
      }

      .bento-early-item-select {
        width: 100%;
      }

      .bento-early-remove {
        top: var(--space-xs);
        right: var(--space-xs);
      }
    }

    .bento-early-toggle-btn {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--forest);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bento-early-toggle-btn:hover {
      background: #1E3329;
      transform: translateY(-1px);
    }

    .bento-early-toggle-btn:active {
      transform: translateY(0);
    }

    .bento-early-toggle-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .bento-early-add-item-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      margin-top: var(--space-md);
      background: transparent;
      color: var(--forest);
      border: 2px dashed var(--forest);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bento-early-add-item-btn:hover {
      background: var(--forest);
      color: white;
      border-style: solid;
    }

    .bento-early-add-item-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    @media (max-width: 768px) {
      .bento-early-summary-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Schedule Table Card */
    .bento-schedule {
      grid-column: span 6;
    }

    /* Tips Cards */
    .bento-tip {
      grid-column: span 6;
      padding: var(--space-md) var(--space-lg);
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: var(--space-md);
    }

    .bento-tip h3 {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--terracotta);
      width: 200px;
      flex-shrink: 0;
    }

    .bento-tip p {
      font-size: var(--text-xs);
      color: var(--warm-gray);
      line-height: 1.5;
      border-left: 2px solid var(--cream-dark);
      padding-left: var(--space-md);
    }

    @media (max-width: 1024px) and (min-width: 769px) {
      .bento-tip h3 {
        width: 140px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }
    }

    /* ==========================================
       RESPONSIVE BENTO GRID
       ========================================== */

    /* Large screens: 1100-1440px */
    @media (max-width: 1440px) and (min-width: 1100px) {
      .bento-early { grid-column: span 12; }
      .bento-schedule { grid-column: span 12; }
      .bento-price .card-label,
      .bento-downpayment .card-label,
      .bento-rate .card-label,
      .bento-term .card-label,
      .bento-date .card-label {
        font-size: 0.8rem;
      }
      .bento-date .wheel-item {
        font-size: var(--text-sm);
      }
      .bento-date #day-wheel {
        flex: 0 0 40px;
      }
      .bento-date #month-wheel {
        flex: 0 0 90px;
      }
      .bento-date #year-wheel {
        flex: 0 0 55px;
      }
      .payment-type-desc {
        font-size: 0.8rem;
      }
    }

    /* Medium screens: 768-1100px - two columns with inputs left, hero right */
    @media (max-width: 1100px) and (min-width: 769px) {
      .bento-grid {
        grid-auto-flow: row;
      }
      .bento-price { grid-column: 1 / 6; grid-row: 1; }
      .bento-downpayment { grid-column: 1 / 6; grid-row: 2; }
      .bento-rate { grid-column: 1 / 6; grid-row: 3; }
      .bento-hero { grid-column: 6 / 13; grid-row: 1 / 4; }
      .bento-term { grid-column: span 6; }
      .bento-date { grid-column: span 6; }
      .bento-early { grid-column: span 12; order: 1; }
      .bento-chart { grid-column: span 12; order: 2; }
      .bento-pie { grid-column: span 12; order: 3; }
      .bento-schedule { grid-column: span 12; order: 4; }
      .bento-tip { grid-column: span 6; order: 5; }
    }

    @media (max-width: 768px) {
      .bento-grid {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }
      .bento-price,
      .bento-hero,
      .bento-downpayment,
      .bento-rate,
      .bento-term,
      .bento-date,
      .bento-pie,
      .bento-chart,
      .bento-schedule,
      .bento-early,
      .bento-tip {
        grid-column: span 1;
        grid-row: span 1;
      }
      .bento-hero {
        min-height: 380px;
      }
      .hero-actions {
        flex-direction: row;
        justify-content: center;
      }
      .bento-tip {
        flex-direction: column;
        align-items: flex-start;
      }
      .bento-tip h3 {
        width: auto;
        min-width: auto;
      }
      .bento-tip p {
        border-left: none;
        padding-left: 0;
        border-top: 2px solid var(--cream-dark);
        padding-top: var(--space-sm);
      }
    }

    @media (max-width: 768px) {
      .bento-grid {
        display: flex;
        flex-direction: column;
      }

      .bento-price { order: 1; }
      .bento-downpayment { order: 2; }
      .bento-rate { order: 3; }
      .bento-term { order: 4; }
      .bento-date { order: 5; }
      .bento-hero { order: 6; }
      .bento-early { order: 7; }
      .bento-pie { order: 8; }
      .bento-chart { order: 9; }
      .bento-schedule { order: 10; }
      .bento-tip { order: 11; }

      /* Chart mobile styles */
      .bento-chart {
        padding: var(--space-md);
      }

      .chart-container {
        height: 240px;
        margin: 0 calc(-1 * var(--space-md));
        width: calc(100% + var(--space-md) * 2);
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }

      .chart-container::-webkit-scrollbar {
        height: 4px;
      }

      .chart-container::-webkit-scrollbar-track {
        background: var(--cream-dark);
        border-radius: 2px;
      }

      .chart-container::-webkit-scrollbar-thumb {
        background: var(--warm-gray);
        border-radius: 2px;
      }

      .chart-legend {
        gap: var(--space-md);
      }

      .chart-legend-item {
        font-size: var(--text-xs);
      }
    }

    /* ==========================================
       CARD CONTENT STYLES
       ========================================== */

    .card-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-xs);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .card-label .icon {
      width: 20px;
      height: 20px;
      fill: var(--terracotta);
    }

    .card-title {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
      margin-bottom: var(--space-sm);
    }

    /* Hero Card Styles */
    .hero-content {
      position: relative;
      z-index: 1;
    }

    .payment-type-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      padding: 4px;
      gap: 4px;
      margin-bottom: var(--space-lg);
    }

    .payment-type-option {
      flex: 1;
      position: relative;
    }

    .payment-type-option input[type="radio"] {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .payment-type-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-sm) var(--space-xs);
      min-height: 64px;
      background: transparent;
      border: 2px solid transparent;
      border-radius: calc(var(--radius-md) - 4px);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .payment-type-option label:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .payment-type-option input[type="radio"]:focus + label {
      box-shadow: 0 0 0 4px rgba(240, 200, 100, 0.3);
    }

    .payment-type-option input[type="radio"]:checked + label {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--gold-light);
    }

    .payment-type-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 2px;
    }

    .payment-type-desc {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.3;
      white-space: nowrap;
    }

    .payment-type-option input[type="radio"]:checked + label .payment-type-name {
      color: var(--gold-light);
    }

    .payment-type-option input[type="radio"]:checked + label .payment-type-desc {
      color: rgba(255, 255, 255, 0.8);
    }

    @media (max-width: 1000px) {
      .payment-type-toggle {
        flex-direction: column;
        gap: 4px;
        padding: 4px;
      }

      .payment-type-option label {
        min-height: 44px;
      }

      .payment-type-name {
        font-size: var(--text-sm);
      }

      .payment-type-desc {
        display: none;
      }
    }

    /* 1200-1440px */
    @media (max-width: 1440px) and (min-width: 1201px) {
      .payment-type-name {
        font-size: 0.95rem;
      }
    }

    /* 1100-1200px */
    @media (max-width: 1200px) and (min-width: 1100px) {
      .payment-type-name {
        font-size: 0.85rem;
      }
    }

    /* Payment Highlight */
    .payment-highlight {
      text-align: center;
      padding: var(--space-lg);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      overflow: hidden;
    }


    .result-title {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-sm);
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-sm);
    }

    .result-value {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-2xl);
      font-weight: 700;
      color: white;
      margin-bottom: var(--space-xs);
      line-height: 1.1;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
    }

    .result-value .currency {
      font-size: 0.6em;
      color: white;
    }

    .result-period {
      font-size: var(--text-sm);
      color: rgba(255, 255, 255, 0.7);
    }

    .result-range {
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      transition: grid-template-rows 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
      margin-top: 0;
    }

    .result-range.visible {
      grid-template-rows: 1fr;
      opacity: 1;
      margin-top: var(--space-xs);
    }

    .result-range-inner {
      overflow: hidden;
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.6);
    }

    /* Optimal Payment */
    .optimal-payment {
      margin-top: var(--space-md);
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      transition: grid-template-rows 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
    }

    .optimal-payment.visible {
      grid-template-rows: 1fr;
      opacity: 1;
    }

    .optimal-payment:not(.visible) {
      margin-top: 0;
    }

    .optimal-payment-inner {
      overflow: hidden;
      padding: 0;
      background: linear-gradient(135deg, rgba(212, 160, 60, 0.2) 0%, rgba(240, 200, 100, 0.1) 100%);
      border: 2px solid var(--gold);
      border-radius: var(--radius-lg);
      transition: padding 0.3s ease;
    }

    .optimal-payment.visible .optimal-payment-inner {
      padding: var(--space-md);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .optimal-payment-header {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      margin-bottom: var(--space-sm);
    }

    .optimal-payment-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--gold);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .optimal-payment-badge svg {
      width: 12px;
      height: 12px;
      fill: white;
    }

    .optimal-payment-main {
      display: flex;
      align-items: last baseline;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }

    .optimal-payment-main:has(.optimal-payment-label.multiline) {
      align-items: center;
    }

    .optimal-payment-value {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--gold-light);
      line-height: 1;
      white-space: nowrap;
    }

    .optimal-payment-value .currency {
      font-size: 0.6em;
      color: inherit;
    }

    .optimal-payment-label {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.7);
    }

    .optimal-payment-savings {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-top: var(--space-md);
      margin-top: var(--space-sm);
      border-top: 1px solid rgba(212, 160, 60, 0.25);
    }

    .optimal-saving-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.15);
      border-radius: var(--radius-sm);
      text-align: center;
      flex: 1 1 auto;
      min-width: 0;
    }

    .optimal-saving-label {
      font-size: 9px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .optimal-saving-value {
      font-family: system-ui, -apple-system, sans-serif;
      font-size: var(--text-sm);
      font-weight: 600;
      color: #4ade80;
      white-space: nowrap;
      line-height: 1.2;
    }

    .optimal-saving-value.negative {
      color: rgba(255, 255, 255, 0.85);
    }

    /* Tooltip for optimal saving item */
    .optimal-saving-item.has-tooltip {
      position: relative;
      cursor: help;
    }

    .optimal-saving-item.has-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      background: var(--charcoal);
      color: white;
      font-size: 12px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      pointer-events: none;
    }

    .optimal-saving-item.has-tooltip::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--charcoal);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s;
      z-index: 100;
    }

    .optimal-saving-item.has-tooltip:hover::after,
    .optimal-saving-item.has-tooltip:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) scale(1);
    }

    .optimal-saving-item.has-tooltip:hover::before {
      transform: translateX(-50%);
    }

    /* Hero Breakdown */
    .hero-breakdown {
      display: flex;
      justify-content: space-between;
      gap: var(--space-md);
      margin-top: var(--space-lg);
      padding-top: var(--space-md);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .breakdown-item {
      text-align: center;
      flex: 1;
    }

    .breakdown-label {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 4px;
      white-space: nowrap;
    }

    .breakdown-value {
      font-size: var(--text-sm);
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }

    .breakdown-item.highlight .breakdown-value {
      color: var(--gold-light);
    }

    @media (max-width: 600px) {
      .hero-breakdown {
        flex-direction: column;
        gap: var(--space-xs);
      }

      .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
        padding: var(--space-xs) 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .breakdown-item:last-child {
        border-bottom: none;
      }

      .breakdown-label {
        margin-bottom: 0;
      }

      .breakdown-value {
        font-size: var(--text-md);
      }
    }

    /* Input Fields */
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-field {
      width: 100%;
      font-family: inherit;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--charcoal);
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      padding-right: 80px;
      transition: all 0.25s ease;
      outline: none;
    }

    .input-field:hover {
      background: var(--cream-dark);
    }

    .input-field:focus {
      background: white;
      border-color: var(--terracotta);
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .input-field::placeholder {
      color: var(--warm-gray);
      font-weight: 400;
    }

    /* Apple-style wheel picker */
    .date-wheel-picker {
      display: flex;
      justify-content: center;
      gap: 2px;
      height: 180px;
      width: 100%;
      background: var(--cream);
      border-radius: var(--radius-lg);
      overflow: hidden;
      position: relative;
    }

    .date-wheel-picker::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: linear-gradient(to bottom,
        var(--cream) 0%,
        rgba(250, 245, 235, 0.75) 30%,
        rgba(250, 245, 235, 0.4) 60%,
        transparent 100%);
      pointer-events: none;
      z-index: 2;
    }

    .date-wheel-picker::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 65px;
      background: linear-gradient(to top,
        var(--cream) 0%,
        rgba(250, 245, 235, 0.75) 30%,
        rgba(250, 245, 235, 0.4) 60%,
        transparent 100%);
      pointer-events: none;
      z-index: 2;
    }

    .wheel-highlight {
      position: absolute;
      top: 50%;
      left: 4px;
      right: 2px;
      height: 36px;
      transform: translateY(-50%);
      background: rgba(198, 93, 59, 0.1);
      border-radius: var(--radius-md);
      pointer-events: none;
      z-index: 1;
    }

    .wheel-column {
      flex: 1;
      overflow: hidden;
      position: relative;
      touch-action: none;
      outline: none;
    }

    .wheel-column:focus-visible {
      box-shadow: inset 0 0 0 2px var(--terracotta);
      border-radius: var(--radius-sm);
    }

    .wheel-spacer {
      height: 72px;
      flex-shrink: 0;
    }

    .wheel-column::-webkit-scrollbar {
      display: none;
    }

    .wheel-items-container {
      transform: translateY(0);
      will-change: transform;
    }

    /* Day column */
    #day-wheel {
      flex: 0 0 50px;
    }

    /* Month column */
    #month-wheel {
      flex: 0 0 110px;
    }

    /* Year column */
    #year-wheel {
      flex: 0 0 65px;
    }

    .wheel-item {
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-base);
      font-weight: 400;
      color: #8B8278;
      cursor: pointer;
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }

    .wheel-item.selected {
      color: var(--charcoal);
      font-weight: 700;
      transform: scale(1);
    }

    .wheel-item.near-1 {
      transform: scale(0.92);
    }

    .wheel-item.near-2 {
      transform: scale(0.85);
    }

    .wheel-item:hover:not(.selected) {
      color: var(--warm-gray);
    }

    /* Force grabbing cursor during wheel drag */
    body.wheel-dragging,
    body.wheel-dragging * {
      cursor: grabbing !important;
    }

    .input-suffix {
      position: absolute;
      right: var(--space-md);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--warm-gray);
      pointer-events: none;
    }

    /* Range Slider */
    .range-wrapper {
      margin-top: var(--space-sm);
    }

    .range-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      background: var(--cream-dark);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: var(--shadow-soft);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .range-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-medium);
    }

    .range-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: var(--shadow-soft);
    }

    .range-labels {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-xs);
      font-size: var(--text-xs);
      color: var(--warm-gray);
    }

    /* Term Selector Pills */
    .term-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-xs);
    }

    @media (max-width: 768px) {
      .term-selector {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .term-option {
      position: relative;
    }

    .term-option input[type="radio"] {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .term-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-sm);
      min-height: 48px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .term-value {
      font-size: var(--text-base);
      line-height: 1.2;
    }

    .term-unit {
      font-size: var(--text-xs);
      font-weight: 500;
      opacity: 0.8;
    }

    .term-option label:hover {
      background: var(--cream-dark);
    }

    .term-option input[type="radio"]:focus + label {
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .term-option input[type="radio"]:checked + label {
      background: var(--terracotta);
      color: white;
      border-color: var(--terracotta);
    }

    .term-custom-wrapper {
      grid-column: span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm);
      min-height: 48px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      transition: all 0.25s ease;
      cursor: pointer;
    }

    .term-custom-wrapper:focus-within {
      background: white;
      border-color: var(--terracotta);
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .term-custom-wrapper.active {
      background: var(--terracotta);
      border-color: var(--terracotta);
    }

    .term-custom-input {
      width: 50px;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      background: transparent;
      border: none;
      outline: none;
      text-align: center;
    }

    .term-custom-wrapper.active .term-custom-input {
      color: white;
    }

    .term-custom-wrapper.active .term-custom-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Term unit dropdown (desktop) */
    .term-unit-dropdown {
      position: relative;
      display: none;
    }

    @media (hover: hover) {
      .term-unit-dropdown {
        display: block;
      }
      .term-unit-select {
        display: none;
      }
    }

    .term-unit-trigger {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 0;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--warm-gray);
      background: transparent;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      transition: color 0.15s ease;
    }

    .term-unit-trigger:hover {
      color: var(--charcoal);
    }

    .term-custom-wrapper.active .term-unit-trigger {
      color: rgba(255, 255, 255, 0.9);
    }

    .term-custom-wrapper.active .term-unit-trigger:hover {
      color: white;
    }

    .term-unit-arrow {
      width: 16px;
      height: 16px;
      transition: transform 0.15s ease;
      flex-shrink: 0;
    }

    .term-unit-dropdown.open .term-unit-arrow {
      transform: rotate(180deg);
    }

    .term-unit-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      margin-left: -50px;
      width: 100px;
      padding: 4px;
      margin-top: 0;
      list-style: none;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
      z-index: 100;
    }

    .term-unit-dropdown.open .term-unit-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .term-unit-option {
      padding: 8px 12px;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--charcoal);
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.1s ease;
    }

    .term-unit-option:hover {
      background: var(--cream);
    }

    .term-unit-option.selected {
      color: var(--terracotta);
    }

    /* Term unit select (mobile) */
    .term-unit-select {
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--warm-gray);
      background: transparent;
      border: none;
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      padding-right: 12px;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='%237a7067' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      background-size: 10px;
    }

    .term-custom-wrapper.active .term-unit-select {
      color: rgba(255, 255, 255, 0.9);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 5l3 3 3-3' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    }

    @media (max-width: 768px) {
      .term-custom-wrapper {
        grid-column: span 3;
      }
    }

    /* Pie Chart */
    .pie-chart-wrapper {
      position: relative;
      width: 240px;
      height: 240px;
    }

    .pie-chart {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      filter: drop-shadow(0 4px 16px rgba(0, 0, 0, 0.1));
    }

    .pie-ring {
      fill: none;
      stroke-width: 18;
      pointer-events: none;
      transition: stroke-dasharray 0.6s ease-out, filter 0.15s ease;
    }

    .pie-ring-interest {
      stroke: var(--terracotta);
    }

    .pie-ring-principal {
      stroke: var(--forest);
    }

    .pie-ring-savings {
      stroke: var(--gold);
      stroke-dasharray: 0 251.33;
      opacity: 0;
      transition: stroke-dasharray 0.6s ease-out, opacity 0.3s ease, filter 0.15s ease;
    }

    .pie-chart {
      cursor: pointer;
    }

    .pie-tooltip {
      position: fixed;
      background: var(--charcoal);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 1000;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translate(-50%, -100%);
    }

    .pie-tooltip.visible {
      opacity: 1;
    }

    .pie-tooltip-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .pie-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: var(--space-md);
    }

    .pie-tooltip-label {
      opacity: 0.7;
    }

    .pie-tooltip-value {
      font-weight: 600;
    }

    .pie-tooltip-value.principal {
      color: var(--forest-light);
    }

    .pie-tooltip-value.interest {
      color: var(--terracotta-light);
    }

    .pie-tooltip-value.savings {
      color: var(--gold-light);
    }

    .pie-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }

    .pie-percent-principal {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--terracotta);
      line-height: 1;
    }

    .pie-percent-label {
      font-size: 11px;
      color: var(--warm-gray);
      margin-top: 4px;
    }

    .pie-legend {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      margin-top: var(--space-lg);
      width: 100%;
    }

    .legend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--text-sm);
    }

    .legend-label {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--charcoal);
      font-weight: 500;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .legend-dot.principal {
      background: var(--forest);
    }

    .legend-dot.interest {
      background: var(--terracotta);
    }

    .legend-dot.savings {
      background: var(--gold);
    }

    .legend-row.savings-row {
      display: flex;
    }

    .legend-value {
      font-weight: 600;
      font-size: var(--text-base);
      color: var(--charcoal);
    }

    /* Stats Card */
    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-label {
      font-size: 11px;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: var(--text-base);
      font-weight: 700;
      color: var(--charcoal);
    }

    .stat-value.highlight {
      color: var(--terracotta);
    }

    /* Action Buttons */
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: var(--space-sm) var(--space-md);
      background: var(--cream);
      color: var(--forest);
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .action-btn:hover {
      background: var(--cream-dark);
      transform: translateY(-2px);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Share wrapper */
    .share-wrapper {
      position: relative;
    }

    .share-dropdown {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      padding: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, visibility 0.15s ease, transform 0.15s ease;
      z-index: 1000;
    }

    .share-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      color: var(--charcoal);
      cursor: pointer;
      transition: background 0.15s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .share-option:hover {
      background: var(--cream);
    }

    .share-option svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .share-option.copy svg { fill: var(--warm-gray); }
    .share-option.telegram svg { fill: #0088cc; }
    .share-option.whatsapp svg { fill: #25D366; }
    .share-option.vk svg { fill: #0077FF; }

    /* Early Repayment Section */
    .early-repayment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--cream);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }

    .early-repayment-header:hover {
      background: var(--cream-dark);
    }

    .early-repayment-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
    }

    .early-repayment-title svg {
      width: 22px;
      height: 22px;
      fill: var(--forest);
    }

    .early-repayment-toggle {
      display: none;
    }

    .early-repayment-content {
      display: block;
      padding: var(--space-md);
    }

    .early-repayments-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .early-repayments-empty {
      padding: var(--space-md);
      text-align: center;
      color: var(--warm-gray);
      font-size: var(--text-xs);
      background: var(--cream);
      border-radius: var(--radius-sm);
    }

    .add-repayment-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: var(--cream);
      color: var(--forest);
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 600;
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-repayment-btn:hover {
      background: var(--cream-dark);
      border-color: var(--forest);
    }

    .add-repayment-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Early repayment item */
    .early-repayment-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background: var(--cream);
      border-radius: var(--radius-sm);
      align-items: center;
    }

    @media (max-width: 700px) {
      .early-repayment-item {
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xs);
      }

      .early-repayment-item > *:last-child {
        grid-column: span 2;
        justify-self: end;
      }
    }

    @media (min-width: 701px) {
      .early-repayment-item {
        grid-template-columns: minmax(100px, 1fr) minmax(100px, 1fr) minmax(120px, 1fr) minmax(160px, 1.2fr) auto;
      }
    }

    .early-repayment-item-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .early-repayment-item-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .early-repayment-item-input {
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
    }

    .early-repayment-item-input:focus {
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(198, 93, 59, 0.1);
    }

    .early-repayment-item-select {
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease;
      width: 100%;
    }

    .early-repayment-item-select:focus {
      border-color: var(--forest);
    }

    /* Frequency toggle (one-time / monthly) - terracotta accent, compact */
    .repayment-frequency-toggle {
      display: flex;
      background: #EDE6DE;
      padding: 3px;
      border-radius: 8px;
      position: relative;
      box-shadow:
        inset 0 1px 2px rgba(0, 0, 0, 0.06),
        0 1px 1px rgba(255, 255, 255, 0.8);
    }

    .repayment-frequency-toggle::before {
      content: '';
      position: absolute;
      top: 3px;
      bottom: 3px;
      left: 3px;
      width: calc(50% - 3px);
      background: var(--terracotta-light);
      border-radius: 6px;
      transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1), width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      box-shadow:
        0 2px 6px rgba(198, 93, 59, 0.3),
        0 1px 2px rgba(198, 93, 59, 0.15);
    }

    .repayment-frequency-toggle.monthly::before {
      left: 50%;
      width: calc(50% - 3px);
    }

    .repayment-frequency-btn {
      flex: 1 1 0;
      min-width: 0;
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      color: var(--warm-gray);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.25s ease, transform 0.15s ease;
      white-space: nowrap;
      position: relative;
      z-index: 1;
      text-align: center;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .repayment-frequency-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .repayment-frequency-btn:hover:not(.active) {
      color: var(--charcoal);
    }

    .repayment-frequency-btn:active {
      transform: scale(0.97);
    }

    .repayment-frequency-btn.active {
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }

    .repayment-frequency-btn.active svg {
      fill: white;
    }

    /* Amount type toggle (extra/total) - compact inline style */
    .repayment-amount-type-toggle {
      display: flex;
      background: transparent;
      padding: 0;
      border-radius: 0;
      position: relative;
      box-shadow: none;
      gap: 6px;
    }

    .repayment-amount-type-toggle::before {
      display: none;
    }

    .repayment-amount-type-btn {
      flex: 0 0 auto;
      padding: 4px 10px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
      color: var(--warm-gray);
      background: var(--cream-dark);
      border: 1.5px solid transparent;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      position: relative;
      z-index: 1;
      text-align: center;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .repayment-amount-type-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .repayment-amount-type-btn:hover:not(.active) {
      color: var(--charcoal);
      background: #EDE6DE;
    }

    .repayment-amount-type-btn:active {
      transform: scale(0.97);
    }

    .repayment-amount-type-btn.active {
      color: var(--forest);
      background: rgba(45, 74, 62, 0.1);
      border-color: var(--forest);
    }

    /* Effect toggle (reduce-term/reduce-payment) - gold accent, compact */
    .repayment-effect-toggle {
      display: flex;
      background: #EDE6DE;
      padding: 3px;
      border-radius: 8px;
      position: relative;
      box-shadow:
        inset 0 1px 2px rgba(0, 0, 0, 0.06),
        0 1px 1px rgba(255, 255, 255, 0.8);
    }

    .repayment-effect-toggle::before {
      content: '';
      position: absolute;
      top: 3px;
      bottom: 3px;
      left: 3px;
      width: calc(50% - 3px);
      background: var(--gold-light);
      border-radius: 6px;
      transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1), width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      box-shadow:
        0 2px 6px rgba(212, 160, 60, 0.35),
        0 1px 2px rgba(212, 160, 60, 0.2);
    }

    .repayment-effect-toggle.reduce-payment::before {
      left: 50%;
      width: calc(50% - 3px);
    }

    .repayment-effect-btn {
      flex: 1 1 0;
      min-width: 0;
      padding: 6px 16px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      color: var(--warm-gray);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.25s ease, transform 0.15s ease;
      white-space: nowrap;
      position: relative;
      z-index: 1;
      text-align: center;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .repayment-effect-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .repayment-effect-btn:hover:not(.active) {
      color: var(--charcoal);
    }

    .repayment-effect-btn:active {
      transform: scale(0.97);
    }

    .repayment-effect-btn.active {
      color: var(--charcoal);
      text-shadow: none;
    }

    .repayment-effect-btn.active svg {
      fill: var(--charcoal);
    }

    .early-repayment-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--warm-gray);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
      align-self: end;
      margin-bottom: 4px;
    }

    .early-repayment-remove:hover {
      background: rgba(198, 93, 59, 0.1);
      color: var(--terracotta);
    }

    .early-repayment-remove svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .early-repayment-summary {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      border-radius: var(--radius-md);
      color: white;
    }

    .early-repayment-summary-title {
      font-size: var(--text-xs);
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .early-repayment-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }

    .early-repayment-summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .early-repayment-summary-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
    }

    .early-repayment-summary-value {
      font-size: var(--text-sm);
      font-weight: 600;
      color: white;
    }

    .early-repayment-summary-value.positive {
      color: var(--gold-light);
    }

    /* Chart Card */
    .chart-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: var(--space-md);
    }

    .chart-container {
      position: relative;
      height: 240px;
      width: 100%;
    }

    .chart-svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .chart-axis-label-y {
      font-size: 11px;
      fill: var(--warm-gray);
      text-anchor: end;
    }

    .chart-year-label {
      font-size: 11px;
      fill: var(--warm-gray);
      text-anchor: middle;
    }

    .chart-grid-line {
      stroke: var(--cream-dark);
      stroke-width: 1;
    }

    .chart-bar-group {
      transform-box: fill-box;
      transform-origin: center bottom;
    }

    .chart-bar-group rect {
      transition: x 0.3s ease-out, y 0.4s ease-out, height 0.4s ease-out, opacity 0.3s ease, width 0.3s ease-out;
    }

    .chart-bar-group.entering rect {
      transition: none;
    }

    @keyframes barEnter {
      from {
        transform: scaleY(0);
        opacity: 0;
      }
      to {
        transform: scaleY(1);
        opacity: 1;
      }
    }

    .chart-bar-group.animate-enter {
      /* Set initial state to prevent flash before animation starts */
      transform: scaleY(0);
      opacity: 0;
      transform-origin: center bottom;
      transform-box: fill-box;
      animation: barEnter 0.4s ease-out forwards;
    }

    .chart-area-principal {
      fill: var(--forest);
    }

    .chart-area-interest {
      fill: var(--terracotta);
    }

    .chart-area-extra {
      fill: var(--gold);
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-lg);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid var(--cream-dark);
      justify-content: center;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-sm);
      color: var(--charcoal);
    }

    .chart-legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .chart-legend-dot.principal {
      background: var(--forest);
    }

    .chart-legend-dot.interest {
      background: var(--terracotta);
    }

    .chart-legend-dot.extra {
      background: var(--gold);
    }

    .chart-tooltip {
      position: fixed;
      background: var(--charcoal);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 10000;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .chart-tooltip.visible {
      opacity: 1;
    }

    .chart-tooltip-value.principal {
      color: var(--forest-light);
    }

    .chart-tooltip-value.interest {
      color: var(--terracotta-light);
    }

    .chart-tooltip-value.extra {
      color: var(--gold);
    }

    /* Chart Period Dropdown */
    .chart-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .chart-period-dropdown {
      position: relative;
      display: inline-flex;
    }

    .chart-period-trigger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: color 0.15s ease;
    }

    .chart-period-trigger:hover {
      color: var(--forest);
    }

    .chart-period-trigger-icon {
      width: 16px;
      height: 16px;
      color: var(--warm-gray);
      transition: transform 0.2s ease, color 0.15s ease;
    }

    .chart-period-trigger:hover .chart-period-trigger-icon {
      color: var(--forest);
    }

    .chart-period-dropdown.open .chart-period-trigger-icon {
      transform: rotate(180deg);
    }

    .chart-period-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 180px;
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
    }

    .chart-period-dropdown.open .chart-period-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .chart-period-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      font-size: 14px;
      color: var(--charcoal);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .chart-period-option:hover {
      background: var(--cream);
    }

    .chart-period-option.selected {
      background: rgba(45, 74, 62, 0.06);
      font-weight: 500;
    }

    .chart-period-option-check {
      width: 16px;
      height: 16px;
      color: var(--forest);
      opacity: 0;
    }

    .chart-period-option.selected .chart-period-option-check {
      opacity: 1;
    }

    .chart-period-divider {
      height: 1px;
      background: var(--cream-dark);
      margin: 4px 0;
    }

    .chart-period-section-label {
      padding: 8px 14px 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Schedule Table */
    .schedule-table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--cream);
      border-bottom: 1px solid var(--cream-dark);
    }

    .schedule-table-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
    }

    .schedule-view-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: white;
      padding: 4px;
      border-radius: var(--radius-md);
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .schedule-view-toggle::before {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: var(--terracotta);
      border-radius: calc(var(--radius-md) - 4px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      transform: translateX(0);
    }

    .schedule-view-toggle.monthly-view::before {
      transform: translateX(100%);
    }

    .view-toggle-btn {
      padding: var(--space-xs) var(--space-md);
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      background: transparent;
      border: none;
      border-radius: calc(var(--radius-md) - 4px);
      color: var(--warm-gray);
      cursor: pointer;
      transition: color 0.2s ease;
      position: relative;
      z-index: 1;
      text-align: center;
      display: block;
      width: 100%;
    }

    .view-toggle-btn:hover:not(.active) {
      color: var(--charcoal);
    }

    .view-toggle-btn.active {
      color: white;
    }

    @media (max-width: 768px) {
      .schedule-table-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
      }

      .schedule-table-title {
        text-align: center;
      }

      .schedule-view-toggle {
        width: 100%;
      }
    }

    .schedule-table-container {
      overflow: auto;
    }

    .schedule-table {
      width: 100%;
      min-width: 500px;
      border-collapse: collapse;
      font-size: var(--text-xs);
    }

    .schedule-table th,
    .schedule-table td {
      white-space: nowrap;
    }

    .schedule-table th {
      position: sticky;
      top: 0;
      background: var(--cream);
      padding: var(--space-sm);
      text-align: right;
      font-weight: 600;
      color: var(--charcoal);
      border-bottom: 1px solid var(--cream-dark);
    }

    .schedule-table th:first-child {
      text-align: left;
    }

    .schedule-table td {
      padding: var(--space-sm);
      text-align: right;
      color: var(--charcoal);
      border-bottom: 1px solid var(--cream);
    }

    .schedule-table td:first-child {
      text-align: left;
      color: var(--warm-gray);
    }

    .schedule-table tr:hover td {
      background: var(--cream);
    }

    .schedule-table .principal-cell {
      color: var(--forest);
      font-weight: 500;
    }

    .schedule-table .interest-cell {
      color: var(--terracotta);
    }

    .schedule-table .balance-cell {
      color: var(--forest);
      font-weight: 600;
    }

    .schedule-table-resize-handle {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 24px;
      cursor: ns-resize;
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      transition: background 0.15s ease;
    }

    .schedule-table-resize-handle:hover {
      background: var(--cream-dark);
    }

    .resize-handle-bar {
      width: 40px;
      height: 4px;
      background: rgba(107, 101, 96, 0.3);
      border-radius: 2px;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .schedule-table-resize-handle:hover .resize-handle-bar,
    .schedule-table-resize-handle.dragging .resize-handle-bar {
      background: rgba(107, 101, 96, 0.5);
      transform: scaleX(1.2);
    }

    @media (max-width: 1024px) {
      .schedule-table-resize-handle {
        display: none;
      }
    }

    /* Footer */
    footer {
      padding: 0 var(--space-lg);
      padding-bottom: 35px;
      text-align: center;
      color: var(--warm-gray);
      font-size: var(--text-xs);
    }

    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
    }

    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--terracotta);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .footer-link:hover {
      color: var(--terracotta-dark);
    }

    .footer-link svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Watermark */
    .watermark {
      display: none;
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    :focus-visible {
      outline: 3px solid var(--terracotta);
      outline-offset: 2px;
    }

    @media (prefers-contrast: high) {
      .input-field {
        border: 2px solid var(--charcoal);
      }
      .term-option label {
        border: 2px solid var(--charcoal);
      }
    }
  </style>
</head>
<body>
  <a href="#calculator" class="skip-link">Перейти к&nbsp;калькулятору</a>

  <header>
    <a href="#" class="logo">
      <span class="logo-icon">
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none">
          <path d="M4 12L12 5L20 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M6 11V18C6 18.5 6.5 19 7 19H17C17.5 19 18 18.5 18 18V11" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 17L11 14L13 15.5L15 12" stroke="#F0C864" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="15" cy="12" r="1" fill="#F0C864"/>
        </svg>
      </span>
      <span class="logo-text">
        <span class="logo-title">Честный ипотечный калькулятор</span>
      </span>
    </a>
    <a href="https://cbr.ru/hd_base/KeyRate/" target="_blank" rel="noopener noreferrer" class="key-rate" title="Проверить актуальную ставку на&nbsp;сайте ЦБ&nbsp;РФ">
      <span class="key-rate-label">Узнать ключевую ставку</span>
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
      </svg>
    </a>
  </header>

  <main id="calculator">
    <div class="calculator-intro">
      <p class="calculator-intro-text">Введите параметры ипотеки&nbsp;— калькулятор рассчитает платежи и&nbsp;подскажет, как сэкономить на&nbsp;переплате</p>
    </div>
    <div class="bento-grid">

      <!-- Property Price -->
      <article class="bento-card bento-price" role="region" aria-label="Стоимость недвижимости">
        <label class="card-label" for="property-price">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
          </svg>
          Стоимость недвижимости
        </label>
        <div class="input-wrapper">
          <input
            type="text"
            id="property-price"
            class="input-field"
            inputmode="numeric"
            value="5 000 000"
            aria-describedby="price-hint"
          >
          <span class="input-suffix">₽</span>
        </div>
        <div class="range-wrapper">
          <input
            type="range"
            id="property-price-range"
            class="range-slider"
            min="500000"
            max="100000000"
            step="100000"
            value="5000000"
            aria-label="Стоимость недвижимости"
          >
          <div class="range-labels">
            <span>500 тыс.</span>
            <span>100 млн.</span>
          </div>
        </div>
      </article>

      <!-- Hero: Monthly Payment Result -->
      <article class="bento-card bento-hero" role="region" aria-label="Результат расчёта">
        <div class="hero-content">
          <!-- Payment Type Toggle -->
          <div class="payment-type-toggle" role="radiogroup" aria-label="Выберите тип платежа">
            <div class="payment-type-option">
              <input type="radio" name="payment-type" id="payment-annuity" value="annuity" checked>
              <label for="payment-annuity">
                <span class="payment-type-name">Аннуитетный</span>
                <span class="payment-type-desc">равные платежи</span>
              </label>
            </div>
            <div class="payment-type-option">
              <input type="radio" name="payment-type" id="payment-differentiated" value="differentiated">
              <label for="payment-differentiated">
                <span class="payment-type-name">Дифференцированный</span>
                <span class="payment-type-desc">убывающие платежи</span>
              </label>
            </div>
          </div>

          <div class="payment-highlight">
            <p class="result-title">Ежемесячный платёж</p>
            <p class="result-value" id="monthly-payment">
              <span id="payment-amount">65 394</span>
              <span class="currency">₽</span>
            </p>
            <p class="result-period" id="payment-type-label">Аннуитетный платёж</p>
            <div class="result-range" id="payment-range">
              <p class="result-range-inner" id="payment-range-inner"></p>
            </div>
          </div>

          <!-- Optimal payment suggestion for terms > 15 years -->
          <div class="optimal-payment" id="optimal-payment">
            <div class="optimal-payment-inner">
              <div class="optimal-payment-main">
                <div class="optimal-payment-value">
                  <span id="optimal-payment-amount">0</span>
                  <span class="currency">₽</span>
                </div>
                <span class="optimal-payment-label" id="optimal-payment-label">для закрытия за&nbsp;15&nbsp;лет</span>
              </div>
              <div class="optimal-payment-savings">
                <div class="optimal-saving-item">
                  <span class="optimal-saving-label">Экономия</span>
                  <span class="optimal-saving-value" id="optimal-savings">0 ₽</span>
                </div>
                <div class="optimal-saving-item has-tooltip" id="optimal-vs-annuity-item" style="display: none;" data-tooltip="Экономия диф. на&nbsp;15&nbsp;лет vs&nbsp;аннуитет на&nbsp;текущий срок">
                  <span class="optimal-saving-label">vs аннуитет</span>
                  <span class="optimal-saving-value" id="optimal-vs-annuity">0 ₽</span>
                </div>
                <div class="optimal-saving-item">
                  <span class="optimal-saving-label">Быстрее на</span>
                  <span class="optimal-saving-value" id="optimal-years">0 лет</span>
                </div>
                <div class="optimal-saving-item">
                  <span class="optimal-saving-label">Доплата/мес</span>
                  <span class="optimal-saving-value negative" id="optimal-extra">+0 ₽</span>
                </div>
              </div>
            </div>
          </div>

          <div class="hero-breakdown">
            <div class="breakdown-item">
              <span class="breakdown-label">Сумма кредита</span>
              <span class="breakdown-value" id="loan-amount">4 000 000 ₽</span>
            </div>
            <div class="breakdown-item">
              <span class="breakdown-label">Общие выплаты</span>
              <span class="breakdown-value" id="total-payment">15 694 560 ₽</span>
            </div>
            <div class="breakdown-item highlight">
              <span class="breakdown-label">Переплата</span>
              <span class="breakdown-value" id="total-interest">11 694 560 ₽</span>
            </div>
          </div>

          <!-- Actions moved inside hero -->
          <div class="hero-actions">
            <button type="button" class="action-btn" id="download-btn" aria-label="Скачать расчёт">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
              Скачать
            </button>
            <div class="share-wrapper">
              <button type="button" class="action-btn" id="share-btn" aria-label="Поделиться расчётом" aria-expanded="false" aria-haspopup="true" aria-controls="share-dropdown">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                </svg>
                Поделиться
              </button>
              <div class="share-dropdown" id="share-dropdown" role="menu">
                <button type="button" class="share-option copy" id="copy-link-btn" role="menuitem">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                  </svg>
                  <span>Копировать ссылку</span>
                </button>
                <a href="#" class="share-option telegram" id="share-telegram" target="_blank" rel="noopener" role="menuitem">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                  </svg>
                  <span>Telegram</span>
                </a>
                <a href="#" class="share-option whatsapp" id="share-whatsapp" target="_blank" rel="noopener" role="menuitem">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                  </svg>
                  <span>WhatsApp</span>
                </a>
                <a href="#" class="share-option vk" id="share-vk" target="_blank" rel="noopener" role="menuitem">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4.03 8.57 4.03 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.864 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.744c.372 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.813-.542 1.254-1.406 2.151-3.574 2.151-3.574.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/>
                  </svg>
                  <span>ВКонтакте</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Down Payment -->
      <article class="bento-card bento-downpayment" role="region" aria-label="Первоначальный взнос">
        <label class="card-label" for="down-payment">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
          </svg>
          Первоначальный взнос
        </label>
        <div class="input-wrapper">
          <input
            type="text"
            id="down-payment"
            class="input-field"
            inputmode="numeric"
            value="1 000 000"
          >
          <span class="input-suffix">₽</span>
        </div>
        <div class="range-wrapper">
          <input
            type="range"
            id="down-payment-range"
            class="range-slider"
            min="0"
            max="5000000"
            step="50000"
            value="1000000"
            aria-label="Первоначальный взнос"
          >
          <div class="range-labels">
            <span>0%</span>
            <span id="down-payment-percent">20%</span>
          </div>
        </div>
      </article>

      <!-- Interest Rate -->
      <article class="bento-card bento-rate" role="region" aria-label="Процентная ставка">
        <label class="card-label" for="interest-rate">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7.5 11C9.43 11 11 9.43 11 7.5S9.43 4 7.5 4 4 5.57 4 7.5 5.57 11 7.5 11zm0-5C8.33 6 9 6.67 9 7.5S8.33 9 7.5 9 6 8.33 6 7.5 6.67 6 7.5 6zM4.0025 18.5832L18.5858 3.9999l1.4143 1.4142L5.4167 19.9974l-1.4142-1.4142zM16.5 13c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5zm0 5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
          </svg>
          Процентная ставка
        </label>
        <div class="input-wrapper">
          <input
            type="text"
            id="interest-rate"
            class="input-field"
            inputmode="decimal"
            value="18"
          >
          <span class="input-suffix">%</span>
        </div>
        <div class="range-wrapper">
          <input
            type="range"
            id="interest-rate-range"
            class="range-slider"
            min="1"
            max="30"
            step="0.1"
            value="18"
            aria-label="Процентная ставка"
          >
          <div class="range-labels">
            <span>1%</span>
            <span>30%</span>
          </div>
        </div>
      </article>

      <!-- Term Selector -->
      <article class="bento-card bento-term" role="region" aria-label="Срок кредита">
        <div class="card-label">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
          </svg>
          Срок кредита
        </div>
        <div class="term-selector" role="radiogroup" aria-label="Выберите срок кредита">
          <div class="term-option">
            <input type="radio" name="term" id="term-5" value="5">
            <label for="term-5"><span class="term-value">5</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-option">
            <input type="radio" name="term" id="term-10" value="10">
            <label for="term-10"><span class="term-value">10</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-option">
            <input type="radio" name="term" id="term-15" value="15">
            <label for="term-15"><span class="term-value">15</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-option">
            <input type="radio" name="term" id="term-20" value="20" checked>
            <label for="term-20"><span class="term-value">20</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-option">
            <input type="radio" name="term" id="term-25" value="25">
            <label for="term-25"><span class="term-value">25</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-option">
            <input type="radio" name="term" id="term-30" value="30">
            <label for="term-30"><span class="term-value">30</span><span class="term-unit">лет</span></label>
          </div>
          <div class="term-custom-wrapper" id="term-custom-wrapper">
            <input
              type="text"
              class="term-custom-input"
              id="term-custom"
              inputmode="numeric"
              placeholder="—"
              maxlength="3"
              aria-label="Свой срок кредита"
            >
            <!-- Custom dropdown for desktop -->
            <div class="term-unit-dropdown" id="term-unit-dropdown">
              <button type="button" class="term-unit-trigger" id="term-unit-trigger" aria-haspopup="listbox" aria-expanded="false">
                <span id="term-unit-label">лет</span>
                <svg class="term-unit-arrow" viewBox="0 0 12 12" aria-hidden="true">
                  <path d="M3 5l3 3 3-3" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <ul class="term-unit-menu" id="term-unit-menu" role="listbox" aria-label="Единица измерения срока">
                <li role="option" data-value="years" class="term-unit-option selected">лет</li>
                <li role="option" data-value="months" class="term-unit-option">мес</li>
              </ul>
            </div>
            <!-- Native select for mobile -->
            <select class="term-unit-select" id="term-unit-select" aria-label="Единица измерения срока">
              <option value="years" selected>лет</option>
              <option value="months">мес</option>
            </select>
          </div>
        </div>
      </article>

      <!-- Start Date -->
      <article class="bento-card bento-date" role="region" aria-label="Дата взятия ипотеки">
        <label class="card-label">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
          </svg>
          Дата выдачи ипотеки
        </label>
        <div class="date-wheel-picker" role="group" aria-label="Выбор даты">
          <div class="wheel-highlight"></div>
          <div class="wheel-column" id="day-wheel" role="listbox" aria-label="День" tabindex="0">
            <!-- Days populated by JS -->
          </div>
          <div class="wheel-column" id="month-wheel" role="listbox" aria-label="Месяц" tabindex="0">
            <!-- Months populated by JS -->
          </div>
          <div class="wheel-column" id="year-wheel" role="listbox" aria-label="Год" tabindex="0">
            <!-- Years populated by JS -->
          </div>
        </div>
      </article>

      <!-- Pie Chart -->
      <article class="bento-card bento-pie" role="region" aria-label="Структура платежей">
        <h3 class="chart-title">Структура платежей</h3>
        <div class="pie-chart-wrapper">
          <svg class="pie-chart" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="pie-ring pie-ring-interest" id="pie-interest" cx="50" cy="50" r="40"/>
            <circle class="pie-ring pie-ring-savings" id="pie-savings" cx="50" cy="50" r="40"/>
            <circle class="pie-ring pie-ring-principal" id="pie-principal" cx="50" cy="50" r="40"/>
          </svg>
          <div class="pie-center-text">
            <div class="pie-percent-principal" id="pie-percent-display">0%</div>
            <div class="pie-percent-label">переплата</div>
          </div>
        </div>
        <div class="pie-legend">
          <div class="legend-row">
            <span class="legend-label">
              <span class="legend-dot principal"></span>
              Основной долг
            </span>
            <span class="legend-value" id="legend-principal-percent">25.5%</span>
          </div>
          <div class="legend-row">
            <span class="legend-label">
              <span class="legend-dot interest"></span>
              Переплата
            </span>
            <span class="legend-value" id="legend-interest-percent">74.5%</span>
          </div>
          <div class="legend-row savings-row" id="legend-savings-row">
            <span class="legend-label">
              <span class="legend-dot savings"></span>
              Экономия
            </span>
            <span class="legend-value" id="legend-savings-percent">0%</span>
          </div>
        </div>
      </article>

      <!-- Chart -->
      <article class="bento-card bento-chart" id="schedule-chart" role="region" aria-label="График платежей">
        <div class="chart-header">
          <div class="chart-period-dropdown" id="chart-period-dropdown">
            <button type="button" class="chart-period-trigger" id="chart-period-trigger" aria-haspopup="listbox" aria-expanded="false">
              <span id="chart-period-text">Выплаты за все годы</span>
              <svg class="chart-period-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="chart-period-menu" id="chart-period-menu" role="listbox">
              <!-- Options will be populated by JS -->
            </div>
          </div>
        </div>
        <div class="chart-container">
          <svg class="chart-svg" id="schedule-chart-svg" viewBox="0 0 650 240">
            <!-- Chart will be drawn by JS -->
          </svg>
          <div class="early-payment-tooltip" id="early-payment-tooltip"></div>
        </div>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-dot principal"></span>
            Основной долг
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-dot interest"></span>
            Переплата
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-dot extra"></span>
            Досрочные
          </div>
        </div>
      </article>

      <!-- Early Repayment Bento -->
      <article class="bento-card bento-early" id="bento-early" role="region" aria-label="Досрочное погашение">
        <div class="bento-early-header">
          <div class="bento-early-title">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="12" r="10" fill="var(--forest)"/>
              <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
            Досрочное погашение
            <span class="bento-early-badge" id="bento-early-badge">0</span>
          </div>
          <button type="button" class="bento-early-toggle-btn" id="bento-early-add-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Добавить
          </button>
        </div>
        <div class="bento-early-content">
          <div class="bento-early-list-section">
            <div class="bento-early-list" id="bento-early-list">
              <div class="bento-early-empty visible" id="bento-early-empty">
                <div class="bento-early-empty-inner">
                  Добавьте досрочные погашения, чтобы увидеть экономию
                </div>
              </div>
            </div>
          </div>
          <div class="bento-early-summary-section" id="bento-early-summary">
            <div class="bento-early-summary-title">Выгода от&nbsp;досрочных погашений</div>
            <div class="bento-early-summary-grid">
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Новый срок кредита</span>
                <span class="bento-early-summary-value" id="bento-summary-new-term">—</span>
              </div>
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Сокращение срока</span>
                <span class="bento-early-summary-value positive" id="bento-summary-term-saved">—</span>
              </div>
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Новая переплата</span>
                <span class="bento-early-summary-value" id="bento-summary-new-interest">—</span>
              </div>
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Экономия на&nbsp;процентах</span>
                <span class="bento-early-summary-value positive" id="bento-summary-interest-saved">—</span>
              </div>
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Всего выплатите</span>
                <span class="bento-early-summary-value" id="bento-summary-total-payment">—</span>
              </div>
              <div class="bento-early-summary-item">
                <span class="bento-early-summary-label">Дата погашения</span>
                <span class="bento-early-summary-value" id="bento-summary-payoff-date">—</span>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Schedule Table -->
      <article class="bento-card bento-schedule" role="region" aria-label="Таблица платежей">
        <div class="schedule-table-header">
          <h3 class="schedule-table-title">Детализация платежей</h3>
          <div class="schedule-view-toggle">
            <button class="view-toggle-btn active" data-view="yearly" type="button">По&nbsp;годам</button>
            <button class="view-toggle-btn" data-view="monthly" type="button">По&nbsp;месяцам</button>
          </div>
        </div>
        <div class="schedule-table-container" id="schedule-table-container">
          <table class="schedule-table" id="schedule-table">
            <thead>
              <tr>
                <th scope="col">Период</th>
                <th scope="col">Платёж</th>
                <th scope="col">Погашено</th>
                <th scope="col">Переплата</th>
                <th scope="col">Остаток долга</th>
              </tr>
            </thead>
            <tbody id="schedule-table-body">
              <!-- Rows will be generated by JS -->
            </tbody>
          </table>
        </div>
        <div class="schedule-table-resize-handle" id="table-resize-handle">
          <div class="resize-handle-bar"></div>
        </div>
      </article>

      <!-- Tips -->
      <article class="bento-card bento-tip" id="tips">
        <h3>Платите в&nbsp;первые годы</h3>
        <p>Досрочные платежи в&nbsp;первые 3–5&nbsp;лет экономят больше всего&nbsp;— в&nbsp;начале срока большая часть платежа уходит на&nbsp;проценты.</p>
      </article>

      <article class="bento-card bento-tip">
        <h3>Рефинансируйте вовремя</h3>
        <p>Если ставки упали на&nbsp;1,5%+ от&nbsp;вашей&nbsp;— рефинансирование окупится. Но только в&nbsp;первой половине срока кредита.</p>
      </article>

      <article class="bento-card bento-tip">
        <h3>Налоговый вычет</h3>
        <p>Верните до&nbsp;650&nbsp;000&nbsp;₽&nbsp;— 260&nbsp;000&nbsp;₽ за&nbsp;покупку (13% от&nbsp;2&nbsp;млн) и&nbsp;390&nbsp;000&nbsp;₽ за&nbsp;проценты (13% от&nbsp;3&nbsp;млн).</p>
      </article>

      <article class="bento-card bento-tip">
        <h3>Страховка не&nbsp;обязательна</h3>
        <p>Можно отказаться от&nbsp;страхования жизни, но ставка вырастет на&nbsp;0,5–1%. Посчитайте, что выгоднее за&nbsp;весь срок.</p>
      </article>

      <article class="bento-card bento-tip">
        <h3>Платёж до&nbsp;30% дохода</h3>
        <p>Комфортный платёж&nbsp;— не&nbsp;более 30% семейного дохода. Иначе любая непредвиденная ситуация станет проблемой.</p>
      </article>

      <article class="bento-card bento-tip">
        <h3>Аннуитет&nbsp;vs дифференцированный</h3>
        <p>Дифференцированный платёж выгоднее на&nbsp;5–10%, но первые платежи выше. Если планируете досрочно гасить&nbsp;— разница минимальна.</p>
      </article>

    </div>
  </main>

  <!-- Sticky Early Repayment Panel -->
  <aside class="sticky-early-panel" id="sticky-early-panel" role="region" aria-label="Досрочное погашение">
    <div class="sticky-early-header" id="sticky-early-header">
      <div class="sticky-early-title">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Досрочное погашение
        <span class="sticky-early-badge" id="sticky-early-badge">0</span>
      </div>
      <div class="sticky-early-summary-mini" id="sticky-early-summary-mini">
        <!-- Will be populated by JS -->
      </div>
      <button type="button" class="sticky-early-toggle" id="sticky-early-toggle">
        <span>Развернуть</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
      </button>
    </div>
    <div class="sticky-early-content-wrapper">
      <div class="sticky-early-content">
        <div class="sticky-early-content-inner">
          <div class="early-repayments-list" id="early-repayments-list">
            <div class="early-repayments-empty" id="early-repayments-empty">
              Добавьте досрочные погашения, чтобы увидеть экономию
            </div>
          </div>
          <button type="button" class="add-repayment-btn" id="add-repayment-btn">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Добавить платёж
          </button>
          <div class="early-repayment-summary" id="early-repayment-summary">
            <div class="early-repayment-summary-title">Выгода от&nbsp;досрочных погашений</div>
            <div class="early-repayment-summary-grid">
              <div class="early-repayment-summary-item">
                <span class="early-repayment-summary-label">Новый срок кредита</span>
                <span class="early-repayment-summary-value" id="summary-new-term">—</span>
              </div>
              <div class="early-repayment-summary-item">
                <span class="early-repayment-summary-label">Сокращение срока</span>
                <span class="early-repayment-summary-value positive" id="summary-term-saved">—</span>
              </div>
              <div class="early-repayment-summary-item">
                <span class="early-repayment-summary-label">Новая переплата</span>
                <span class="early-repayment-summary-value" id="summary-new-interest">—</span>
              </div>
              <div class="early-repayment-summary-item">
                <span class="early-repayment-summary-label">Экономия на&nbsp;процентах</span>
                <span class="early-repayment-summary-value positive" id="summary-interest-saved">—</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <footer>
    <div class="footer-content">
      <p class="footer-author">Made by Евгений Пятков</p>
      <a href="https://t.me/that_ai_guy" target="_blank" rel="noopener noreferrer" class="footer-link">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
        </svg>
        @that_ai_guy
      </a>
    </div>
  </footer>

  <script>
    // Format number with spaces as thousand separators
    function formatNumber(num) {
      return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Format number for chart axis (shortened)
    function formatChartNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace('.', ',') + ' млн';
      } else if (num >= 1000) {
        return Math.round(num / 1000) + ' тыс';
      }
      return Math.round(num).toString();
    }

    // Pluralize Russian words (год/года/лет)
    function pluralizeYears(n) {
      const abs = Math.abs(n);
      const lastTwo = abs % 100;
      const lastOne = abs % 10;
      if (lastTwo >= 11 && lastTwo <= 19) return 'лет';
      if (lastOne === 1) return 'год';
      if (lastOne >= 2 && lastOne <= 4) return 'года';
      return 'лет';
    }

    // Pluralize Russian words (месяц/месяца/месяцев)
    function pluralizeMonths(n) {
      const abs = Math.abs(n);
      const lastTwo = abs % 100;
      const lastOne = abs % 10;
      if (lastTwo >= 11 && lastTwo <= 19) return 'месяцев';
      if (lastOne === 1) return 'месяц';
      if (lastOne >= 2 && lastOne <= 4) return 'месяца';
      return 'месяцев';
    }

    // Parse formatted number back to integer
    function parseFormattedNumber(str) {
      return parseInt(str.replace(/\s/g, ''), 10) || 0;
    }

    // Calculate monthly payment (annuity formula)
    function calculateAnnuityPayment(principal, annualRate, years) {
      if (principal <= 0 || annualRate <= 0 || years <= 0) return 0;

      const monthlyRate = annualRate / 100 / 12;
      const numberOfPayments = years * 12;

      const monthlyPayment = principal *
        (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) /
        (Math.pow(1 + monthlyRate, numberOfPayments) - 1);

      return monthlyPayment;
    }

    // Calculate differentiated payment
    function calculateDifferentiatedPayment(principal, annualRate, years) {
      if (principal <= 0 || annualRate <= 0 || years <= 0) {
        return { first: 0, last: 0, total: 0, totalInterest: 0 };
      }

      const monthlyRate = annualRate / 100 / 12;
      const numberOfPayments = years * 12;
      const principalPart = principal / numberOfPayments;

      let totalPayment = 0;
      let remainingPrincipal = principal;
      let firstPayment = 0;
      let lastPayment = 0;

      for (let month = 1; month <= numberOfPayments; month++) {
        const interestPart = remainingPrincipal * monthlyRate;
        const monthlyPayment = principalPart + interestPart;

        if (month === 1) firstPayment = monthlyPayment;
        if (month === numberOfPayments) lastPayment = monthlyPayment;

        totalPayment += monthlyPayment;
        remainingPrincipal -= principalPart;
      }

      return {
        first: firstPayment,
        last: lastPayment,
        total: totalPayment,
        totalInterest: totalPayment - principal
      };
    }

    // Calculate differentiated payment for a specific month
    function getDifferentiatedPaymentForMonth(principal, annualRate, years, month) {
      if (principal <= 0 || annualRate <= 0 || years <= 0 || month <= 0) {
        return 0;
      }

      const monthlyRate = annualRate / 100 / 12;
      const numberOfPayments = years * 12;
      const principalPart = principal / numberOfPayments;

      // Calculate remaining principal at the start of the given month
      const paidPrincipal = principalPart * (month - 1);
      const remainingPrincipal = principal - paidPrincipal;

      const interestPart = remainingPrincipal * monthlyRate;
      return principalPart + interestPart;
    }

    // Calculate elapsed months from mortgage issue date to current date
    function getElapsedMonths() {
      const issueDate = new Date(selectedYear, selectedMonth, selectedDay);
      const today = new Date();

      // If issue date is in the future, return 0
      if (issueDate > today) return 0;

      const yearsDiff = today.getFullYear() - issueDate.getFullYear();
      const monthsDiff = today.getMonth() - issueDate.getMonth();
      const daysDiff = today.getDate() - issueDate.getDate();

      let elapsed = yearsDiff * 12 + monthsDiff;
      // If we haven't reached the day of the month yet, subtract one month
      if (daysDiff < 0) elapsed--;

      return Math.max(0, elapsed);
    }

    // Calculate remaining balance after elapsed months for annuity payment
    function getRemainingBalanceAnnuity(principal, annualRate, totalYears, elapsedMonths) {
      if (principal <= 0 || annualRate <= 0 || totalYears <= 0 || elapsedMonths <= 0) {
        return principal;
      }

      const monthlyRate = annualRate / 100 / 12;
      const totalMonths = totalYears * 12;
      const monthlyPayment = calculateAnnuityPayment(principal, annualRate, totalYears);

      let balance = principal;
      for (let i = 0; i < elapsedMonths && balance > 0; i++) {
        const interestPart = balance * monthlyRate;
        const principalPart = monthlyPayment - interestPart;
        balance -= principalPart;
      }

      return Math.max(0, balance);
    }

    // Calculate remaining balance after elapsed months for differentiated payment
    function getRemainingBalanceDifferentiated(principal, annualRate, totalYears, elapsedMonths) {
      if (principal <= 0 || annualRate <= 0 || totalYears <= 0 || elapsedMonths <= 0) {
        return principal;
      }

      const totalMonths = totalYears * 12;
      const principalPart = principal / totalMonths;

      // For differentiated, remaining balance is simply principal minus paid principal parts
      const paidPrincipal = principalPart * elapsedMonths;
      return Math.max(0, principal - paidPrincipal);
    }

    // Calculate full payment schedule with early repayments
    // Returns monthly data array with all payment details
    function calculatePaymentSchedule(loanAmount, interestRate, term, paymentType, repayments) {
      if (loanAmount <= 0 || interestRate <= 0 || term <= 0) return [];

      const monthlyRate = interestRate / 100 / 12;
      const totalMonths = term * 12;
      let remainingBalance = loanAmount;
      const initialMonthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
      let currentMonthlyPayment = initialMonthlyPayment;
      let remainingMonths = totalMonths;

      const schedule = [];

      // Process repayments - group by type and prepare
      // reduce-term: extra goes to principal, monthly payment stays same, term shortens
      // reduce-payment: extra goes to principal, then recalculate monthly payment for remaining term
      const reduceTermPayments = {}; // month -> { extra: amount } for 'extra' amountType
      const reduceTermTotalPayments = []; // { month, totalAmount, frequency } for 'total' amountType
      const reducePaymentExtraPayments = {}; // month -> extra amount
      const reducePaymentTotalPayments = []; // { month, totalAmount, frequency }

      repayments.forEach(rep => {
        const amountType = rep.amountType || 'extra'; // default to 'extra' for backwards compat

        if (rep.type === 'reduce-payment') {
          if (amountType === 'total') {
            reducePaymentTotalPayments.push({
              month: rep.month,
              totalAmount: rep.amount,
              frequency: rep.frequency
            });
          } else {
            // amountType === 'extra'
            if (rep.frequency === 'monthly') {
              for (let m = rep.month; m <= totalMonths; m++) {
                reducePaymentExtraPayments[m] = (reducePaymentExtraPayments[m] || 0) + rep.amount;
              }
            } else {
              reducePaymentExtraPayments[rep.month] = (reducePaymentExtraPayments[rep.month] || 0) + rep.amount;
            }
          }
        } else {
          // reduce-term (default)
          if (amountType === 'total') {
            reduceTermTotalPayments.push({
              month: rep.month,
              totalAmount: rep.amount,
              frequency: rep.frequency
            });
          } else {
            // amountType === 'extra'
            if (rep.frequency === 'monthly') {
              for (let m = rep.month; m <= totalMonths; m++) {
                reduceTermPayments[m] = (reduceTermPayments[m] || 0) + rep.amount;
              }
            } else {
              reduceTermPayments[rep.month] = (reduceTermPayments[rep.month] || 0) + rep.amount;
            }
          }
        }
      });

      // Helper: get total payment target for reduce-term with 'total' amountType
      function getReduceTermTotalTarget(month) {
        let maxTotal = 0;
        reduceTermTotalPayments.forEach(tp => {
          if (tp.frequency === 'monthly' && month >= tp.month) {
            maxTotal = Math.max(maxTotal, tp.totalAmount);
          } else if (tp.frequency === 'once' && month === tp.month) {
            maxTotal = Math.max(maxTotal, tp.totalAmount);
          }
        });
        return maxTotal;
      }

      // Helper: get total payment target for reduce-payment with 'total' amountType
      function getReducePaymentTotalTarget(month) {
        let maxTotal = 0;
        reducePaymentTotalPayments.forEach(tp => {
          if (tp.frequency === 'monthly' && month >= tp.month) {
            maxTotal = Math.max(maxTotal, tp.totalAmount);
          } else if (tp.frequency === 'once' && month === tp.month) {
            maxTotal = Math.max(maxTotal, tp.totalAmount);
          }
        });
        return maxTotal;
      }

      for (let month = 1; month <= totalMonths; month++) {
        if (remainingBalance <= 0.01) break;

        const interestPayment = remainingBalance * monthlyRate;
        let basePrincipal;
        let basePayment;

        if (paymentType === 'differentiated') {
          basePrincipal = loanAmount / totalMonths;
          basePayment = basePrincipal + interestPayment;
        } else {
          basePayment = Math.min(currentMonthlyPayment, remainingBalance + interestPayment);
          basePrincipal = basePayment - interestPayment;
        }

        // Get extra payments for reduce-term
        let reduceTermExtra = reduceTermPayments[month] || 0;
        // Add extra from 'total' amountType (total - basePayment)
        const reduceTermTotalTarget = getReduceTermTotalTarget(month);
        if (reduceTermTotalTarget > 0) {
          reduceTermExtra += Math.max(0, reduceTermTotalTarget - basePayment);
        }

        // Get extra payments for reduce-payment
        let reducePaymentExtra = reducePaymentExtraPayments[month] || 0;
        // Add extra from 'total' amountType
        const reducePaymentTotalTarget = getReducePaymentTotalTarget(month);
        if (reducePaymentTotalTarget > 0) {
          reducePaymentExtra += Math.max(0, reducePaymentTotalTarget - basePayment);
        }

        // Total extra payment this month
        const totalExtra = reduceTermExtra + reducePaymentExtra;

        // Calculate final principal payment
        let principalPayment = basePrincipal + totalExtra;
        principalPayment = Math.min(principalPayment, remainingBalance);

        // Recalculate actual extra after capping principal to remaining balance
        const actualExtra = Math.max(0, principalPayment - basePrincipal);

        const totalPayment = interestPayment + principalPayment;

        schedule.push({
          month,
          payment: totalPayment,
          principal: principalPayment,
          interest: interestPayment,
          extra: actualExtra,
          balance: Math.max(0, remainingBalance - principalPayment),
          basePayment: basePayment
        });

        remainingBalance -= principalPayment;

        // After reduce-payment type extra, recalculate monthly payment for remaining term
        if (reducePaymentExtra > 0 && remainingBalance > 0 && paymentType === 'annuity') {
          remainingMonths = totalMonths - month;
          if (remainingMonths > 0) {
            currentMonthlyPayment = remainingBalance *
              (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) /
              (Math.pow(1 + monthlyRate, remainingMonths) - 1);
          }
        }
      }

      return schedule;
    }

    // Set absolute URL for OG image meta tags
    const ogImageUrl = new URL('og-image.png', window.location.href).href;
    document.getElementById('og-image')?.setAttribute('content', ogImageUrl);
    document.getElementById('twitter-image')?.setAttribute('content', ogImageUrl);

    // DOM elements
    const propertyPriceInput = document.getElementById('property-price');
    const propertyPriceRange = document.getElementById('property-price-range');
    const downPaymentInput = document.getElementById('down-payment');
    const downPaymentRange = document.getElementById('down-payment-range');
    const downPaymentPercent = document.getElementById('down-payment-percent');
    const interestRateInput = document.getElementById('interest-rate');
    const interestRateRange = document.getElementById('interest-rate-range');
    const termRadios = document.querySelectorAll('input[name="term"]');

    // Result elements
    const paymentAmountEl = document.getElementById('payment-amount');
    const loanAmountEl = document.getElementById('loan-amount');
    const totalPaymentEl = document.getElementById('total-payment');
    const totalInterestEl = document.getElementById('total-interest');
    const paymentTypeLabelEl = document.getElementById('payment-type-label');
    const paymentRangeEl = document.getElementById('payment-range');
    const paymentRangeInnerEl = document.getElementById('payment-range-inner');
    const optimalPaymentEl = document.getElementById('optimal-payment');
    const optimalPaymentAmountEl = document.getElementById('optimal-payment-amount');

    // Payment type radios
    const paymentTypeRadios = document.querySelectorAll('input[name="payment-type"]');

    // Pie chart elements
    const piePrincipalEl = document.getElementById('pie-principal');
    const pieInterestEl = document.getElementById('pie-interest');
    const pieSavingsEl = document.getElementById('pie-savings');
    const piePercentDisplayEl = document.getElementById('pie-percent-display');
    const legendPrincipalPercentEl = document.getElementById('legend-principal-percent');

    // Create pie tooltip element in body to avoid overflow clipping
    const pieTooltipEl = document.createElement('div');
    pieTooltipEl.className = 'pie-tooltip';
    pieTooltipEl.id = 'pie-tooltip';
    document.body.appendChild(pieTooltipEl);

    // Create chart tooltip element in body to avoid overflow clipping
    const chartTooltipEl = document.createElement('div');
    chartTooltipEl.className = 'chart-tooltip';
    chartTooltipEl.id = 'chart-tooltip';
    document.body.appendChild(chartTooltipEl);
    const legendInterestPercentEl = document.getElementById('legend-interest-percent');
    const legendSavingsRow = document.getElementById('legend-savings-row');
    const legendSavingsPercentEl = document.getElementById('legend-savings-percent');

    // Circle circumference for r=40
    const circumference = 2 * Math.PI * 40;

    // Store current pie chart data for tooltips
    let pieChartData = {
      loanAmount: 0,
      totalPayment: 0,
      totalInterest: 0,
      interestSaved: 0,
      principalPercent: 0,
      interestPercent: 0,
      savingsPercent: 0
    };

    // Custom term elements
    const termCustomWrapper = document.getElementById('term-custom-wrapper');
    const termCustomInput = document.getElementById('term-custom');
    const termUnitDropdown = document.getElementById('term-unit-dropdown');
    const termUnitTrigger = document.getElementById('term-unit-trigger');
    const termUnitLabel = document.getElementById('term-unit-label');
    const termUnitMenu = document.getElementById('term-unit-menu');
    const termUnitOptions = document.querySelectorAll('.term-unit-option');
    const termUnitSelect = document.getElementById('term-unit-select');
    let useCustomTerm = false;
    let termUnit = 'years'; // 'years' or 'months'

    // ========================================
    // WheelPicker: iOS-like touch physics
    // ========================================

    /**
     * WheelPicker: iOS-like physics-based wheel picker
     *
     * A touch-optimized wheel picker component with iOS-native feel.
     * Implements unified pointer events for mouse/touch/pen input,
     * velocity-based momentum physics, spring-based snap animations,
     * and rubber-band boundary constraints.
     *
     * Features:
     * - Unified pointer events API (mouse/touch/pen compatible)
     * - Velocity tracking with 100ms sliding window
     * - Exponential friction decay for momentum
     * - Spring physics for smooth snap animations
     * - Rubber-band resistance at boundaries
     * - Tap vs drag detection
     * - GPU-accelerated transforms
     * - Keyboard navigation support
     * - Full accessibility (ARIA attributes)
     *
     * Physics constants tuned to match iOS UIKit springs:
     * - FRICTION = 0.95 (exponential decay)
     * - SPRING_STIFFNESS = 170
     * - SPRING_DAMPING = 26
     * - RUBBER_BAND_RESISTANCE = 0.55
     *
     * @class WheelPicker
     * @param {HTMLElement} container - The wheel container element
     * @param {Object} config - Configuration object
     * @param {number} [config.itemHeight=36] - Height of each item in pixels
     * @param {Array} [config.items=[]] - Array of items to display
     * @param {number} [config.initialIndex=0] - Initially selected index
     * @param {Function} [config.onChange] - Callback fired when selection changes
     *
     * @example
     * const picker = new WheelPicker(document.getElementById('wheel'), {
     *   itemHeight: 36,
     *   items: [1, 2, 3, 4, 5],
     *   initialIndex: 2,
     *   onChange: (index, value) => console.log('Selected:', value)
     * });
     */
    class WheelPicker {
      constructor(container, config) {
        this.container = container;
        this.itemHeight = config.itemHeight || 36;
        this.items = config.items || [];
        this.selectedIndex = config.initialIndex || 0;
        this.onChange = config.onChange;

        // Physics state
        this.position = -this.selectedIndex * this.itemHeight;
        this.velocity = 0;
        this.isDragging = false;
        this.isAnimating = false;

        // Touch tracking
        this.touchPoints = [];
        this.pointerId = null;
        this.startY = 0;
        this.lastY = 0;
        this.dragStartTime = 0;
        this.visualUpdateScheduled = false;

        // RAF tracking
        this.rafId = null;

        // DOM references
        this.itemsContainer = null;

        // Mouse wheel accumulator
        this.wheelDelta = 0;
        this.wheelTimeout = null;

        this.init();
      }

      // Physics constants
      static FRICTION = 0.95;
      static MIN_VELOCITY = 0.1;
      static VELOCITY_MULTIPLIER = 16; // px/ms to px/frame at 60fps
      static SPRING_MASS = 1;
      static SPRING_STIFFNESS = 170;
      static SPRING_DAMPING = 26;
      static RUBBER_BAND_RESISTANCE = 0.55;
      static TAP_MAX_DURATION = 200; // ms
      static TAP_MAX_DISTANCE = 10;  // px

      init() {
        // Create items container wrapper
        this.itemsContainer = document.createElement('div');
        this.itemsContainer.className = 'wheel-items-container';

        // Move existing children into container
        while (this.container.firstChild) {
          this.itemsContainer.appendChild(this.container.firstChild);
        }

        // If no items exist, populate them
        if (this.itemsContainer.children.length === 0) {
          this.populateItems();
        }

        // Add container to wheel
        this.container.appendChild(this.itemsContainer);

        // Setup event listeners
        this.setupPointerEvents();

        // Initial render
        this.render();
      }

      populateItems() {
        // Add top spacer
        const topSpacer = document.createElement('div');
        topSpacer.className = 'wheel-spacer';
        this.itemsContainer.appendChild(topSpacer);

        // Add items
        this.items.forEach((value, index) => {
          const item = document.createElement('div');
          item.className = 'wheel-item';
          item.dataset.value = value;
          item.textContent = value;
          item.role = 'option';
          this.itemsContainer.appendChild(item);
        });

        // Add bottom spacer
        const bottomSpacer = document.createElement('div');
        bottomSpacer.className = 'wheel-spacer';
        this.itemsContainer.appendChild(bottomSpacer);
      }

      setupPointerEvents() {
        this.container.addEventListener('pointerdown', this.onPointerDown.bind(this));
        this.container.addEventListener('pointermove', this.onPointerMove.bind(this));
        this.container.addEventListener('pointerup', this.onPointerUp.bind(this));
        this.container.addEventListener('pointercancel', this.onPointerUp.bind(this));
        this.container.addEventListener('wheel', this.onWheel.bind(this), { passive: false });
      }

      onWheel(e) {
        e.preventDefault();

        // Stop snap animation if running
        if (this.rafId && !this.isDragging) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
        }

        // Apply wheel delta directly to position (scaled down for smoothness)
        const scrollSpeed = 0.5;
        const delta = e.deltaY * scrollSpeed;

        // Update position with bounds
        this.position = this.applyBounds(this.position - delta);
        this.render();

        // Clear previous snap timeout
        if (this.wheelTimeout) {
          clearTimeout(this.wheelTimeout);
        }

        // Snap to nearest item after scrolling stops
        this.wheelTimeout = setTimeout(() => {
          this.snapToNearest();
        }, 120);
      }

      animateToPosition(targetPosition) {
        this.isAnimating = true;

        const animate = () => {
          // Spring physics
          const displacement = targetPosition - this.position;
          const springForce = displacement * WheelPicker.SPRING_STIFFNESS / 1000;
          const dampingForce = this.velocity * WheelPicker.SPRING_DAMPING / 100;
          const acceleration = springForce - dampingForce;

          this.velocity += acceleration;
          this.position += this.velocity;

          this.render();

          // Check if settled
          if (Math.abs(displacement) < 0.5 && Math.abs(this.velocity) < 0.1) {
            this.position = targetPosition;
            this.velocity = 0;
            this.isAnimating = false;
            this.selectedIndex = Math.round(-this.position / this.itemHeight);
            this.render();

            if (this.onChange) {
              this.onChange(this.selectedIndex);
            }
            return;
          }

          this.rafId = requestAnimationFrame(animate);
        };

        this.rafId = requestAnimationFrame(animate);
      }

      onPointerDown(e) {
        // Stop any ongoing animation
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
        }

        // Prevent page scroll
        e.preventDefault();
        e.stopPropagation();

        // Capture pointer
        this.container.setPointerCapture(e.pointerId);
        this.pointerId = e.pointerId;

        // Reset state
        this.isDragging = true;
        this.isAnimating = false;
        this.velocity = 0;
        this.touchPoints = [];

        // Record start position
        this.startY = e.clientY;
        this.lastY = e.clientY;
        this.dragStartTime = Date.now();

        // Visual feedback
        this.container.style.cursor = 'grabbing';
      }

      onPointerMove(e) {
        if (!this.isDragging) return;

        const now = Date.now();
        const deltaY = e.clientY - this.lastY;

        // Store touch point for velocity calculation
        this.touchPoints.push({
          position: e.clientY,
          time: now
        });

        // Keep only recent points (last 100ms)
        this.touchPoints = this.touchPoints.filter(p => now - p.time < 100);

        // Update position with bounds
        this.position = this.applyBounds(this.position + deltaY);

        // Throttle expensive render updates
        if (!this.visualUpdateScheduled) {
          this.visualUpdateScheduled = true;
          requestAnimationFrame(() => {
            this.render();
            this.visualUpdateScheduled = false;
          });
        }

        this.lastY = e.clientY;
      }

      onPointerUp(e) {
        if (!this.isDragging) return;

        this.isDragging = false;
        this.container.style.cursor = '';

        if (this.pointerId !== null) {
          this.container.releasePointerCapture(this.pointerId);
          this.pointerId = null;
        }

        // Detect tap vs drag
        const dragDistance = Math.abs(this.startY - e.clientY);
        const dragDuration = Date.now() - this.dragStartTime;

        const isTap = dragDuration < WheelPicker.TAP_MAX_DURATION &&
                      dragDistance < WheelPicker.TAP_MAX_DISTANCE;

        if (isTap) {
          this.handleItemClick(e);
        } else {
          this.startMomentum();
        }
      }

      handleItemClick(e) {
        // Calculate which item was clicked
        const rect = this.container.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const centerY = this.container.offsetHeight / 2;

        // Calculate clicked index based on current position
        const relativeY = clickY - centerY;
        const clickedIndex = Math.round((-this.position + relativeY) / this.itemHeight);

        // Clamp to valid range
        const targetIndex = Math.max(0, Math.min(this.items.length - 1, clickedIndex));

        // Scroll to clicked item
        this.scrollToIndex(targetIndex, true);
      }

      /**
       * Scrolls the wheel to a specific index
       * @param {number} index - Target index to scroll to
       * @param {boolean} [animated=true] - Whether to animate the scroll
       */
      scrollToIndex(index, animated = true) {
        const clampedIndex = Math.max(0, Math.min(this.items.length - 1, index));
        const targetPosition = -clampedIndex * this.itemHeight;

        if (!animated) {
          // Instant scroll
          this.position = targetPosition;
          this.selectedIndex = clampedIndex;
          this.render();
          if (this.onChange) {
            this.onChange(clampedIndex);
          }
          return;
        }

        // Animated scroll using spring
        this.position = this.position; // Keep current position
        this.isAnimating = false; // Stop any current animation
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
        }

        // Use snapToNearest logic but with explicit target
        let springVelocity = 0;
        let currentPosition = this.position;

        const springStep = () => {
          const displacement = currentPosition - targetPosition;
          const springForce = -WheelPicker.SPRING_STIFFNESS * displacement;
          const dampingForce = -WheelPicker.SPRING_DAMPING * springVelocity;
          const acceleration = (springForce + dampingForce) / WheelPicker.SPRING_MASS;

          springVelocity += acceleration * (1/60);
          currentPosition += springVelocity * (1/60);

          this.position = currentPosition;
          this.render();

          const isSettled = Math.abs(displacement) < 0.01 && Math.abs(springVelocity) < 0.01;

          if (isSettled) {
            this.position = targetPosition;
            this.render();

            if (this.selectedIndex !== clampedIndex) {
              this.selectedIndex = clampedIndex;
              if (this.onChange) {
                this.onChange(clampedIndex);
              }
            }
          } else {
            this.rafId = requestAnimationFrame(springStep);
          }
        };

        this.rafId = requestAnimationFrame(springStep);
      }

      /**
       * Calculates velocity from recent touch points
       * Uses sliding window of last 100ms for accurate velocity tracking
       * @returns {number} Velocity in px/ms
       */
      calculateVelocity() {
        if (this.touchPoints.length < 2) return 0;

        // Use last 3 points for smoothing
        const recent = this.touchPoints.slice(-3);
        const first = recent[0];
        const last = recent[recent.length - 1];

        const distance = last.position - first.position;
        const time = last.time - first.time;

        if (time === 0) return 0;

        return distance / time; // px/ms
      }

      /**
       * Starts momentum animation after drag release
       * Applies exponential friction decay and rubber-band boundaries
       */
      startMomentum() {
        // Convert velocity from px/ms to px/frame
        let velocity = this.calculateVelocity() * WheelPicker.VELOCITY_MULTIPLIER;

        // Don't start momentum for tiny velocities
        if (Math.abs(velocity) < WheelPicker.MIN_VELOCITY) {
          this.snapToNearest();
          return;
        }

        this.isAnimating = true;

        const momentumStep = () => {
          if (!this.isAnimating) return;

          // Apply friction (exponential decay)
          velocity *= WheelPicker.FRICTION;

          // Update position
          this.position += velocity;

          // Apply bounds with rubber-band
          this.position = this.applyBounds(this.position);

          // Render
          this.render();

          // Stop condition - velocity too low
          if (Math.abs(velocity) < WheelPicker.MIN_VELOCITY) {
            this.snapToNearest();
          } else {
            this.rafId = requestAnimationFrame(momentumStep);
          }
        };

        this.rafId = requestAnimationFrame(momentumStep);
      }

      snapToNearest() {
        // Find nearest item index
        const targetIndex = Math.round(-this.position / this.itemHeight);

        // Clamp to valid range
        const clampedIndex = Math.max(0, Math.min(this.items.length - 1, targetIndex));
        const targetPosition = -clampedIndex * this.itemHeight;

        // Spring physics variables
        let springVelocity = 0;
        let currentPosition = this.position;

        const springStep = () => {
          // Calculate displacement from target
          const displacement = currentPosition - targetPosition;

          // Spring force: F = -k * x
          const springForce = -WheelPicker.SPRING_STIFFNESS * displacement;

          // Damping force: F = -c * v
          const dampingForce = -WheelPicker.SPRING_DAMPING * springVelocity;

          // Total acceleration: a = F/m
          const acceleration = (springForce + dampingForce) / WheelPicker.SPRING_MASS;

          // Update velocity and position (assuming 60fps)
          springVelocity += acceleration * (1/60);
          currentPosition += springVelocity * (1/60);

          // Apply to wheel
          this.position = currentPosition;
          this.render();

          // Stop when nearly settled (within 0.01px and 0.01px/frame velocity)
          const isSettled = Math.abs(displacement) < 0.01 && Math.abs(springVelocity) < 0.01;

          if (isSettled) {
            // Snap exactly to target
            this.position = targetPosition;
            this.render();
            this.isAnimating = false;

            // Fire change callback if index changed
            if (this.selectedIndex !== clampedIndex) {
              this.selectedIndex = clampedIndex;
              if (this.onChange) {
                this.onChange(clampedIndex);
              }
            }
          } else {
            this.rafId = requestAnimationFrame(springStep);
          }
        };

        this.rafId = requestAnimationFrame(springStep);
      }

      applyBounds(position) {
        const minPosition = -(this.items.length - 1) * this.itemHeight;
        const maxPosition = 0;

        // Within bounds - no change
        if (position >= minPosition && position <= maxPosition) {
          return position;
        }

        // Beyond top (position > 0)
        if (position > maxPosition) {
          const excess = position - maxPosition;
          const resistance = 1 / (1 + excess * WheelPicker.RUBBER_BAND_RESISTANCE);
          return maxPosition + excess * resistance;
        }

        // Beyond bottom (position < minPosition)
        const excess = minPosition - position;
        const resistance = 1 / (1 + excess * WheelPicker.RUBBER_BAND_RESISTANCE);
        return minPosition - excess * resistance;
      }

      render() {
        if (!this.itemsContainer) return;

        // Calculate offset to center selected item
        // Account for the 72px top spacer (2 * itemHeight)
        const spacerHeight = this.itemHeight * 2;
        const centerOffset = (this.container.offsetHeight / 2) - (this.itemHeight / 2) - spacerHeight;
        const translateY = this.position + centerOffset;

        // Apply transform to container
        this.itemsContainer.style.transform = `translateY(${translateY}px)`;

        // Update 3D transforms for each item
        this.updateVisualState();
      }

      updateVisualState() {
        const items = this.itemsContainer.querySelectorAll('.wheel-item');
        const centerY = this.container.offsetHeight / 2;
        const containerRect = this.itemsContainer.getBoundingClientRect();
        const wheelRect = this.container.getBoundingClientRect();

        items.forEach((item, i) => {
          // Вычисляем реальную позицию элемента на экране
          const itemRect = item.getBoundingClientRect();
          const itemCenterY = itemRect.top + itemRect.height / 2 - wheelRect.top;
          const offsetFromCenter = itemCenterY - centerY;

          // Вычисляем расстояние от центра
          const distance = Math.abs(offsetFromCenter);
          const maxDistance = this.itemHeight * 2.5;
          const distanceRatio = Math.min(distance / maxDistance, 1);

          // Определяем, является ли элемент выбранным (центральным)
          const isSelected = distance < this.itemHeight / 2;

          // Opacity: выбранный элемент всегда 1, остальные уменьшаются
          const opacity = isSelected ? 1 : 1 - Math.pow(distanceRatio, 1.0) * 0.65;

          // Scale: центральный элемент 1.05x, боковые уменьшаются до 0.8x
          const scale = isSelected ? 0.95 : 0.95 - Math.pow(distanceRatio, 0.8) * 0.25;

          // Font-weight: плавный переход от 400 (далеко) до 600 (в центре)
          const fontWeight = Math.round(600 - distanceRatio * 200);
          item.style.fontWeight = fontWeight.toString();

          // Color: плавный переход от #8B8278 (далеко) до #3D3935 (в центре)
          const colorLerp = 1 - distanceRatio;
          const r = Math.round(139 - colorLerp * 78);  // 139 -> 61
          const g = Math.round(130 - colorLerp * 73);  // 130 -> 57
          const b = Math.round(120 - colorLerp * 67);  // 120 -> 53
          item.style.color = `rgb(${r}, ${g}, ${b})`;

          // Применяем трансформации
          item.style.transform = `scale(${scale})`;
          item.style.opacity = opacity;

          // Обновляем классы для выделения центрального элемента
          item.classList.toggle('selected', isSelected);
          item.classList.toggle('near-1',
            distance >= this.itemHeight / 2 && distance < this.itemHeight * 1.5);
          item.classList.toggle('near-2',
            distance >= this.itemHeight * 1.5 && distance < this.itemHeight * 2.5);
        });
      }

      /**
       * Gets the currently selected index
       * @returns {number} The selected index
       */
      getCurrentIndex() {
        return this.selectedIndex;
      }

      /**
       * Updates the items in the wheel
       * Rebuilds the DOM and adjusts selection if needed
       * @param {Array} items - New array of items to display
       */
      setItems(items) {
        this.items = items;

        // Adjust selected index if now out of range
        if (this.selectedIndex >= items.length) {
          this.selectedIndex = items.length - 1;
        }

        // Rebuild DOM
        this.itemsContainer.innerHTML = '';
        this.populateItems();

        // Update position
        this.position = -this.selectedIndex * this.itemHeight;
        this.render();
      }

      /**
       * Destroys the wheel picker instance
       * Cancels animations and removes event listeners
       */
      destroy() {
        // Cancel any running animation
        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
        }

        // Remove event listeners
        this.container.removeEventListener('pointerdown', this.onPointerDown);
        this.container.removeEventListener('pointermove', this.onPointerMove);
        this.container.removeEventListener('pointerup', this.onPointerUp);
        this.container.removeEventListener('pointercancel', this.onPointerUp);

        // Clean up DOM
        if (this.itemsContainer && this.itemsContainer.parentNode) {
          this.itemsContainer.parentNode.removeChild(this.itemsContainer);
        }

        // Clear references
        this.itemsContainer = null;
        this.container = null;
        this.onChange = null;
      }
    }

    // Wheel picker elements
    const dayWheel = document.getElementById('day-wheel');
    const monthWheel = document.getElementById('month-wheel');
    const yearWheel = document.getElementById('year-wheel');

    // Current date state
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDay = now.getDate();
    let selectedDay = currentDay;
    let selectedMonth = currentMonth;
    let selectedYear = currentYear;

    // Month names (genitive case for date picker: "1 января", "10 февраля")
    const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                        'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];

    // Get days in month
    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    // ========================================
    // Keyboard Navigation Helper
    // ========================================
    function enableKeyboardNavigation(picker) {
      picker.container.addEventListener('keydown', (e) => {
        const currentIndex = picker.getCurrentIndex();
        let newIndex = currentIndex;

        switch (e.key) {
          case 'ArrowUp':
            e.preventDefault();
            newIndex = Math.max(0, currentIndex - 1);
            break;
          case 'ArrowDown':
            e.preventDefault();
            newIndex = Math.min(picker.items.length - 1, currentIndex + 1);
            break;
          case 'Home':
            e.preventDefault();
            newIndex = 0;
            break;
          case 'End':
            e.preventDefault();
            newIndex = picker.items.length - 1;
            break;
          case 'PageUp':
            e.preventDefault();
            newIndex = Math.max(0, currentIndex - 5);
            break;
          case 'PageDown':
            e.preventDefault();
            newIndex = Math.min(picker.items.length - 1, currentIndex + 5);
            break;
          default:
            return;
        }

        if (newIndex !== currentIndex) {
          picker.scrollToIndex(newIndex, true);
        }
      });
    }

    // ========================================
    // WheelPicker Initialization
    // ========================================

    // Year range for picker (current year - 30 to current year)
    const yearStart = currentYear - 30;

    // Initialize day picker
    const dayPicker = new WheelPicker(dayWheel, {
      itemHeight: 36,
      items: Array.from({length: getDaysInMonth(selectedMonth, selectedYear)}, (_, i) => i + 1),
      initialIndex: selectedDay - 1,
      onChange: (index) => {
        selectedDay = index + 1;
        updateEarlyRepaymentMonthOptions(getValues().term);
        updateCalculations();
      }
    });

    // Initialize month picker
    const monthPicker = new WheelPicker(monthWheel, {
      itemHeight: 36,
      items: monthNames,
      initialIndex: selectedMonth,
      onChange: (index) => {
        selectedMonth = index;

        // Update day picker items when month changes
        const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
        dayPicker.setItems(Array.from({length: daysInMonth}, (_, i) => i + 1));

        // Adjust selected day if needed
        if (selectedDay > daysInMonth) {
          selectedDay = daysInMonth;
          dayPicker.scrollToIndex(selectedDay - 1, false);
        }

        updateEarlyRepaymentMonthOptions(getValues().term, true);
        updateCalculations();
      }
    });

    // Initialize year picker
    const yearPicker = new WheelPicker(yearWheel, {
      itemHeight: 36,
      items: Array.from({length: 31}, (_, i) => yearStart + i),
      initialIndex: selectedYear - yearStart,
      onChange: (index) => {
        selectedYear = yearStart + index;

        // Update day picker when year changes (affects leap years)
        const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
        dayPicker.setItems(Array.from({length: daysInMonth}, (_, i) => i + 1));

        if (selectedDay > daysInMonth) {
          selectedDay = daysInMonth;
          dayPicker.scrollToIndex(selectedDay - 1, false);
        }

        updateEarlyRepaymentMonthOptions(getValues().term, true);
        updateCalculations();
      }
    });

    // Enable keyboard navigation
    enableKeyboardNavigation(dayPicker);
    enableKeyboardNavigation(monthPicker);
    enableKeyboardNavigation(yearPicker);

    // Function to scroll wheels to selected date (compatibility)
    function scrollWheelsToSelectedDate() {
      dayPicker.scrollToIndex(selectedDay - 1, false);
      monthPicker.scrollToIndex(selectedMonth, false);
      yearPicker.scrollToIndex(selectedYear - yearStart, false);
    }

    // Getter functions for compatibility
    const startDaySelect = { get value() { return selectedDay; } };
    const startMonthSelect = { get value() { return selectedMonth; } };
    const startYearSelect = { get value() { return selectedYear; } };

    // Get current values
    function getValues() {
      const propertyPrice = parseFormattedNumber(propertyPriceInput.value);
      // Ограничение: первоначальный взнос не может превышать стоимость недвижимости
      const downPayment = Math.min(parseFormattedNumber(downPaymentInput.value), propertyPrice);
      const interestRate = parseFloat(interestRateInput.value.replace(',', '.')) || 0;

      let term;
      let rawTerm; // Original value from input (for saving to URL/localStorage)
      if (useCustomTerm && termCustomInput.value) {
        let termValue = parseInt(termCustomInput.value, 10) || 20;
        if (termUnit === 'months') {
          // Convert months to years, cap at 360 months (30 years)
          termValue = Math.max(1, Math.min(360, termValue));
          rawTerm = termValue;
          term = termValue / 12;
        } else {
          // Years, cap at 30
          term = Math.max(1, Math.min(30, termValue));
          rawTerm = term;
        }
      } else {
        const checkedRadio = document.querySelector('input[name="term"]:checked');
        term = checkedRadio ? parseInt(checkedRadio.value, 10) : 20;
        rawTerm = term;
      }

      const paymentTypeRadio = document.querySelector('input[name="payment-type"]:checked');
      const paymentType = paymentTypeRadio ? paymentTypeRadio.value : 'annuity';

      return { propertyPrice, downPayment, interestRate, term, rawTerm, paymentType };
    }

    // Update pie chart with optional savings segment
    function updatePieChart(loanAmount, totalPayment, totalInterest, interestSaved) {
      // totalPayment = loanAmount + totalInterest (original, without early payments)
      // interestSaved = how much we save on interest with early payments
      // newInterest = totalInterest - interestSaved (actual interest to pay)

      const newInterest = totalInterest - interestSaved;

      // All percentages relative to original total payment
      const principalPercent = totalPayment > 0 ? (loanAmount / totalPayment) * 100 : 0;
      const newInterestPercent = totalPayment > 0 ? (newInterest / totalPayment) * 100 : 0;
      const savingsPercent = totalPayment > 0 ? (interestSaved / totalPayment) * 100 : 0;

      // Store data for tooltips
      pieChartData = {
        loanAmount,
        totalPayment,
        totalInterest,
        interestSaved,
        newInterest,
        principalPercent,
        interestPercent: newInterestPercent,
        savingsPercent
      };

      // Calculate stroke-dasharray values
      // Principal ring shows the principal portion
      const principalDash = (principalPercent / 100) * circumference;
      piePrincipalEl.style.strokeDasharray = `${principalDash} ${circumference}`;

      // Savings ring shows savings + principal (so savings appears after new interest)
      if (interestSaved > 0) {
        const savingsDash = ((principalPercent + savingsPercent) / 100) * circumference;
        pieSavingsEl.style.strokeDasharray = `${savingsDash} ${circumference}`;
        pieSavingsEl.style.opacity = '1';
      } else {
        pieSavingsEl.style.strokeDasharray = `0 ${circumference}`;
        pieSavingsEl.style.opacity = '0';
      }
      legendSavingsPercentEl.textContent = savingsPercent.toFixed(1) + '%';

      // Update text displays
      const displayInterestPercent = interestSaved > 0 ? newInterestPercent : (100 - principalPercent);
      piePercentDisplayEl.textContent = displayInterestPercent.toFixed(1) + '%';
      legendPrincipalPercentEl.textContent = principalPercent.toFixed(1) + '%';
      legendInterestPercentEl.textContent = displayInterestPercent.toFixed(1) + '%';
    }

    // Pie chart tooltip handlers
    let currentPieTooltipType = null;
    const pieChartSvg = document.querySelector('.pie-chart');

    // Determine which segment the cursor is over based on angle
    function getPieSegmentAtAngle(e) {
      const rect = pieChartSvg.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      // Calculate angle from center (0 = top, clockwise)
      const dx = e.clientX - centerX;
      const dy = e.clientY - centerY;

      // Check if cursor is on the ring (not in center or outside)
      const distance = Math.sqrt(dx * dx + dy * dy);
      const ringOuterRadius = rect.width / 2;
      const ringInnerRadius = ringOuterRadius * 0.55; // approximate inner radius

      if (distance < ringInnerRadius || distance > ringOuterRadius) {
        return null;
      }

      // Convert to angle (0-360, starting from top, going clockwise)
      // atan2 gives angle from positive X axis, counter-clockwise
      // We need angle from negative Y axis (top), clockwise
      let angle = Math.atan2(dx, -dy) * (180 / Math.PI);
      if (angle < 0) angle += 360;

      // Convert angle to percentage (0-100)
      const percentage = angle / 360 * 100;

      // Determine segment based on percentage
      // Order: principal (0 to principalPercent), savings (principalPercent to principalPercent+savingsPercent), interest (rest)
      const principalEnd = pieChartData.principalPercent;
      const savingsEnd = principalEnd + pieChartData.savingsPercent;

      if (percentage < principalEnd) {
        return 'principal';
      } else if (pieChartData.savingsPercent > 0 && percentage < savingsEnd) {
        return 'savings';
      } else {
        return 'interest';
      }
    }

    function showPieTooltip(type, e) {
      if (!type) return;

      let title, value, percent, colorClass;

      if (type === 'principal') {
        title = 'Основной долг';
        value = pieChartData.loanAmount;
        percent = pieChartData.principalPercent;
        colorClass = 'principal';
      } else if (type === 'interest') {
        title = 'Переплата по\u00A0процентам';
        value = pieChartData.newInterest;
        percent = pieChartData.interestPercent;
        colorClass = 'interest';
      } else if (type === 'savings') {
        title = 'Экономия';
        value = pieChartData.interestSaved;
        percent = pieChartData.savingsPercent;
        colorClass = 'savings';
      }

      currentPieTooltipType = type;

      pieTooltipEl.innerHTML = `
        <div class="pie-tooltip-title">${title}</div>
        <div class="pie-tooltip-row">
          <span class="pie-tooltip-label">Сумма:</span>
          <span class="pie-tooltip-value ${colorClass}">${formatNumber(value)} ₽</span>
        </div>
        <div class="pie-tooltip-row">
          <span class="pie-tooltip-label">Доля:</span>
          <span class="pie-tooltip-value ${colorClass}">${percent.toFixed(1)}%</span>
        </div>
      `;

      positionPieTooltip(e);
      pieTooltipEl.classList.add('visible');
    }

    function positionPieTooltip(e) {
      const tooltipRect = pieTooltipEl.getBoundingClientRect();
      const padding = 10;

      let x = e.clientX;
      let y = e.clientY - padding;

      // Check right edge
      if (x + tooltipRect.width / 2 > window.innerWidth - padding) {
        x = window.innerWidth - tooltipRect.width / 2 - padding;
      }
      // Check left edge
      if (x - tooltipRect.width / 2 < padding) {
        x = tooltipRect.width / 2 + padding;
      }
      // Check top edge - if tooltip would be cut off at top, show below cursor
      if (y - tooltipRect.height < padding) {
        y = e.clientY + tooltipRect.height + padding;
      }

      pieTooltipEl.style.left = x + 'px';
      pieTooltipEl.style.top = y + 'px';
    }

    function handlePieMouseMove(e) {
      const segment = getPieSegmentAtAngle(e);
      if (segment) {
        if (segment !== currentPieTooltipType) {
          showPieTooltip(segment, e);
        } else {
          positionPieTooltip(e);
        }
      } else {
        hidePieTooltip();
      }
    }

    function hidePieTooltip() {
      currentPieTooltipType = null;
      pieTooltipEl.classList.remove('visible');
    }

    // Add event listeners for pie chart
    pieChartSvg.addEventListener('mousemove', handlePieMouseMove);
    pieChartSvg.addEventListener('mouseleave', hidePieTooltip);

    // Handle touch/click for mobile - toggle tooltip on tap
    pieChartSvg.addEventListener('click', (e) => {
      const segment = getPieSegmentAtAngle(e);
      if (segment) {
        // If tapping the same segment, hide tooltip; otherwise show new one
        if (segment === currentPieTooltipType) {
          hidePieTooltip();
        } else {
          showPieTooltip(segment, e);
        }
      } else {
        hidePieTooltip();
      }
    });

    // Hide pie tooltip when clicking outside
    document.addEventListener('click', (e) => {
      if (currentPieTooltipType && !pieChartSvg.contains(e.target) && !pieTooltipEl.contains(e.target)) {
        hidePieTooltip();
      }
    });

    // Update all calculations
    function updateCalculations() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();

      const loanAmount = Math.max(0, propertyPrice - downPayment);

      let monthlyPayment, totalPayment, totalInterest;

      if (paymentType === 'differentiated') {
        const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
        monthlyPayment = diff.first;
        totalPayment = diff.total;
        totalInterest = diff.totalInterest;

        paymentTypeLabelEl.textContent = 'Первый платёж';
        paymentRangeInnerEl.textContent = `от\u00A0${formatNumber(diff.last)}\u00A0₽ до\u00A0${formatNumber(diff.first)}\u00A0₽`;
        paymentRangeEl.classList.add('visible');
      } else {
        monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        totalPayment = monthlyPayment * term * 12;
        totalInterest = totalPayment - loanAmount;

        paymentTypeLabelEl.textContent = 'Аннуитетный платёж';
        paymentRangeEl.classList.remove('visible');
      }

      // Update display
      paymentAmountEl.textContent = formatNumber(monthlyPayment);
      loanAmountEl.textContent = formatNumber(loanAmount) + ' ₽';
      totalPaymentEl.textContent = formatNumber(totalPayment) + ' ₽';
      totalInterestEl.textContent = formatNumber(totalInterest) + ' ₽';

      // Update pie chart (will be updated again by updateEarlySummary if there are early payments)
      updatePieChart(loanAmount, totalPayment, totalInterest, 0);

      // Update down payment percent
      const downPaymentPct = propertyPrice > 0 ? (downPayment / propertyPrice) * 100 : 0;
      downPaymentPercent.textContent = Math.round(downPaymentPct) + '%';

      // Show optimal payment suggestion - accounts for elapsed time if issue date is in the past
      const elapsedMonths = getElapsedMonths();
      const totalMonths = term * 12;
      const remainingMonthsFromStart = totalMonths - elapsedMonths;
      const remainingYears = remainingMonthsFromStart / 12;

      // Calculate remaining balance based on payment type
      let remainingBalance;
      if (paymentType === 'differentiated') {
        remainingBalance = getRemainingBalanceDifferentiated(loanAmount, interestRate, term, elapsedMonths);
      } else {
        remainingBalance = getRemainingBalanceAnnuity(loanAmount, interestRate, term, elapsedMonths);
      }

      // Target term for optimal payment: 15 years
      // Show if remaining term is longer than 15 years (any savings)
      const targetOptimalYears = 15;
      const canOptimize = remainingYears > targetOptimalYears && remainingBalance > 0 && interestRate > 0;

      if (canOptimize) {
        let optimalPayment, optimalInterest, extraPayment;
        let currentRemainingInterest;

        // Calculate interest for remaining term at current pace
        if (paymentType === 'differentiated') {
          const currentRemaining = calculateDifferentiatedPayment(remainingBalance, interestRate, remainingYears);
          currentRemainingInterest = currentRemaining.totalInterest;

          const optimalDiff = calculateDifferentiatedPayment(remainingBalance, interestRate, targetOptimalYears);
          optimalPayment = optimalDiff.first;
          optimalInterest = optimalDiff.totalInterest;

          // Get current first payment for remaining balance
          const currentFirstPayment = getDifferentiatedPaymentForMonth(remainingBalance, interestRate, remainingYears, 1);
          extraPayment = optimalDiff.first - currentFirstPayment;

          // Show savings: remaining annuity vs differentiated on target years
          const annuityRemaining = calculateAnnuityPayment(remainingBalance, interestRate, remainingYears);
          const annuityRemainingInterest = annuityRemaining * remainingYears * 12 - remainingBalance;
          const vsAnnuitySavings = annuityRemainingInterest - optimalDiff.totalInterest;
          document.getElementById('optimal-vs-annuity').textContent = formatNumber(vsAnnuitySavings) + ' ₽';
          document.getElementById('optimal-vs-annuity-item').style.display = 'flex';
        } else {
          // For annuity: optimal payment is always calculated from ORIGINAL loan amount for 15 years
          // This is the fixed payment needed to pay off the original loan in 15 years
          optimalPayment = calculateAnnuityPayment(loanAmount, interestRate, targetOptimalYears);
          optimalInterest = optimalPayment * targetOptimalYears * 12 - loanAmount;

          // Extra payment is the difference between optimal and current monthly payment (both fixed)
          extraPayment = optimalPayment - monthlyPayment;

          // Calculate how much interest user will pay on remaining balance at current pace
          // and how many months it will take
          const monthlyRate = interestRate / 100 / 12;
          let balance = remainingBalance;
          let totalInterestPaid = 0;
          let monthsAtCurrentPace = 0;

          while (balance > 0.01 && monthsAtCurrentPace < 1000) { // Safety limit
            const interestThisMonth = balance * monthlyRate;
            const principalThisMonth = Math.min(monthlyPayment - interestThisMonth, balance);
            if (principalThisMonth <= 0) break;
            totalInterestPaid += interestThisMonth;
            balance -= principalThisMonth;
            monthsAtCurrentPace++;
          }

          currentRemainingInterest = totalInterestPaid;

          // Calculate interest and months if paying optimal payment on remaining balance
          balance = remainingBalance;
          let optimalInterestRemaining = 0;
          let monthsAtOptimalPace = 0;
          while (balance > 0.01 && monthsAtOptimalPace < 1000) {
            const interestThisMonth = balance * monthlyRate;
            const principalThisMonth = Math.min(optimalPayment - interestThisMonth, balance);
            if (principalThisMonth <= 0) break;
            optimalInterestRemaining += interestThisMonth;
            balance -= principalThisMonth;
            monthsAtOptimalPace++;
          }

          optimalInterest = optimalInterestRemaining;

          // Hide vs annuity for annuity payments
          document.getElementById('optimal-vs-annuity-item').style.display = 'none';
        }

        const savings = currentRemainingInterest - optimalInterest;
        // Years saved is remaining term minus 15 years (the target)
        const yearsSaved = remainingYears - targetOptimalYears;
        const monthsSaved = Math.round(yearsSaved * 12);

        optimalPaymentAmountEl.textContent = formatNumber(optimalPayment);
        document.getElementById('optimal-savings').textContent = formatNumber(savings) + ' ₽';

        // Show months if less than 1 year, otherwise show years
        if (yearsSaved < 1) {
          document.getElementById('optimal-years').textContent = monthsSaved + ' мес';
        } else {
          document.getElementById('optimal-years').textContent = Math.round(yearsSaved) + ' ' + pluralizeYears(Math.round(yearsSaved));
        }
        document.getElementById('optimal-extra').textContent = '+' + formatNumber(extraPayment) + ' ₽';

        const optimalLabel = document.getElementById('optimal-payment-label');

        // Update label based on context
        if (elapsedMonths > 0) {
          // Mortgage already started - show context about remaining time
          const yearsElapsed = Math.floor(elapsedMonths / 12);
          const monthsElapsedRemainder = elapsedMonths % 12;
          let elapsedText;
          if (yearsElapsed > 0 && monthsElapsedRemainder > 0) {
            elapsedText = yearsElapsed + '\u00A0' + pluralizeYears(yearsElapsed) + ' ' + monthsElapsedRemainder + '\u00A0мес';
          } else if (yearsElapsed > 0) {
            elapsedText = yearsElapsed + '\u00A0' + pluralizeYears(yearsElapsed);
          } else {
            elapsedText = monthsElapsedRemainder + '\u00A0мес';
          }

          optimalLabel.textContent = paymentType === 'differentiated'
            ? 'первый платёж для закрытия за\u00A015\u00A0лет (прошло ' + elapsedText + ')'
            : 'для закрытия за\u00A015\u00A0лет (прошло ' + elapsedText + ')';
        } else {
          optimalLabel.textContent = paymentType === 'differentiated'
            ? 'первый платёж для закрытия за\u00A015\u00A0лет'
            : 'для закрытия за\u00A015\u00A0лет';
        }

        // Check if label wraps to multiple lines
        requestAnimationFrame(() => {
          const lineHeight = parseFloat(getComputedStyle(optimalLabel).lineHeight) ||
                             parseFloat(getComputedStyle(optimalLabel).fontSize) * 1.2;
          optimalLabel.classList.toggle('multiline', optimalLabel.offsetHeight > lineHeight * 1.5);
        });
        optimalPaymentEl.classList.add('visible');
      } else {
        optimalPaymentEl.classList.remove('visible');
      }

      // Update chart and table
      updateScheduleChart(loanAmount, interestRate, term, paymentType);
      updateScheduleTable(loanAmount, interestRate, term, paymentType);

      // Update early repayment month options and recalculate their effect
      updateEarlyRepaymentMonthOptions(term);
      updateEarlySummary();

      // Update total payment hints in all early repayment items
      updateAllTotalPaymentHints();

      // Update URL
      updateURL();
    }

    // Update total payment hints in all early repayment items
    function updateAllTotalPaymentHints() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);
      const items = bentoEarlyList.querySelectorAll('.bento-early-item');

      items.forEach(item => {
        const amountInput = item.querySelector('.repayment-amount');
        const amountType = item.querySelector('.repayment-amount-type').value;
        const monthSelect = item.querySelector('.repayment-month');
        const hint = item.querySelector('.total-payment-hint');

        if (!hint || !amountInput) return;

        const enteredAmount = parseFormattedNumber(amountInput.value) || 0;
        const selectedMonth = parseInt(monthSelect?.value) || 1;

        // Get monthly payment based on payment type and selected month
        let monthlyPayment;
        if (paymentType === 'differentiated') {
          monthlyPayment = getDifferentiatedPaymentForMonth(loanAmount, interestRate, term, selectedMonth);
        } else {
          monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        }

        if (amountType === 'total') {
          // "Полная сумма" - show breakdown: base + extra = total
          // If entered amount is less than monthly payment, total = monthly payment
          const extraPart = Math.max(0, enteredAmount - monthlyPayment);
          const actualTotal = Math.max(enteredAmount, monthlyPayment);
          if (enteredAmount > 0 && monthlyPayment > 0) {
            hint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(monthlyPayment)) + ' + ' + formatNumber(Math.round(extraPart)) + ' = ' + formatNumber(Math.round(actualTotal)) + ' ₽';
          } else {
            hint.dataset.tooltip = 'Итого за месяц: — ₽';
          }
        } else {
          // "Сверх платежа" - show breakdown: base + extra = total
          const totalForMonth = monthlyPayment + enteredAmount;
          if (enteredAmount > 0 && monthlyPayment > 0) {
            hint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(monthlyPayment)) + ' + ' + formatNumber(Math.round(enteredAmount)) + ' = ' + formatNumber(Math.round(totalForMonth)) + ' ₽';
          } else if (totalForMonth > 0) {
            hint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(totalForMonth)) + ' ₽';
          } else {
            hint.dataset.tooltip = 'Итого за месяц: — ₽';
          }
        }
      });
    }

    // Update month options in all early repayment items when term changes
    function updateEarlyRepaymentMonthOptions(term, updateToNearestFuture = false) {
      const items = bentoEarlyList.querySelectorAll('.bento-early-item');
      const newNativeOptions = generateMonthOptions(term);
      const newDropdownOptions = generateMonthDropdownOptions(term);
      const maxMonth = term * 12;
      const defaultMonth = updateToNearestFuture ? getDefaultPaymentMonth(term) : null;

      items.forEach(item => {
        const monthSelect = item.querySelector('.repayment-month');
        const monthDropdown = item.querySelector('.month-dropdown');
        // Menu is moved to body, use stored reference
        const dropdownMenu = monthDropdown ? monthDropdown._menu : null;

        if (monthSelect) {
          const currentValue = parseInt(monthSelect.value, 10);
          monthSelect.innerHTML = newNativeOptions;

          // Update custom dropdown menu (which is in body)
          if (dropdownMenu) {
            dropdownMenu.innerHTML = newDropdownOptions;
          }

          let newValue = currentValue <= maxMonth ? currentValue : maxMonth;

          // When issue date changes, always reset to nearest future payment
          if (updateToNearestFuture && defaultMonth !== null) {
            newValue = defaultMonth;
          }

          monthSelect.value = newValue;

          // Sync custom dropdown
          if (monthDropdown) {
            syncMonthDropdown(monthDropdown, newValue);
          }

          // Update payment number hint
          const wrapper = item.closest('.bento-early-item-wrapper');
          if (wrapper) {
            const paymentNumberHint = wrapper.querySelector('.repayment-payment-number');
            if (paymentNumberHint) {
              paymentNumberHint.textContent = '№ ' + newValue;
            }
          }
        }

        // Update total payments display
        const totalPaymentsEl = item.querySelector('.repayment-total-payments');
        if (totalPaymentsEl) {
          totalPaymentsEl.textContent = maxMonth;
        }
      });
    }

    // Sync input and range slider
    function syncInputAndRange(input, range, min, max) {
      input.addEventListener('input', (e) => {
        // Remove non-digit characters except spaces for readability
        const rawValue = e.target.value.replace(/[^\d\s]/g, '');
        const value = parseFormattedNumber(rawValue);
        range.value = value;
        // Don't format during input to allow free typing, just update calculations
        updateCalculations();
      });

      input.addEventListener('blur', (e) => {
        let value = parseFormattedNumber(e.target.value);
        value = Math.max(min, Math.min(max, value));
        e.target.value = formatNumber(value);
        range.value = value;
        updateCalculations();
      });

      range.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        input.value = formatNumber(value);
        updateCalculations();
      });
    }

    // Initialize syncing
    syncInputAndRange(propertyPriceInput, propertyPriceRange, 500000, 100000000);
    syncInputAndRange(downPaymentInput, downPaymentRange, 0, 50000000);

    // Interest rate handling
    interestRateInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(',', '.');
      value = value.replace(/[^0-9.]/g, '');
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      e.target.value = value;
      interestRateRange.value = parseFloat(value) || 0;
      updateCalculations();
    });

    interestRateInput.addEventListener('blur', (e) => {
      let value = parseFloat(e.target.value.replace(',', '.')) || 0;
      value = Math.max(1, Math.min(30, value));
      e.target.value = value;
      interestRateRange.value = value;
      updateCalculations();
    });

    interestRateRange.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      interestRateInput.value = value;
      updateCalculations();
    });

    // Format input value with spaces while typing
    function formatInputWithSpaces(input) {
      const cursorPos = input.selectionStart;
      const oldValue = input.value;
      const oldLength = oldValue.length;

      // Count digits before cursor
      const digitsBeforeCursor = oldValue.slice(0, cursorPos).replace(/\s/g, '').length;

      // Parse and format
      const rawValue = oldValue.replace(/\s/g, '').replace(/\D/g, '');
      const formatted = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

      input.value = formatted;

      // Calculate new cursor position
      let newPos = 0;
      let digitCount = 0;
      for (let i = 0; i < formatted.length && digitCount < digitsBeforeCursor; i++) {
        newPos++;
        if (formatted[i] !== ' ') {
          digitCount++;
        }
      }

      input.setSelectionRange(newPos, newPos);
    }

    // Property price input formatting
    propertyPriceInput.addEventListener('input', () => {
      formatInputWithSpaces(propertyPriceInput);
      updateDownPaymentRange();
    });

    // Down payment input formatting and validation
    downPaymentInput.addEventListener('input', () => {
      formatInputWithSpaces(downPaymentInput);
      // Ограничение: первоначальный взнос не может превышать стоимость недвижимости
      const propertyPrice = parseFormattedNumber(propertyPriceInput.value);
      const currentDownPayment = parseFormattedNumber(downPaymentInput.value);
      if (currentDownPayment > propertyPrice && propertyPrice > 0) {
        downPaymentInput.value = formatNumber(propertyPrice);
        downPaymentRange.value = propertyPrice;
      }
    });

    // Property price change updates down payment range
    propertyPriceRange.addEventListener('input', updateDownPaymentRange);

    function updateDownPaymentRange() {
      const propertyPrice = parseFormattedNumber(propertyPriceInput.value);
      downPaymentRange.max = propertyPrice;

      const currentDownPayment = parseFormattedNumber(downPaymentInput.value);
      if (currentDownPayment > propertyPrice) {
        downPaymentInput.value = formatNumber(propertyPrice);
        downPaymentRange.value = propertyPrice;
      }
    }

    // Term radio buttons
    termRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        useCustomTerm = false;
        termCustomWrapper.classList.remove('active');
        termCustomInput.value = '';
        // Reset unit to years when using preset buttons
        termUnit = 'years';
        updateTermUnitUI();
        updateCalculations();
      });
    });

    // Update term unit label based on value and unit type
    function updateTermUnitLabel() {
      const termValue = parseInt(termCustomInput.value, 10) || 1;
      const label = termUnit === 'months' ? pluralizeMonths(termValue) : pluralizeYears(termValue);
      termUnitLabel.textContent = label;
      // Update native select text too
      const selectedOption = termUnitSelect.options[termUnitSelect.selectedIndex];
      if (selectedOption) {
        selectedOption.textContent = label;
      }
    }

    // Update all term unit UI elements
    function updateTermUnitUI() {
      // Update dropdown options
      termUnitOptions.forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.value === termUnit);
      });
      // Update native select
      termUnitSelect.value = termUnit;
      // Update label
      updateTermUnitLabel();
    }

    // Set term unit and update everything
    function setTermUnit(unit) {
      termUnit = unit;
      updateTermUnitUI();
      closeTermUnitDropdown();
      updateCalculations();
    }

    // Open/close dropdown
    function openTermUnitDropdown() {
      termUnitDropdown.classList.add('open');
      termUnitTrigger.setAttribute('aria-expanded', 'true');
    }

    function closeTermUnitDropdown() {
      termUnitDropdown.classList.remove('open');
      termUnitTrigger.setAttribute('aria-expanded', 'false');
    }

    function toggleTermUnitDropdown() {
      if (termUnitDropdown.classList.contains('open')) {
        closeTermUnitDropdown();
      } else {
        openTermUnitDropdown();
      }
    }

    // Dropdown trigger click
    termUnitTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleTermUnitDropdown();
    });

    // Dropdown option click
    termUnitOptions.forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.stopPropagation();
        setTermUnit(opt.dataset.value);
      });
    });

    // Native select change (mobile)
    termUnitSelect.addEventListener('change', () => {
      setTermUnit(termUnitSelect.value);
    });

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      if (!termUnitDropdown.contains(e.target)) {
        closeTermUnitDropdown();
      }
    });

    // Validate and cap term input value
    function validateTermInput() {
      let value = parseInt(termCustomInput.value, 10);
      if (isNaN(value) || value < 1) return;

      const max = termUnit === 'months' ? 360 : 30;
      if (value > max) {
        termCustomInput.value = max;
        value = max;
      }
      updateTermUnitLabel();
    }

    // Custom term input
    termCustomInput.addEventListener('focus', () => {
      useCustomTerm = true;
      termRadios.forEach(r => r.checked = false);
      termCustomWrapper.classList.add('active');
    });

    termCustomInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
      if (e.target.value) {
        useCustomTerm = true;
        termRadios.forEach(r => r.checked = false);
        termCustomWrapper.classList.add('active');
        validateTermInput();
        updateCalculations();
      }
    });

    termCustomInput.addEventListener('blur', (e) => {
      if (!e.target.value) {
        useCustomTerm = false;
        termCustomWrapper.classList.remove('active');
        document.getElementById('term-20').checked = true;
        updateCalculations();
      } else {
        validateTermInput();
      }
    });

    // Click anywhere on custom term wrapper to focus input (but not on dropdown)
    termCustomWrapper.addEventListener('click', (e) => {
      if (!termUnitDropdown.contains(e.target) && !termUnitSelect.contains(e.target)) {
        termCustomInput.focus();
      }
    });

    // Payment type radios
    paymentTypeRadios.forEach(radio => {
      radio.addEventListener('change', updateCalculations);
    });

    // Bento early repayment elements
    const bentoEarlyList = document.getElementById('bento-early-list');
    const bentoEarlyEmpty = document.getElementById('bento-early-empty');
    const bentoEarlyAddBtn = document.getElementById('bento-early-add-btn');
    const bentoEarlySummary = document.getElementById('bento-early-summary');
    const bentoEarlyBadge = document.getElementById('bento-early-badge');

    // Summary elements
    const summaryNewTerm = document.getElementById('bento-summary-new-term');
    const summaryTermSaved = document.getElementById('bento-summary-term-saved');
    const summaryNewInterest = document.getElementById('bento-summary-new-interest');
    const summaryInterestSaved = document.getElementById('bento-summary-interest-saved');
    const summaryTotalPayment = document.getElementById('bento-summary-total-payment');
    const summaryPayoffDate = document.getElementById('bento-summary-payoff-date');

    // Update badge count
    function updateBentoEarlyBadge(count) {
      if (count > 0) {
        bentoEarlyBadge.textContent = count;
        bentoEarlyBadge.classList.add('visible');
      } else {
        bentoEarlyBadge.classList.remove('visible');
      }
    }

    // Store early repayments
    let earlyRepayments = [];
    let repaymentIdCounter = 0;
    let chartUpdateTimeoutId = null; // For debouncing chart bar updates
    let chartViewMode = 'all'; // 'all' for all years, or a specific year number
    let chartAvailableYears = []; // List of available years for the dropdown
    let previousChartViewMode = 'all'; // Track previous mode for detecting view changes

    // Full month names for early repayment
    const shortMonthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

    // Generate month options for native select (fallback for mobile)
    function generateMonthOptions(term, selectedValue = 1) {
      const totalMonths = term * 12;
      const startMonth = parseInt(startMonthSelect.value, 10);
      const startYear = parseInt(startYearSelect.value, 10);
      let options = '';
      for (let m = 1; m <= totalMonths; m++) {
        const futureDate = new Date(startYear, startMonth + m, 1);
        const monthName = shortMonthNames[futureDate.getMonth()];
        const year = futureDate.getFullYear();
        const selected = m === selectedValue ? ' selected' : '';
        options += `<option value="${m}"${selected}>${monthName} ${year} (${m}-й платёж)</option>`;
      }
      return options;
    }

    // Generate custom dropdown options for month selector with balance info
    function generateMonthDropdownOptions(term, selectedValue = 1) {
      const totalMonths = term * 12;
      const startMonth = parseInt(startMonthSelect.value, 10);
      const startYear = parseInt(startYearSelect.value, 10);

      // Get current calculation params to show balance
      const propertyPrice = parseFormattedNumber(propertyPriceInput.value) || 0;
      const downPaymentVal = parseFormattedNumber(downPaymentInput.value) || 0;
      const interestRate = parseFloat(interestRateInput.value.replace(',', '.')) || 0;
      const paymentTypeRadio = document.querySelector('input[name="payment-type"]:checked');
      const paymentType = paymentTypeRadio ? paymentTypeRadio.value : 'annuity';
      const amount = Math.max(0, propertyPrice - downPaymentVal);

      // Calculate schedule to get balance at each month
      const monthlyRate = interestRate / 100 / 12;
      let balance = amount;
      const balances = [amount]; // Balance before payment 1

      // Only calculate if we have valid values
      if (amount > 0 && monthlyRate > 0) {
        if (paymentType === 'annuity') {
          const monthlyPayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) /
                                 (Math.pow(1 + monthlyRate, totalMonths) - 1);
          for (let m = 1; m <= totalMonths; m++) {
            const interest = balance * monthlyRate;
            const principal = monthlyPayment - interest;
            balance = Math.max(0, balance - principal);
            balances.push(balance);
          }
        } else {
          const monthlyPrincipal = amount / totalMonths;
          for (let m = 1; m <= totalMonths; m++) {
            balance = Math.max(0, balance - monthlyPrincipal);
            balances.push(balance);
          }
        }
      } else {
        // Fill with original amount if no valid calculation
        for (let m = 1; m <= totalMonths; m++) {
          balances.push(amount);
        }
      }

      let options = '';
      let currentYear = null;

      for (let m = 1; m <= totalMonths; m++) {
        const futureDate = new Date(startYear, startMonth + m, 1);
        const monthName = shortMonthNames[futureDate.getMonth()];
        const year = futureDate.getFullYear();
        const selected = m === selectedValue ? ' selected' : '';

        // Add year divider if year changed
        if (year !== currentYear) {
          options += `<div class="month-dropdown-year-divider">${year} год</div>`;
          currentYear = year;
        }

        // Balance before this payment
        const balanceAtMonth = Math.round(balances[m - 1]);
        const paidPercent = amount > 0 ? Math.round((1 - balanceAtMonth / amount) * 100) : 0;

        options += `
          <div class="custom-dropdown-option${selected}" data-value="${m}" role="option">
            <div class="month-option-main">
              <span class="month-option-date">${monthName} ${year}</span>
              <span class="month-option-payment">${m}-й платёж</span>
            </div>
            <div class="month-option-balance">
              <span class="month-option-remaining">Остаток: ${formatNumber(balanceAtMonth)} ₽</span>
              <span class="month-option-progress">${paidPercent}% выплачено</span>
            </div>
            <svg class="custom-dropdown-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>`;
      }
      return options;
    }

    // Get month display text for trigger
    function getMonthDisplayText(monthValue) {
      const startMonth = parseInt(startMonthSelect.value, 10);
      const startYear = parseInt(startYearSelect.value, 10);
      const futureDate = new Date(startYear, startMonth + parseInt(monthValue), 1);
      const monthName = shortMonthNames[futureDate.getMonth()];
      const year = futureDate.getFullYear();
      return `${monthName} ${year} (${monthValue}-й)`;
    }

    // Sync month dropdown UI with value
    function syncMonthDropdown(dropdown, value) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger-text');
      // Menu is moved to body, use stored reference
      const menu = dropdown._menu;

      dropdown.dataset.value = value;
      if (trigger) {
        trigger.textContent = getMonthDisplayText(value);
      }

      if (menu) {
        const options = menu.querySelectorAll('.custom-dropdown-option');
        options.forEach(opt => {
          const isSelected = opt.dataset.value === String(value);
          opt.classList.toggle('selected', isSelected);
        });
      }
    }

    // Close all open dropdowns
    function closeAllDropdowns() {
      document.querySelectorAll('.custom-dropdown.open').forEach(d => {
        d.classList.remove('open');
      });
      // Also close menus moved to body
      document.querySelectorAll('body > .custom-dropdown-menu.open').forEach(m => {
        m.classList.remove('open');
      });
    }

    // Global tooltip system (renders in body to escape overflow:hidden)
    const globalTooltip = document.createElement('div');
    globalTooltip.className = 'global-tooltip';
    document.body.appendChild(globalTooltip);

    let activeTooltipTrigger = null;

    function positionTooltip(trigger) {
      const text = trigger.getAttribute('data-tooltip');
      if (!text) return;

      globalTooltip.textContent = text;
      const rect = trigger.getBoundingClientRect();
      const tooltipRect = globalTooltip.getBoundingClientRect();
      globalTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
      globalTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
    }

    function initGlobalTooltip(trigger) {
      trigger.addEventListener('mouseenter', () => {
        const text = trigger.getAttribute('data-tooltip');
        if (!text) return;

        activeTooltipTrigger = trigger;
        globalTooltip.textContent = text;
        globalTooltip.style.visibility = 'hidden';
        globalTooltip.style.opacity = '0';
        globalTooltip.classList.add('visible');

        // Need to get dimensions after adding content
        requestAnimationFrame(() => {
          positionTooltip(trigger);
          globalTooltip.style.visibility = '';
          globalTooltip.style.opacity = '';
        });
      });

      trigger.addEventListener('mouseleave', () => {
        activeTooltipTrigger = null;
        globalTooltip.classList.remove('visible');
      });
    }

    // Update tooltip position on scroll
    window.addEventListener('scroll', () => {
      if (activeTooltipTrigger && globalTooltip.classList.contains('visible')) {
        positionTooltip(activeTooltipTrigger);
      }
    }, { passive: true });

    // Initialize tooltips for existing elements
    document.querySelectorAll('.total-payment-hint[data-tooltip]').forEach(initGlobalTooltip);

    // Initialize month dropdown behavior
    function initMonthDropdown(dropdown, nativeSelect) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger');
      const menu = dropdown.querySelector('.custom-dropdown-menu');

      // Move menu to body to escape overflow:hidden containers
      document.body.appendChild(menu);
      menu.style.position = 'fixed';

      // Store references for two-way lookup
      menu._dropdown = dropdown;
      menu._nativeSelect = nativeSelect;

      // Position menu relative to trigger
      function positionMenu() {
        const rect = trigger.getBoundingClientRect();
        menu.style.top = (rect.bottom + 4) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.width = rect.width + 'px';
      }

      // Toggle dropdown on trigger click
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = dropdown.classList.contains('open');
        closeAllDropdowns();

        if (!isOpen) {
          positionMenu();
          dropdown.classList.add('open');
          menu.classList.add('open');
          // Scroll to selected option when opening
          const selectedOpt = menu.querySelector('.custom-dropdown-option.selected');
          if (selectedOpt) {
            setTimeout(() => {
              selectedOpt.scrollIntoView({ block: 'nearest' });
            }, 0);
          }
        }
      });

      // Handle option selection
      menu.addEventListener('click', (e) => {
        const option = e.target.closest('.custom-dropdown-option');
        if (!option) return;

        e.preventDefault();
        e.stopPropagation();

        const value = option.dataset.value;

        // Update native select
        nativeSelect.value = value;

        // Sync dropdown
        syncMonthDropdown(dropdown, value);

        // Close dropdown
        dropdown.classList.remove('open');
        menu.classList.remove('open');

        // Trigger change event
        nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
      });

      // Keyboard navigation
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('open');
          menu.classList.remove('open');
        }
      });

      // Update position on scroll
      window.addEventListener('scroll', () => {
        if (dropdown.classList.contains('open')) {
          positionMenu();
        }
      }, { passive: true });

      // Store menu reference on dropdown for syncMonthDropdown
      dropdown._menu = menu;
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.custom-dropdown') && !e.target.closest('.custom-dropdown-menu')) {
        closeAllDropdowns();
      }
    });

    // Create repayment item HTML for bento-early
    // Calculate the nearest future payment number based on current date
    function getDefaultPaymentMonth(term) {
      const today = new Date();
      const startMonth = parseInt(startMonthSelect.value, 10);
      const startYear = parseInt(startYearSelect.value, 10);
      const totalMonths = term * 12;

      // Find the first payment month that is >= current month
      for (let m = 1; m <= totalMonths; m++) {
        const paymentDate = new Date(startYear, startMonth + m, 1);
        if (paymentDate >= today) {
          return m;
        }
      }
      // If all payments are in the past, return 1
      return 1;
    }

    function createRepaymentItem(id, term) {
      const defaultMonth = getDefaultPaymentMonth(term);

      const wrapper = document.createElement('div');
      wrapper.className = 'bento-early-item-wrapper';
      wrapper.dataset.id = id;

      const div = document.createElement('div');
      div.className = 'bento-early-item';
      div.innerHTML = `
        <div class="bento-early-primary">
          <div class="bento-early-item-field">
            <span class="bento-early-item-label">Дата платежа</span>
            <div class="bento-early-date-hint">Платёж <span class="bento-early-date-hint-value repayment-payment-number">№ ${defaultMonth}</span> из <span class="repayment-total-payments">${term * 12}</span></div>
            <div class="custom-dropdown month-dropdown" data-value="${defaultMonth}">
              <button type="button" class="custom-dropdown-trigger" aria-haspopup="listbox">
                <span class="custom-dropdown-trigger-text">${getMonthDisplayText(defaultMonth)}</span>
                <svg class="custom-dropdown-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="custom-dropdown-menu month-dropdown-menu" role="listbox">
                ${generateMonthDropdownOptions(term, defaultMonth)}
              </div>
              <select class="bento-early-item-select repayment-month">
                ${generateMonthOptions(term, defaultMonth)}
              </select>
            </div>
          </div>
          <div class="bento-early-item-field">
            <span class="bento-early-item-label">
              Сумма
              <span class="total-payment-hint" data-tooltip="Итого за месяц: — ₽" aria-label="Итого за месяц">
                <svg viewBox="0 0 16 16" fill="none" aria-hidden="true">
                  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M8 11.5v-.5M8 5c-.8 0-1.5.7-1.5 1.5S7.2 8 8 8c.8 0 1.5.7 1.5 1.5S8.8 11 8 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </span>
            </span>
            <div class="repayment-amount-type-row">
              <div class="repayment-amount-type-toggle">
                <button type="button" class="repayment-amount-type-btn active" data-amount-type="extra">
                  <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                  Сверх платежа
                </button>
                <button type="button" class="repayment-amount-type-btn" data-amount-type="total">
                  <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M2 4h12M2 8h12M2 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                  Полная сумма
                </button>
              </div>
              <span class="bento-early-amount-error">Мин. <span class="error-min-amount"></span></span>
            </div>
            <input type="hidden" class="repayment-amount-type" value="extra">
            <div class="bento-early-input-wrapper">
              <input type="text" class="bento-early-item-input repayment-amount" placeholder="100 000" inputmode="numeric">
              <span class="bento-early-input-suffix">₽</span>
            </div>
          </div>
        </div>
        <div class="bento-early-secondary">
          <div class="bento-early-secondary-group">
            <span class="bento-early-secondary-label">Повтор:</span>
            <div class="repayment-frequency-toggle">
              <button type="button" class="repayment-frequency-btn active" data-frequency="once">
                <svg viewBox="0 0 16 16" aria-hidden="true"><circle cx="8" cy="8" r="3" fill="currentColor"/></svg>
                Разово
              </button>
              <button type="button" class="repayment-frequency-btn" data-frequency="monthly">
                <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M12 2v2M4 2v2M2 6h12M2 6v8a1 1 0 001 1h10a1 1 0 001-1V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/><path d="M5 9h2v2H5z" fill="currentColor"/></svg>
                Ежемесячно
              </button>
            </div>
            <input type="hidden" class="repayment-frequency" value="once">
          </div>
          <div class="bento-early-secondary-group">
            <span class="bento-early-secondary-label">Уменьшить:</span>
            <div class="repayment-effect-toggle">
              <button type="button" class="repayment-effect-btn active" data-effect="reduce-term">
                <svg viewBox="0 0 16 16" aria-hidden="true"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M8 4v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/></svg>
                Срок
              </button>
              <button type="button" class="repayment-effect-btn" data-effect="reduce-payment">
                <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M2 13h12M4 13V7M8 13V4M12 13V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/></svg>
                Платёж
              </button>
            </div>
            <input type="hidden" class="repayment-type" value="reduce-term">
          </div>
        </div>
        <button type="button" class="bento-early-remove" title="Удалить платёж" aria-label="Удалить платёж">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      `;

      // Add event listeners
      const amountInput = div.querySelector('.repayment-amount');
      const monthSelect = div.querySelector('.repayment-month');
      const frequencyInput = div.querySelector('.repayment-frequency');
      const frequencyBtns = div.querySelectorAll('.repayment-frequency-btn');
      const removeBtn = div.querySelector('.bento-early-remove');
      const paymentNumberHint = div.querySelector('.repayment-payment-number');
      const totalPaymentHint = div.querySelector('.total-payment-hint');

      // Update payment number hint
      function updatePaymentNumberHint() {
        const selectedMonth = parseInt(monthSelect.value);
        paymentNumberHint.textContent = '№ ' + selectedMonth;
      }

      // Update total payment hint tooltip
      function updateTotalPaymentHint() {
        const enteredAmount = parseFormattedNumber(amountInput.value) || 0;
        const amountType = div.querySelector('.repayment-amount-type').value;
        const selectedMonth = parseInt(monthSelect.value) || 1;

        // Get monthly payment based on payment type and selected month
        const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
        const loanAmount = Math.max(0, propertyPrice - downPayment);

        let monthlyPayment;
        if (paymentType === 'differentiated') {
          monthlyPayment = getDifferentiatedPaymentForMonth(loanAmount, interestRate, term, selectedMonth);
        } else {
          monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        }

        if (amountType === 'total') {
          // "Полная сумма" - show breakdown: base + extra = total
          // If entered amount is less than monthly payment, total = monthly payment
          const extraPart = Math.max(0, enteredAmount - monthlyPayment);
          const actualTotal = Math.max(enteredAmount, monthlyPayment);
          if (enteredAmount > 0 && monthlyPayment > 0) {
            totalPaymentHint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(monthlyPayment)) + ' + ' + formatNumber(Math.round(extraPart)) + ' = ' + formatNumber(Math.round(actualTotal)) + ' ₽';
          } else {
            totalPaymentHint.dataset.tooltip = 'Итого за месяц: — ₽';
          }
        } else {
          // "Сверх платежа" - show breakdown: base + extra = total
          const totalForMonth = monthlyPayment + enteredAmount;
          if (enteredAmount > 0 && monthlyPayment > 0) {
            totalPaymentHint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(monthlyPayment)) + ' + ' + formatNumber(Math.round(enteredAmount)) + ' = ' + formatNumber(Math.round(totalForMonth)) + ' ₽';
          } else if (totalForMonth > 0) {
            totalPaymentHint.dataset.tooltip = 'Итого за месяц: ' + formatNumber(Math.round(totalForMonth)) + ' ₽';
          } else {
            totalPaymentHint.dataset.tooltip = 'Итого за месяц: — ₽';
          }
        }
      }

      // Validate amount for "total" mode
      const inputWrapper = div.querySelector('.bento-early-input-wrapper');
      const errorEl = div.querySelector('.bento-early-amount-error');

      function validateAmount() {
        const amountType = div.querySelector('.repayment-amount-type').value;
        if (amountType !== 'total') {
          inputWrapper.classList.remove('has-error');
          errorEl.classList.remove('visible');
          return true;
        }

        const enteredAmount = parseFormattedNumber(amountInput.value) || 0;
        if (enteredAmount === 0) {
          inputWrapper.classList.remove('has-error');
          errorEl.classList.remove('visible');
          return true;
        }

        const selectedMonth = parseInt(monthSelect.value) || 1;
        const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
        const loanAmount = Math.max(0, propertyPrice - downPayment);

        let monthlyPayment;
        if (paymentType === 'differentiated') {
          monthlyPayment = getDifferentiatedPaymentForMonth(loanAmount, interestRate, term, selectedMonth);
        } else {
          monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        }

        const isValid = enteredAmount >= monthlyPayment;
        inputWrapper.classList.toggle('has-error', !isValid);
        errorEl.classList.toggle('visible', !isValid);

        if (!isValid) {
          const minAmountEl = errorEl.querySelector('.error-min-amount');
          if (minAmountEl) {
            minAmountEl.textContent = `${formatNumber(Math.round(monthlyPayment))} ₽`;
          }
        }

        return isValid;
      }

      // Format amount on input
      amountInput.addEventListener('input', () => {
        const value = parseFormattedNumber(amountInput.value);
        if (value > 0) {
          amountInput.value = formatNumber(value);
        }
        // Clear error while typing
        inputWrapper.classList.remove('has-error');
        errorEl.classList.remove('visible');
        updateTotalPaymentHint();
        updateEarlyRepaymentData();
      });

      // Validate on blur
      amountInput.addEventListener('blur', () => {
        validateAmount();
      });

      // Listen for changes
      monthSelect.addEventListener('change', () => {
        updatePaymentNumberHint();
        updateTotalPaymentHint();
        validateAmount();
        updateEarlyRepaymentData();
      });

      // Initial update
      updatePaymentNumberHint();

      // Initialize custom dropdown for month selector
      const monthDropdown = div.querySelector('.month-dropdown');
      if (monthDropdown) {
        initMonthDropdown(monthDropdown, monthSelect);
      }

      // Initialize tooltip for sum hint
      const tooltipTrigger = div.querySelector('.total-payment-hint[data-tooltip]');
      if (tooltipTrigger) {
        initGlobalTooltip(tooltipTrigger);
      }

      // Amount type toggle (extra/total)
      const amountTypeInput = div.querySelector('.repayment-amount-type');
      const amountTypeBtns = div.querySelectorAll('.repayment-amount-type-btn');
      const amountTypeToggle = div.querySelector('.repayment-amount-type-toggle');

      amountTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          amountTypeBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          amountTypeInput.value = btn.dataset.amountType;
          // Toggle class for sliding animation
          amountTypeToggle.classList.toggle('total', btn.dataset.amountType === 'total');
          updateTotalPaymentHint();
          // Validate when switching to "total" mode
          if (btn.dataset.amountType === 'total') {
            validateAmount();
          } else {
            // Clear error when switching to "extra" mode
            inputWrapper.classList.remove('has-error');
            errorEl.classList.remove('visible');
          }
          updateEarlyRepaymentData();
        });
      });

      // Effect toggle (reduce-term/reduce-payment)
      const typeInput = div.querySelector('.repayment-type');
      const effectBtns = div.querySelectorAll('.repayment-effect-btn');
      const effectToggle = div.querySelector('.repayment-effect-toggle');

      effectBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          effectBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          typeInput.value = btn.dataset.effect;
          // Toggle class for sliding animation
          effectToggle.classList.toggle('reduce-payment', btn.dataset.effect === 'reduce-payment');
          updateEarlyRepaymentData();
        });
      });

      // Frequency toggle
      const frequencyToggle = div.querySelector('.repayment-frequency-toggle');
      frequencyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          frequencyBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          frequencyInput.value = btn.dataset.frequency;
          // Toggle class for sliding animation
          frequencyToggle.classList.toggle('monthly', btn.dataset.frequency === 'monthly');
          updateEarlyRepaymentData();
        });
      });

      // Remove button
      removeBtn.addEventListener('click', () => {
        // Check if this is the only repayment item
        const allWrappers = bentoEarlyList.querySelectorAll('.bento-early-item-wrapper:not(.removing)');

        if (allWrappers.length === 1) {
          // Reset data instead of removing
          amountInput.value = '';
          monthSelect.value = '1';

          // Sync custom dropdown with month select
          const monthDropdown = div.querySelector('.month-dropdown');
          if (monthDropdown) {
            syncMonthDropdown(monthDropdown, '1');
          }

          // Reset amount type to "extra"
          const amountTypeInput = div.querySelector('.repayment-amount-type');
          amountTypeInput.value = 'extra';
          const amountTypeBtns = div.querySelectorAll('.repayment-amount-type-btn');
          amountTypeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.amountType === 'extra');
          });
          const amountTypeToggle = div.querySelector('.repayment-amount-type-toggle');
          amountTypeToggle.classList.remove('total');

          // Clear validation error
          inputWrapper.classList.remove('has-error');
          errorEl.classList.remove('visible');

          // Reset effect to "reduce-term"
          const typeInput = div.querySelector('.repayment-type');
          typeInput.value = 'reduce-term';
          const effectBtns = div.querySelectorAll('.repayment-effect-btn');
          effectBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.effect === 'reduce-term');
          });
          const effectToggle = div.querySelector('.repayment-effect-toggle');
          effectToggle.classList.remove('reduce-payment');

          // Reset frequency to "once"
          frequencyInput.value = 'once';
          frequencyBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.frequency === 'once');
          });
          const frequencyToggle = div.querySelector('.repayment-frequency-toggle');
          frequencyToggle.classList.remove('monthly');

          // Update hints
          updatePaymentNumberHint();
          updateTotalPaymentHint();
          updateEarlyRepaymentData();
          return;
        }

        // If removing the first item, the next item will become first and should lose its gap
        const isFirstItem = !wrapper.previousElementSibling ||
          !wrapper.previousElementSibling.classList.contains('bento-early-item-wrapper');
        const nextWrapper = wrapper.nextElementSibling;

        if (isFirstItem && nextWrapper && nextWrapper.classList.contains('bento-early-item-wrapper')) {
          // Remove gap from next item so it animates smoothly as it becomes first
          nextWrapper.classList.remove('has-gap');
        }

        wrapper.classList.add('removing');
        wrapper.classList.remove('visible');

        updateEmptyState();

        setTimeout(() => {
          // Remove menu from body if it was moved there
          const monthDropdown = div.querySelector('.month-dropdown');
          if (monthDropdown && monthDropdown._menu) {
            monthDropdown._menu.remove();
          }
          wrapper.remove();
          updateWrapperGaps();
          updateEarlyRepaymentData();
        }, 300);
      });

      wrapper.appendChild(div);
      return wrapper;
    }

    // Update empty state visibility
    function updateEmptyState() {
      const items = bentoEarlyList.querySelectorAll('.bento-early-item-wrapper:not(.removing)');
      if (items.length === 0) {
        bentoEarlyEmpty.classList.add('visible');
      } else {
        bentoEarlyEmpty.classList.remove('visible');
      }
    }

    // Update gap classes on wrappers
    function updateWrapperGaps() {
      const wrappers = bentoEarlyList.querySelectorAll('.bento-early-item-wrapper.visible:not(.removing)');
      wrappers.forEach((wrapper, index) => {
        if (index > 0) {
          wrapper.classList.add('has-gap');
        } else {
          wrapper.classList.remove('has-gap');
        }
      });
    }

    // Collect repayment data from DOM
    function updateEarlyRepaymentData() {
      const wrappers = bentoEarlyList.querySelectorAll('.bento-early-item-wrapper');
      earlyRepayments = [];

      wrappers.forEach(wrapper => {
        const item = wrapper.querySelector('.bento-early-item');
        const id = parseInt(wrapper.dataset.id, 10);
        const month = parseInt(item.querySelector('.repayment-month').value, 10);
        const amount = parseFormattedNumber(item.querySelector('.repayment-amount').value);
        const amountType = item.querySelector('.repayment-amount-type').value; // 'extra' or 'total'
        const type = item.querySelector('.repayment-type').value;
        const frequency = item.querySelector('.repayment-frequency').value;

        if (amount > 0) {
          earlyRepayments.push({ id, month, amount, amountType, type, frequency });
        }
      });

      updateEarlySummary();

      // Update charts and table to reflect early repayments
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);
      updateScheduleChart(loanAmount, interestRate, term, paymentType);
      updateScheduleTable(loanAmount, interestRate, term, paymentType);

      // Save to URL and localStorage
      updateURL();
    }

    // Add a new early repayment item
    function addEarlyRepaymentItem() {
      const { term } = getValues();
      const id = repaymentIdCounter++;
      const wrapper = createRepaymentItem(id, term);

      // Check if there are existing visible wrappers
      const existingWrappers = bentoEarlyList.querySelectorAll('.bento-early-item-wrapper.visible:not(.removing)');
      const needsGap = existingWrappers.length > 0;

      bentoEarlyList.insertBefore(wrapper, bentoEarlyEmpty);
      updateEmptyState();
      // Trigger animation after DOM insertion - add both classes together
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          if (needsGap) {
            wrapper.classList.add('has-gap');
          }
          wrapper.classList.add('visible');
        });
      });
    }

    // Add repayment button click
    bentoEarlyAddBtn.addEventListener('click', addEarlyRepaymentItem);

    // Calculate early repayment effect
    function updateEarlySummary() {
      if (earlyRepayments.length === 0) {
        summaryNewTerm.textContent = '—';
        summaryTermSaved.textContent = '—';
        summaryNewInterest.textContent = '—';
        summaryInterestSaved.textContent = '—';
        summaryTotalPayment.textContent = '—';
        summaryPayoffDate.textContent = '—';
        updateBentoEarlyBadge(0);
        // Reset pie chart and hero breakdown - recalculate with no savings
        const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
        const loanAmount = Math.max(0, propertyPrice - downPayment);
        let totalInterest;
        if (paymentType === 'differentiated') {
          const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
          totalInterest = diff.totalInterest;
        } else {
          const monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
          totalInterest = monthlyPayment * term * 12 - loanAmount;
        }
        const totalPayment = loanAmount + totalInterest;
        // Reset hero breakdown to original values
        totalPaymentEl.textContent = formatNumber(Math.round(totalPayment)) + ' ₽';
        updatePieChart(loanAmount, totalPayment, totalInterest, 0);
        return;
      }

      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);
      const totalMonths = term * 12;

      // Calculate original totals (without early repayments)
      const originalSchedule = calculatePaymentSchedule(loanAmount, interestRate, term, paymentType, []);
      const originalTotalInterest = originalSchedule.reduce((sum, m) => sum + m.interest, 0);

      // Calculate with early repayments
      const newSchedule = calculatePaymentSchedule(loanAmount, interestRate, term, paymentType, earlyRepayments);
      const newTotalInterest = newSchedule.reduce((sum, m) => sum + m.interest, 0);
      const monthsUsed = newSchedule.length;

      const interestSaved = originalTotalInterest - newTotalInterest;
      const termSavedMonths = totalMonths - monthsUsed;
      const termSavedYears = Math.floor(termSavedMonths / 12);
      const termSavedRemainderMonths = termSavedMonths % 12;

      const newTermYears = Math.floor(monthsUsed / 12);
      const newTermMonths = monthsUsed % 12;

      // Update summary UI
      if (newTermMonths > 0) {
        summaryNewTerm.textContent = `${newTermYears} ${pluralizeYears(newTermYears)} ${newTermMonths} мес`;
      } else {
        summaryNewTerm.textContent = `${newTermYears} ${pluralizeYears(newTermYears)}`;
      }

      if (termSavedRemainderMonths > 0) {
        summaryTermSaved.textContent = `−${termSavedYears} ${pluralizeYears(termSavedYears)} ${termSavedRemainderMonths} мес`;
      } else if (termSavedYears > 0) {
        summaryTermSaved.textContent = `−${termSavedYears} ${pluralizeYears(termSavedYears)}`;
      } else {
        summaryTermSaved.textContent = `−${termSavedMonths} мес`;
      }

      summaryNewInterest.textContent = `${formatNumber(Math.round(newTotalInterest))} ₽`;
      summaryInterestSaved.textContent = `−${formatNumber(Math.round(interestSaved))} ₽`;

      // Calculate total payment including all early repayments
      const totalPaid = newSchedule.reduce((sum, m) => sum + m.payment, 0);
      summaryTotalPayment.textContent = `${formatNumber(Math.round(totalPaid))} ₽`;

      // Calculate payoff date
      const payoffDate = new Date(selectedYear, selectedMonth + monthsUsed, 1);
      const payoffMonthNames = ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
        'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'];
      summaryPayoffDate.textContent = `${payoffMonthNames[payoffDate.getMonth()]} ${payoffDate.getFullYear()}`;

      // Update hero breakdown with new values (accounting for early repayments)
      const newTotalPayment = loanAmount + newTotalInterest;
      totalPaymentEl.textContent = formatNumber(Math.round(newTotalPayment)) + ' ₽';

      // Update pie chart with savings
      const totalPayment = loanAmount + originalTotalInterest;
      updatePieChart(loanAmount, totalPayment, originalTotalInterest, interestSaved);

      // Update badge count
      updateBentoEarlyBadge(earlyRepayments.length);
    }

    // Schedule chart
    function updateScheduleChart(loanAmount, interestRate, term, paymentType) {
      const svg = document.getElementById('schedule-chart-svg');
      if (!svg) return;

      // Use centralized payment schedule calculation
      const monthlyData = calculatePaymentSchedule(loanAmount, interestRate, term, paymentType, earlyRepayments);

      // Group monthly data into yearly data with calendar year alignment
      const yearlyData = [];
      let currentYearData = null;
      let currentCalendarYear = selectedYear;

      monthlyData.forEach((data, index) => {
        // Calculate which calendar year this month belongs to
        const monthsSinceStart = index;
        const yearOffset = Math.floor((selectedMonth + monthsSinceStart) / 12);
        const calendarYear = selectedYear + yearOffset;

        // Start new year group if needed
        if (!currentYearData || currentYearData.actualYear !== calendarYear) {
          if (currentYearData) {
            yearlyData.push(currentYearData);
          }
          currentYearData = {
            year: yearlyData.length + 1,
            actualYear: calendarYear,
            principal: 0,
            interest: 0,
            extra: 0,
            monthlyPrincipalSum: 0,
            monthlyInterestSum: 0,
            monthCount: 0,
            balance: 0
          };
        }

        // Separate base principal from extra
        const basePrincipal = data.principal - data.extra;
        currentYearData.principal += Math.max(0, basePrincipal);
        currentYearData.extra += data.extra;
        currentYearData.interest += Math.max(0, data.interest);
        currentYearData.monthlyPrincipalSum += Math.max(0, basePrincipal);
        currentYearData.monthlyInterestSum += Math.max(0, data.interest);
        currentYearData.monthCount++;
        currentYearData.balance = Math.max(0, data.balance);
      });

      // Don't forget the last year
      if (currentYearData) {
        yearlyData.push(currentYearData);
      }

      // Calculate average monthly values for each year
      yearlyData.forEach(data => {
        data.monthlyPrincipal = data.monthCount > 0 ? Math.round(data.monthlyPrincipalSum / data.monthCount) : 0;
        data.monthlyInterest = data.monthCount > 0 ? Math.round(data.monthlyInterestSum / data.monthCount) : 0;
      });

      // Update dropdown with available years
      updateChartPeriodDropdown(yearlyData);

      // Determine what data to display based on chartViewMode
      let displayData;
      let isMonthlyView = false;
      const monthNamesShort = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];

      if (chartViewMode === 'all') {
        // Show yearly data
        displayData = yearlyData;
      } else {
        // Show monthly data for selected year
        isMonthlyView = true;
        displayData = [];

        monthlyData.forEach((data, index) => {
          const monthsSinceStart = index;
          const actualMonthIndex = (selectedMonth + monthsSinceStart) % 12;
          const yearOffset = Math.floor((selectedMonth + monthsSinceStart) / 12);
          const calendarYear = selectedYear + yearOffset;

          if (calendarYear === chartViewMode) {
            const basePrincipal = data.principal - data.extra;
            displayData.push({
              label: monthNamesShort[actualMonthIndex],
              actualMonth: actualMonthIndex,
              actualYear: calendarYear,
              principal: Math.max(0, basePrincipal),
              interest: Math.max(0, data.interest),
              extra: data.extra,
              balance: Math.max(0, data.balance),
              isMonthly: true
            });
          }
        });

        // If selected year has no data (e.g., loan was shortened), reset to 'all'
        if (displayData.length === 0) {
          chartViewMode = 'all';
          displayData = yearlyData;
          isMonthlyView = false;
          updateChartPeriodDropdown(yearlyData);
        }
      }

      // Draw chart - responsive sizing
      const container = svg.parentElement;
      const isMobile = window.innerWidth <= 600;
      const height = 240;
      const padding = { top: 20, right: 20, bottom: 40, left: 55 };

      // On mobile: fixed bar width, scrollable; on desktop: fit to container
      const mobileBarWidth = 24;
      const mobileBarGap = 8;
      const minWidthForBars = isMobile
        ? padding.left + padding.right + displayData.length * (mobileBarWidth + mobileBarGap)
        : 650;
      const containerWidth = container ? container.clientWidth : 650;
      const width = isMobile ? minWidthForBars : Math.max(containerWidth, 300);

      // Update viewBox and SVG width for scrolling
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      if (isMobile) {
        svg.style.width = width + 'px';
        svg.style.minWidth = width + 'px';
      } else {
        svg.style.width = '100%';
        svg.style.minWidth = '';
      }

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      const maxValue = Math.max(...displayData.map(d => d.principal + d.interest + (d.extra || 0)));
      const barWidth = isMobile ? mobileBarWidth : Math.min(30, (chartWidth / displayData.length) - 4);
      const barGap = isMobile ? mobileBarGap : (chartWidth - barWidth * displayData.length) / (displayData.length + 1);

      let svgContent = '';

      // Define clip path for chart area to prevent bars from overflowing
      svgContent += `
        <defs>
          <clipPath id="chart-clip">
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}"/>
          </clipPath>
        </defs>
      `;

      // Grid lines
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        svgContent += `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
        const value = formatChartNumber(Math.round(maxValue * (1 - i / 4)));
        svgContent += `<text class="chart-axis-label-y" x="${padding.left - 10}" y="${y + 4}">${value}</text>`;
      }

      // Generate bar groups with rect elements (using rect for smooth transitions)
      const radius = 3;
      displayData.forEach((data, index) => {
        const x = padding.left + barGap + index * (barWidth + barGap);
        const bottomY = padding.top + chartHeight;

        // Calculate heights, ensuring total doesn't exceed chart height
        let principalHeight = maxValue > 0 ? (data.principal / maxValue) * chartHeight : 0;
        let interestHeight = maxValue > 0 ? (data.interest / maxValue) * chartHeight : 0;
        let extraHeight = maxValue > 0 ? ((data.extra || 0) / maxValue) * chartHeight : 0;

        // Clamp total height to chart height
        const totalBarHeight = principalHeight + interestHeight + extraHeight;
        if (totalBarHeight > chartHeight) {
          const scale = chartHeight / totalBarHeight;
          principalHeight *= scale;
          interestHeight *= scale;
          extraHeight *= scale;
        }

        // Calculate Y positions from bottom to top: principal -> extra -> interest
        const principalY = bottomY - principalHeight;
        const extraY = principalY - extraHeight;
        const interestY = extraY - interestHeight;

        // Determine which section is on top and which is on bottom
        const topY = interestHeight > 0 ? interestY : (extraHeight > 0 ? extraY : principalY);
        const totalHeight = (interestHeight > 0 ? interestHeight : 0) + (extraHeight > 0 ? extraHeight : 0) + (principalHeight > 0 ? principalHeight : 0);

        // Data attributes differ for monthly vs yearly view
        const dataAttrs = isMonthlyView
          ? `data-index="${index}"
             data-is-monthly="true"
             data-actual-month="${data.actualMonth}"
             data-actual-year="${data.actualYear}"
             data-principal="${Math.round(data.principal)}"
             data-interest="${Math.round(data.interest)}"
             data-extra="${Math.round(data.extra || 0)}"
             data-balance="${Math.round(data.balance)}"`
          : `data-index="${index}"
             data-year="${data.year}"
             data-actual-year="${data.actualYear}"
             data-principal="${Math.round(data.principal)}"
             data-interest="${Math.round(data.interest)}"
             data-extra="${Math.round(data.extra || 0)}"
             data-monthly-principal="${Math.round(data.monthlyPrincipal || 0)}"
             data-monthly-interest="${Math.round(data.monthlyInterest || 0)}"
             data-balance="${Math.round(data.balance)}"`;

        svgContent += `
          <g class="chart-bar-group"
             clip-path="url(#chart-clip)"
             ${dataAttrs}>
            <defs>
              <clipPath id="bar-clip-${index}">
                <rect x="${x}" y="${topY}" width="${barWidth}" height="${totalHeight}" rx="${radius}" ry="${radius}"/>
              </clipPath>
            </defs>
            <g clip-path="url(#bar-clip-${index})">
              <rect class="chart-area-interest" x="${x}" y="${interestY}" width="${barWidth}" height="${interestHeight}" style="opacity: ${interestHeight > 0 ? 1 : 0}"/>
              <rect class="chart-area-extra" x="${x}" y="${extraY}" width="${barWidth}" height="${extraHeight}" style="opacity: ${extraHeight > 0 ? 1 : 0}"/>
              <rect class="chart-area-principal" x="${x}" y="${principalY}" width="${barWidth}" height="${principalHeight}" style="opacity: ${principalHeight > 0 ? 1 : 0}"/>
            </g>
          </g>
        `;

        // X-axis labels (months or years)
        if (isMonthlyView) {
          // For monthly view, show all month labels
          svgContent += `<text class="chart-year-label" x="${x + barWidth / 2}" y="${height - 10}">${data.label}</text>`;
        } else {
          // For yearly view, conditionally show year labels
          const actualYears = displayData.length;
          if (actualYears <= 15 || index % 2 === 0) {
            svgContent += `<text class="chart-year-label" x="${x + barWidth / 2}" y="${height - 10}">${data.year} г.</text>`;
          }
        }
      });

      // Check if we need full redraw or can update existing bars
      // Get ALL bars including those being removed - we need accurate count
      const allBars = svg.querySelectorAll('.chart-bar-group');
      // Cancel any pending removals and immediately remove bars marked for removal
      allBars.forEach(bar => {
        if (bar.dataset.removing === 'true') {
          bar.remove();
        }
      });
      // Now get the actual existing bars after cleanup
      const existingBars = svg.querySelectorAll('.chart-bar-group');
      const existingCount = existingBars.length;
      const newCount = displayData.length;
      const isFirstRender = existingCount === 0;

      // Check if view mode changed (all <-> specific year)
      const viewModeChanged = (previousChartViewMode === 'all' && chartViewMode !== 'all') ||
                              (previousChartViewMode !== 'all' && chartViewMode === 'all') ||
                              (previousChartViewMode !== 'all' && chartViewMode !== 'all' && previousChartViewMode !== chartViewMode);
      previousChartViewMode = chartViewMode;

      if (isFirstRender || viewModeChanged) {
        // First render or view mode changed - full redraw with animation
        svg.innerHTML = svgContent;
        // Add staggered animation to each bar
        const newBars = svg.querySelectorAll('.chart-bar-group');
        newBars.forEach((bar, i) => {
          bar.classList.add('animate-enter');
          bar.style.animationDelay = `${i * 0.03}s`;
          // Remove animation class after animation completes to prevent replay
          bar.addEventListener('animationend', () => {
            bar.classList.remove('animate-enter');
          }, { once: true });
        });
        // Setup tooltips for new bars
        newBars.forEach(group => setupSingleBarTooltip(group, svg));
      } else {
        // Update grid lines and axis labels first
        const oldGridLines = svg.querySelectorAll('.chart-grid-line, .chart-axis-label-y');
        oldGridLines.forEach(el => el.remove());

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (chartHeight / 4) * i;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.classList.add('chart-grid-line');
          line.setAttribute('x1', padding.left);
          line.setAttribute('y1', y);
          line.setAttribute('x2', width - padding.right);
          line.setAttribute('y2', y);
          svg.insertBefore(line, svg.firstChild.nextSibling);

          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.classList.add('chart-axis-label-y');
          text.setAttribute('x', padding.left - 10);
          text.setAttribute('y', y + 4);
          text.textContent = formatChartNumber(Math.round(maxValue * (1 - i / 4)));
          svg.insertBefore(text, svg.firstChild.nextSibling);
        }

        // Update axis labels (months or years)
        const oldYearLabels = svg.querySelectorAll('.chart-year-label');
        oldYearLabels.forEach(el => el.remove());

        displayData.forEach((data, index) => {
          const x = padding.left + barGap + index * (barWidth + barGap);
          if (isMonthlyView) {
            // Show all month labels
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.classList.add('chart-year-label');
            text.setAttribute('x', x + barWidth / 2);
            text.setAttribute('y', height - 10);
            text.textContent = data.label;
            svg.appendChild(text);
          } else if (displayData.length <= 15 || index % 2 === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.classList.add('chart-year-label');
            text.setAttribute('x', x + barWidth / 2);
            text.setAttribute('y', height - 10);
            text.textContent = `${data.year} г.`;
            svg.appendChild(text);
          }
        });

        // Handle bar additions/removals/updates
        if (newCount > existingCount) {
          // Adding bars - update existing and add new ones
          existingBars.forEach((group, index) => {
            updateBarGroup(group, displayData[index], index, padding, barGap, barWidth, chartHeight, maxValue, isMonthlyView);
          });

          // Add new bars with animation
          for (let i = existingCount; i < newCount; i++) {
            const data = displayData[i];
            const x = padding.left + barGap + i * (barWidth + barGap);
            const bottomY = padding.top + chartHeight;

            let principalHeight = maxValue > 0 ? (data.principal / maxValue) * chartHeight : 0;
            let interestHeight = maxValue > 0 ? (data.interest / maxValue) * chartHeight : 0;
            let extraHeight = maxValue > 0 ? ((data.extra || 0) / maxValue) * chartHeight : 0;

            const totalBarHeight = principalHeight + interestHeight + extraHeight;
            if (totalBarHeight > chartHeight) {
              const scale = chartHeight / totalBarHeight;
              principalHeight *= scale;
              interestHeight *= scale;
              extraHeight *= scale;
            }

            const principalY = bottomY - principalHeight;
            const extraY = principalY - extraHeight;
            const interestY = extraY - interestHeight;

            // Determine which section is on top
            const topY = interestHeight > 0 ? interestY : (extraHeight > 0 ? extraY : principalY);
            const totalHeight = (interestHeight > 0 ? interestHeight : 0) + (extraHeight > 0 ? extraHeight : 0) + (principalHeight > 0 ? principalHeight : 0);

            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('chart-bar-group', 'animate-enter');
            group.setAttribute('clip-path', 'url(#chart-clip)');
            group.setAttribute('data-index', i);
            if (isMonthlyView) {
              group.setAttribute('data-is-monthly', 'true');
              group.setAttribute('data-actual-month', data.actualMonth);
              group.setAttribute('data-actual-year', data.actualYear);
            } else {
              group.setAttribute('data-year', data.year);
              group.setAttribute('data-actual-year', data.actualYear);
              group.setAttribute('data-monthly-principal', Math.round(data.monthlyPrincipal || 0));
              group.setAttribute('data-monthly-interest', Math.round(data.monthlyInterest || 0));
            }
            group.setAttribute('data-principal', Math.round(data.principal));
            group.setAttribute('data-interest', Math.round(data.interest));
            group.setAttribute('data-extra', Math.round(data.extra || 0));
            group.setAttribute('data-balance', Math.round(data.balance));
            group.style.animationDelay = `${(i - existingCount) * 0.03}s`;

            // Create clip path for rounded corners on the whole bar
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
            clipPath.setAttribute('id', `bar-clip-${i}`);
            const clipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            clipRect.setAttribute('x', x);
            clipRect.setAttribute('y', topY);
            clipRect.setAttribute('width', barWidth);
            clipRect.setAttribute('height', totalHeight);
            clipRect.setAttribute('rx', radius);
            clipRect.setAttribute('ry', radius);
            clipPath.appendChild(clipRect);
            defs.appendChild(clipPath);
            group.appendChild(defs);

            // Create inner group with clip
            const innerGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            innerGroup.setAttribute('clip-path', `url(#bar-clip-${i})`);

            const interestRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            interestRect.classList.add('chart-area-interest');
            interestRect.setAttribute('x', x);
            interestRect.setAttribute('y', interestY);
            interestRect.setAttribute('width', barWidth);
            interestRect.setAttribute('height', interestHeight);
            interestRect.style.opacity = interestHeight > 0 ? 1 : 0;

            const extraRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            extraRect.classList.add('chart-area-extra');
            extraRect.setAttribute('x', x);
            extraRect.setAttribute('y', extraY);
            extraRect.setAttribute('width', barWidth);
            extraRect.setAttribute('height', extraHeight);
            extraRect.style.opacity = extraHeight > 0 ? 1 : 0;

            const principalRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            principalRect.classList.add('chart-area-principal');
            principalRect.setAttribute('x', x);
            principalRect.setAttribute('y', principalY);
            principalRect.setAttribute('width', barWidth);
            principalRect.setAttribute('height', principalHeight);
            principalRect.style.opacity = principalHeight > 0 ? 1 : 0;

            innerGroup.appendChild(interestRect);
            innerGroup.appendChild(extraRect);
            innerGroup.appendChild(principalRect);
            group.appendChild(innerGroup);

            // Insert before year labels
            const firstYearLabel = svg.querySelector('.chart-year-label');
            if (firstYearLabel) {
              svg.insertBefore(group, firstYearLabel);
            } else {
              svg.appendChild(group);
            }

            // Remove animation class after animation completes to prevent replay
            group.addEventListener('animationend', () => {
              group.classList.remove('animate-enter');
            }, { once: true });

            // Setup tooltip for new bar
            setupSingleBarTooltip(group, svg);
          }
        } else if (newCount < existingCount) {
          // Cancel any pending update from previous removal
          if (chartUpdateTimeoutId) {
            clearTimeout(chartUpdateTimeoutId);
            chartUpdateTimeoutId = null;
          }

          // Removing bars - animate out extras, then update remaining
          const barsToRemove = Array.from(existingBars).slice(newCount);

          // First, animate out the bars being removed
          barsToRemove.forEach((bar) => {
            bar.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            bar.style.transformOrigin = 'center bottom';
            bar.style.transformBox = 'fill-box';
            bar.style.transform = 'scaleY(0)';
            bar.style.opacity = '0';
            // Mark for removal to skip in future updates
            bar.dataset.removing = 'true';
            setTimeout(() => bar.remove(), 300);
          });

          // Update remaining bars immediately (skip those being removed)
          const remainingBars = Array.from(existingBars).slice(0, newCount);
          remainingBars.forEach((group, index) => {
            updateBarGroup(group, displayData[index], index, padding, barGap, barWidth, chartHeight, maxValue, isMonthlyView);
          });
        } else {
          // Same count - just update positions and heights
          existingBars.forEach((group, index) => {
            updateBarGroup(group, displayData[index], index, padding, barGap, barWidth, chartHeight, maxValue, isMonthlyView);
          });
        }
      }

      function updateBarGroup(group, data, index, padding, barGap, barWidth, chartHeight, maxValue, isMonthlyView = false) {
        const x = padding.left + barGap + index * (barWidth + barGap);
        const bottomY = padding.top + chartHeight;
        const radius = 3;

        let principalHeight = maxValue > 0 ? (data.principal / maxValue) * chartHeight : 0;
        let interestHeight = maxValue > 0 ? (data.interest / maxValue) * chartHeight : 0;
        let extraHeight = maxValue > 0 ? ((data.extra || 0) / maxValue) * chartHeight : 0;

        const totalBarHeight = principalHeight + interestHeight + extraHeight;
        if (totalBarHeight > chartHeight) {
          const scale = chartHeight / totalBarHeight;
          principalHeight *= scale;
          interestHeight *= scale;
          extraHeight *= scale;
        }

        const principalY = bottomY - principalHeight;
        const extraY = principalY - extraHeight;
        const interestY = extraY - interestHeight;

        // Determine top of the bar for clip path
        const topY = interestHeight > 0 ? interestY : (extraHeight > 0 ? extraY : principalY);
        const totalHeight = (interestHeight > 0 ? interestHeight : 0) + (extraHeight > 0 ? extraHeight : 0) + (principalHeight > 0 ? principalHeight : 0);

        // Update data attributes
        if (isMonthlyView) {
          group.dataset.isMonthly = 'true';
          group.dataset.actualMonth = data.actualMonth;
          group.dataset.actualYear = data.actualYear;
          delete group.dataset.year;
          delete group.dataset.monthlyPrincipal;
          delete group.dataset.monthlyInterest;
        } else {
          delete group.dataset.isMonthly;
          delete group.dataset.actualMonth;
          group.dataset.year = data.year;
          group.dataset.actualYear = data.actualYear;
          group.dataset.monthlyPrincipal = Math.round(data.monthlyPrincipal || 0);
          group.dataset.monthlyInterest = Math.round(data.monthlyInterest || 0);
        }
        group.dataset.principal = Math.round(data.principal);
        group.dataset.interest = Math.round(data.interest);
        group.dataset.extra = Math.round(data.extra || 0);
        group.dataset.balance = Math.round(data.balance);

        // Update clip path rect
        const clipRect = group.querySelector('clipPath rect');
        if (clipRect) {
          clipRect.setAttribute('x', x);
          clipRect.setAttribute('y', topY);
          clipRect.setAttribute('width', barWidth);
          clipRect.setAttribute('height', totalHeight);
        }

        // Update rect elements
        const interestRect = group.querySelector('.chart-area-interest');
        const extraRect = group.querySelector('.chart-area-extra');
        const principalRect = group.querySelector('.chart-area-principal');

        if (interestRect) {
          interestRect.setAttribute('x', x);
          interestRect.setAttribute('y', interestY);
          interestRect.setAttribute('width', barWidth);
          interestRect.setAttribute('height', interestHeight);
          interestRect.style.opacity = interestHeight > 0 ? 1 : 0;
        }
        if (extraRect) {
          extraRect.setAttribute('x', x);
          extraRect.setAttribute('y', extraY);
          extraRect.setAttribute('width', barWidth);
          extraRect.setAttribute('height', extraHeight);
          extraRect.style.opacity = extraHeight > 0 ? 1 : 0;
        }
        if (principalRect) {
          principalRect.setAttribute('x', x);
          principalRect.setAttribute('y', principalY);
          principalRect.setAttribute('width', barWidth);
          principalRect.setAttribute('height', principalHeight);
          principalRect.style.opacity = principalHeight > 0 ? 1 : 0;
        }
      }

      function setupSingleBarTooltip(group, svg) {
        const tooltip = document.getElementById('chart-tooltip');

        group.addEventListener('mouseenter', (e) => {
          const isMonthly = group.dataset.isMonthly === 'true';
          const principal = parseInt(group.dataset.principal);
          const interest = parseInt(group.dataset.interest);
          const extra = parseInt(group.dataset.extra) || 0;
          const balance = parseInt(group.dataset.balance);

          let extraRow = '';
          if (extra > 0) {
            extraRow = `
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Досрочно:</span>
                <span class="chart-tooltip-value extra">${formatNumber(extra)} ₽</span>
              </div>
            `;
          }

          if (isMonthly) {
            // Monthly view tooltip
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const actualMonth = parseInt(group.dataset.actualMonth);
            const actualYear = group.dataset.actualYear;
            const monthName = monthNames[actualMonth];

            tooltip.innerHTML = `
              <div class="chart-tooltip-title">${monthName} ${actualYear}</div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Основной долг:</span>
                <span class="chart-tooltip-value principal">${formatNumber(principal)} ₽</span>
              </div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Проценты:</span>
                <span class="chart-tooltip-value interest">${formatNumber(interest)} ₽</span>
              </div>
              ${extraRow}
              <div class="chart-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.15);">
                <span class="chart-tooltip-label">Платёж:</span>
                <span class="chart-tooltip-value">${formatNumber(principal + interest + extra)} ₽</span>
              </div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Остаток долга:</span>
                <span class="chart-tooltip-value">${formatNumber(balance)} ₽</span>
              </div>
            `;
          } else {
            // Yearly view tooltip
            const actualYear = group.dataset.actualYear;

            tooltip.innerHTML = `
              <div class="chart-tooltip-title">${actualYear} год</div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Основной долг:</span>
                <span class="chart-tooltip-value principal">${formatNumber(principal)} ₽</span>
              </div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Проценты:</span>
                <span class="chart-tooltip-value interest">${formatNumber(interest)} ₽</span>
              </div>
              ${extraRow}
              <div class="chart-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.15);">
                <span class="chart-tooltip-label">Платёж за год:</span>
                <span class="chart-tooltip-value">${formatNumber(principal + interest + extra)} ₽</span>
              </div>
              <div class="chart-tooltip-row">
                <span class="chart-tooltip-label">Остаток долга:</span>
                <span class="chart-tooltip-value">${formatNumber(balance)} ₽</span>
              </div>
            `;
          }
          tooltip.classList.add('visible');
        });

        group.addEventListener('mousemove', (e) => {
          const tooltipWidth = tooltip.offsetWidth || 150;
          const tooltipHeight = tooltip.offsetHeight || 80;

          let left = e.clientX + 10;
          let top = e.clientY - 10;

          // Keep tooltip within viewport
          if (left + tooltipWidth > window.innerWidth) {
            left = e.clientX - tooltipWidth - 10;
          }
          if (top - tooltipHeight < 0) {
            top = e.clientY + 20;
          }

          tooltip.style.left = left + 'px';
          tooltip.style.top = top + 'px';
        });

        group.addEventListener('mouseleave', () => {
          tooltip.classList.remove('visible');
        });
      }

      // Note: Tooltips are setup in the isFirstRender || viewModeChanged block above
    }

    // Chart period dropdown logic
    function updateChartPeriodDropdown(yearlyData) {
      const menu = document.getElementById('chart-period-menu');
      const textEl = document.getElementById('chart-period-text');
      if (!menu) return;

      // Store available years
      chartAvailableYears = yearlyData.map(d => d.actualYear);

      // Build menu HTML
      let html = `
        <div class="chart-period-option${chartViewMode === 'all' ? ' selected' : ''}" data-value="all" role="option">
          <span>За все годы</span>
          <svg class="chart-period-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
      `;

      if (chartAvailableYears.length > 1) {
        html += '<div class="chart-period-divider"></div>';
        html += '<div class="chart-period-section-label">По месяцам</div>';

        chartAvailableYears.forEach(year => {
          const isSelected = chartViewMode === year;
          html += `
            <div class="chart-period-option${isSelected ? ' selected' : ''}" data-value="${year}" role="option">
              <span>${year} год</span>
              <svg class="chart-period-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          `;
        });
      }

      menu.innerHTML = html;

      // Update trigger text
      if (chartViewMode === 'all') {
        textEl.textContent = 'Выплаты за все годы';
      } else {
        textEl.textContent = `Выплаты за ${chartViewMode} год`;
      }
    }

    // Handle chart period option selection (event delegation)
    function handleChartPeriodOptionClick(e) {
      const option = e.target.closest('.chart-period-option');
      if (!option) return;

      e.stopPropagation(); // Prevent document click handler from closing dropdown immediately

      const value = option.dataset.value;
      const newMode = value === 'all' ? 'all' : parseInt(value);

      // Only update if mode actually changed
      if (newMode === chartViewMode) {
        closeChartPeriodDropdown();
        return;
      }

      chartViewMode = newMode;
      closeChartPeriodDropdown();

      // Save state to URL and localStorage
      updateURL();

      // Recalculate and redraw chart
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);
      updateScheduleChart(loanAmount, interestRate, term, paymentType);
    }

    function toggleChartPeriodDropdown() {
      const dropdown = document.getElementById('chart-period-dropdown');
      const trigger = document.getElementById('chart-period-trigger');
      if (dropdown.classList.contains('open')) {
        closeChartPeriodDropdown();
      } else {
        dropdown.classList.add('open');
        trigger.setAttribute('aria-expanded', 'true');
      }
    }

    function closeChartPeriodDropdown() {
      const dropdown = document.getElementById('chart-period-dropdown');
      const trigger = document.getElementById('chart-period-trigger');
      dropdown.classList.remove('open');
      trigger.setAttribute('aria-expanded', 'false');
    }

    // Setup chart period dropdown event listeners
    document.getElementById('chart-period-trigger')?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleChartPeriodDropdown();
    });

    // Event delegation for menu options
    document.getElementById('chart-period-menu')?.addEventListener('click', handleChartPeriodOptionClick);

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('chart-period-dropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        closeChartPeriodDropdown();
      }
    });

    // Schedule table
    let currentView = 'yearly';

    function updateScheduleTable(loanAmount, interestRate, term, paymentType) {
      const tbody = document.getElementById('schedule-table-body');
      if (!tbody) return;

      // Use centralized payment schedule calculation
      const monthlyData = calculatePaymentSchedule(loanAmount, interestRate, term, paymentType, earlyRepayments);

      let html = '';

      if (currentView === 'yearly') {
        // Group by calendar year, accounting for start month
        const yearlyData = [];
        let currentYearData = null;
        let currentCalendarYear = selectedYear;

        monthlyData.forEach((data, index) => {
          // Calculate which calendar year this month belongs to
          const monthsSinceStart = index;
          const actualMonthIndex = (selectedMonth + monthsSinceStart) % 12;
          const yearOffset = Math.floor((selectedMonth + monthsSinceStart) / 12);
          const calendarYear = selectedYear + yearOffset;

          // Start new year group if needed
          if (!currentYearData || currentYearData.actualYear !== calendarYear) {
            if (currentYearData) {
              yearlyData.push(currentYearData);
            }
            currentYearData = {
              actualYear: calendarYear,
              payment: 0,
              principal: 0,
              interest: 0,
              balance: 0
            };
          }

          currentYearData.payment += data.payment;
          currentYearData.principal += data.principal;
          currentYearData.interest += data.interest;
          currentYearData.balance = data.balance;
        });

        // Don't forget the last year
        if (currentYearData) {
          yearlyData.push(currentYearData);
        }

        yearlyData.forEach(data => {
          html += `
            <tr>
              <td>${data.actualYear}</td>
              <td>${formatNumber(Math.max(0, data.payment))} ₽</td>
              <td class="principal-cell">${formatNumber(Math.max(0, data.principal))} ₽</td>
              <td class="interest-cell">${formatNumber(Math.max(0, data.interest))} ₽</td>
              <td class="balance-cell">${formatNumber(Math.max(0, data.balance))} ₽</td>
            </tr>
          `;
        });
      } else {
        const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

        monthlyData.forEach(data => {
          const yearOffset = Math.floor((selectedMonth + data.month - 1) / 12);
          const actualYear = selectedYear + yearOffset;
          const monthIndex = (selectedMonth + data.month - 1) % 12;
          const monthName = months[monthIndex];

          html += `
            <tr>
              <td>${monthName} ${actualYear}</td>
              <td>${formatNumber(data.payment)} ₽</td>
              <td class="principal-cell">${formatNumber(data.principal)} ₽</td>
              <td class="interest-cell">${formatNumber(data.interest)} ₽</td>
              <td class="balance-cell">${formatNumber(data.balance)} ₽</td>
            </tr>
          `;
        });
      }

      tbody.innerHTML = html;
    }

    // View toggle
    const viewToggle = document.querySelector('.schedule-view-toggle');
    const viewButtons = document.querySelectorAll('.view-toggle-btn');

    viewButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentView = btn.dataset.view;
        viewButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (currentView === 'monthly') {
          viewToggle.classList.add('monthly-view');
        } else {
          viewToggle.classList.remove('monthly-view');
        }

        const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
        const loanAmount = Math.max(0, propertyPrice - downPayment);
        updateScheduleTable(loanAmount, interestRate, term, paymentType);
      });
    });

    // Table resize
    const tableContainer = document.getElementById('schedule-table-container');
    const resizeHandle = document.getElementById('table-resize-handle');
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;
    let manualResizeActive = false;
    let lastSoundHeight = 0;
    const resizeSoundStep = 30;

    // Audio for table resize feedback
    let audioContext = null;
    let audioInitialized = false;

    function initAudio() {
      if (audioInitialized) return;
      audioInitialized = true;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      } catch (e) {
        console.log('Web Audio not supported');
      }
    }

    // Initialize audio on first user interaction
    document.addEventListener('touchstart', initAudio, { once: true, passive: true });
    document.addEventListener('mousedown', initAudio, { once: true });

    function playResizeSound(direction) {
      if (!audioContext) return;
      try {
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        const now = audioContext.currentTime;
        oscillator.type = 'sine';
        const freq = direction === 'expand' ? 1400 : 1100;
        oscillator.frequency.setValueAtTime(freq, now);

        gainNode.gain.setValueAtTime(0.03, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.025);

        oscillator.start(now);
        oscillator.stop(now + 0.025);
      } catch (e) {
        // Audio error
      }
    }

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      manualResizeActive = true;
      startY = e.clientY;
      startHeight = tableContainer.offsetHeight;
      lastSoundHeight = startHeight;
      resizeHandle.classList.add('dragging');
      document.body.style.cursor = 'ns-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const diff = e.clientY - startY;
      const maxAllowedHeight = Math.min(800, tableContainer.scrollHeight);
      const newHeight = Math.max(450, Math.min(maxAllowedHeight, startHeight + diff));
      tableContainer.style.minHeight = newHeight + 'px';
      tableContainer.style.maxHeight = newHeight + 'px';

      const heightDiff = newHeight - lastSoundHeight;
      if (Math.abs(heightDiff) >= resizeSoundStep) {
        playResizeSound(heightDiff > 0 ? 'expand' : 'collapse');
        lastSoundHeight = newHeight;
      }
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
      resizeHandle.classList.remove('dragging');
      document.body.style.cursor = '';
    });

    // Sync schedule table height with bento-early height
    const bentoEarlyCard = document.getElementById('bento-early');
    const scheduleTableHeader = document.querySelector('.bento-schedule .schedule-table-header');
    const scheduleTableResizeHandle = document.querySelector('.bento-schedule .schedule-table-resize-handle');

    function syncTableHeight() {
      if (!bentoEarlyCard || !tableContainer || manualResizeActive) return;
      const earlyHeight = bentoEarlyCard.offsetHeight;
      const headerHeight = scheduleTableHeader ? scheduleTableHeader.offsetHeight : 0;
      const handleHeight = scheduleTableResizeHandle ? scheduleTableResizeHandle.offsetHeight : 0;
      const padding = 32; // var(--space-lg) top + bottom
      const newHeight = Math.max(450, earlyHeight - headerHeight - handleHeight - padding);
      tableContainer.style.minHeight = newHeight + 'px';
      tableContainer.style.maxHeight = newHeight + 'px';

      // Hide resize handle if table content fits without scrolling
      if (resizeHandle) {
        const hasOverflow = tableContainer.scrollHeight > tableContainer.clientHeight;
        resizeHandle.style.display = hasOverflow ? '' : 'none';
      }
    }

    const earlyResizeObserver = new ResizeObserver(syncTableHeight);
    if (bentoEarlyCard) {
      earlyResizeObserver.observe(bentoEarlyCard);
    }

    // ===== DOWNLOAD IMAGE =====
    const downloadBtn = document.getElementById('download-btn');

    function formatShortAmount(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace('.0', '') + ' млн';
      } else if (num >= 1000) {
        return Math.round(num / 1000) + ' тыс';
      }
      return Math.round(num).toString();
    }

    function generateScheduleData(principal, annualRate, years, paymentType) {
      const monthlyRate = annualRate / 100 / 12;
      const totalMonths = years * 12;
      const schedule = [];
      let balance = principal;

      if (paymentType === 'annuity') {
        const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / (Math.pow(1 + monthlyRate, totalMonths) - 1);

        for (let month = 1; month <= totalMonths; month++) {
          const interestPayment = balance * monthlyRate;
          const principalPayment = monthlyPayment - interestPayment;
          balance = Math.max(0, balance - principalPayment);
          schedule.push({ month, year: Math.ceil(month / 12), payment: monthlyPayment, principal: principalPayment, interest: interestPayment, balance });
        }
      } else {
        const principalPart = principal / totalMonths;
        for (let month = 1; month <= totalMonths; month++) {
          const interestPayment = balance * monthlyRate;
          const payment = principalPart + interestPayment;
          balance = Math.max(0, balance - principalPart);
          schedule.push({ month, year: Math.ceil(month / 12), payment, principal: principalPart, interest: interestPayment, balance });
        }
      }
      return schedule;
    }

    function aggregateByYear(schedule) {
      const years = {};
      schedule.forEach(item => {
        if (!years[item.year]) {
          years[item.year] = { year: item.year, payment: 0, principal: 0, interest: 0, balance: 0, monthCount: 0 };
        }
        years[item.year].payment += item.payment;
        years[item.year].principal += item.principal;
        years[item.year].interest += item.interest;
        years[item.year].balance = item.balance;
        years[item.year].monthCount++;
      });
      return Object.values(years);
    }

    function generateImage() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);
      const monthlyRate = interestRate / 100 / 12;
      const months = term * 12;

      let monthlyPayment, totalPayment, totalInterest, paymentLabel;

      if (paymentType === 'annuity') {
        monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        totalPayment = monthlyPayment * months;
        totalInterest = totalPayment - loanAmount;
        paymentLabel = 'Аннуитетный платёж';
      } else {
        const principalPart = loanAmount / months;
        let total = 0;
        let balance = loanAmount;
        for (let i = 0; i < months; i++) {
          total += principalPart + balance * monthlyRate;
          balance -= principalPart;
        }
        totalPayment = total;
        totalInterest = totalPayment - loanAmount;
        monthlyPayment = loanAmount / months + loanAmount * monthlyRate;
        paymentLabel = 'Дифференцированный платёж';
      }

      // Calculate optimal payment data if term > 15
      let optimalData = null;
      if (term > 15 && loanAmount > 0 && interestRate > 0) {
        const annuityOptimalPayment = calculateAnnuityPayment(loanAmount, interestRate, 15);
        const annuityOptimalTotal = annuityOptimalPayment * 15 * 12;
        const annuityOptimalInterest = annuityOptimalTotal - loanAmount;

        if (paymentType === 'differentiated') {
          const optimalDiff = calculateDifferentiatedPayment(loanAmount, interestRate, 15);
          optimalData = {
            payment: optimalDiff.first,
            savings: totalInterest - optimalDiff.totalInterest,
            yearsSaved: term - 15,
            extraPayment: optimalDiff.first - monthlyPayment
          };
        } else {
          optimalData = {
            payment: annuityOptimalPayment,
            savings: totalInterest - annuityOptimalInterest,
            yearsSaved: term - 15,
            extraPayment: annuityOptimalPayment - monthlyPayment
          };
        }
      }

      const principalPercent = totalPayment > 0 ? (loanAmount / totalPayment) * 100 : 0;
      const interestPercent = 100 - principalPercent;

      const colors = {
        cream: '#FDF8F3',
        creamDark: '#F5EDE4',
        terracotta: '#C65D3B',
        terracottaLight: '#E07B5A',
        forest: '#2D4A3E',
        charcoal: '#2C2C2C',
        warmGray: '#6B6560',
        gold: '#D4A03C',
        goldLight: '#F0C864'
      };

      const schedule = generateScheduleData(loanAmount, interestRate, term, paymentType);
      const yearlyData = aggregateByYear(schedule);
      const chartData = yearlyData.map(d => ({
        year: d.year,
        principal: d.principal / 12,
        interest: d.interest / 12,
        total: (d.principal + d.interest) / 12
      }));

      const width = 600;
      const sidePadding = 30;
      const headerHeight = 180;
      const summaryHeight = 200;
      const detailsCount = 5;
      const detailLineHeight = 36;
      const chartBarHeight = 220;
      const pieRadius = 55;
      const pieRingWidth = 16;

      const detailsHeight = detailsCount * detailLineHeight + 50;
      const optimalSectionHeight = optimalData ? 100 : 0;
      const dividerSpace = 50;
      const chartTitleHeight = 30;
      const chartLegendHeight = 55;
      const footerHeight = 60;
      const bottomPadding = 30;

      const height = headerHeight + summaryHeight + detailsHeight + optimalSectionHeight + dividerSpace + chartTitleHeight + chartBarHeight + chartLegendHeight + footerHeight + bottomPadding;

      const canvas = document.createElement('canvas');
      const scale = 2;
      canvas.width = width * scale;
      canvas.height = height * scale;
      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);

      // Background
      ctx.fillStyle = colors.cream;
      ctx.fillRect(0, 0, width, height);

      // Header
      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(0, 0, width, headerHeight, [0, 0, 24, 24]);
      ctx.fill();

      ctx.fillStyle = 'white';
      ctx.font = 'bold 22px system-ui, -apple-system, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Расчёт ипотеки', width / 2, 45);

      ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';
      ctx.fillText(formatNumber(Math.round(monthlyPayment)) + ' ₽/мес', width / 2, 110);

      ctx.font = '14px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
      ctx.fillText(paymentLabel, width / 2, 145);

      // Summary with pie chart
      let y = headerHeight + 35;
      const pieCenterX = sidePadding + 70;
      const pieCenterY = y + pieRadius + 10;

      ctx.beginPath();
      ctx.arc(pieCenterX, pieCenterY, pieRadius, 0, Math.PI * 2);
      ctx.strokeStyle = colors.terracottaLight;
      ctx.lineWidth = pieRingWidth;
      ctx.stroke();

      const principalAngle = (principalPercent / 100) * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(pieCenterX, pieCenterY, pieRadius, -Math.PI / 2, -Math.PI / 2 + principalAngle);
      ctx.strokeStyle = colors.forest;
      ctx.lineWidth = pieRingWidth;
      ctx.stroke();

      const summaryX = sidePadding + 160;
      ctx.textAlign = 'left';
      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Всего выплатите за\u00A0' + term + '\u00A0' + pluralizeYears(term), summaryX, y + 15);

      ctx.font = 'bold 28px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.fillText(formatNumber(Math.round(totalPayment)) + ' ₽', summaryX, y + 55);

      const col1X = summaryX;
      const col2X = summaryX + 170;
      const rowY = y + 95;

      // Principal
      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(col1X, rowY, 14, 14, 3);
      ctx.fill();

      ctx.font = '12px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Тело кредита', col1X + 20, rowY + 11);

      ctx.font = 'bold 18px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.fillText(formatNumber(loanAmount) + ' ₽', col1X, rowY + 38);

      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.forest;
      ctx.fillText(principalPercent.toFixed(1) + '%', col1X, rowY + 58);

      // Interest
      ctx.fillStyle = colors.terracottaLight;
      ctx.beginPath();
      ctx.roundRect(col2X, rowY, 14, 14, 3);
      ctx.fill();

      ctx.font = '12px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Переплата', col2X + 20, rowY + 11);

      ctx.font = 'bold 18px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.terracotta;
      ctx.fillText(formatNumber(Math.round(totalInterest)) + ' ₽', col2X, rowY + 38);

      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.terracottaLight;
      ctx.fillText(interestPercent.toFixed(1) + '%', col2X, rowY + 58);

      // Details
      y = headerHeight + summaryHeight + 15;

      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(sidePadding, y);
      ctx.lineTo(width - sidePadding, y);
      ctx.stroke();

      y += 35;

      const details = [
        ['Стоимость недвижимости', formatNumber(propertyPrice) + ' ₽'],
        ['Первоначальный взнос', formatNumber(downPayment) + ' ₽ (' + Math.round(downPayment / propertyPrice * 100) + '%)'],
        ['Сумма кредита', formatNumber(loanAmount) + ' ₽'],
        ['Процентная ставка', interestRate + '% годовых'],
        ['Срок кредита', term + ' ' + pluralizeYears(term) + ' (' + (term * 12) + ' мес.)'],
      ];

      details.forEach(([label, value]) => {
        ctx.font = '15px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'left';
        ctx.fillText(label, sidePadding, y);

        ctx.font = 'bold 15px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.charcoal;
        ctx.textAlign = 'right';
        ctx.fillText(value, width - sidePadding, y);

        y += detailLineHeight;
      });

      // Optimal payment section
      if (optimalData) {
        y += 15;

        // Separator line
        ctx.strokeStyle = colors.creamDark;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sidePadding, y);
        ctx.lineTo(width - sidePadding, y);
        ctx.stroke();

        y += 25;

        // Title
        ctx.font = '13px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'left';
        ctx.fillText('💡 Оптимальный платёж для закрытия за\u00A015\u00A0лет', sidePadding, y);

        y += 28;

        // Main payment amount
        ctx.font = 'bold 22px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.charcoal;
        ctx.fillText(formatNumber(Math.round(optimalData.payment)) + ' ₽/мес', sidePadding, y);

        // Extra payment on the right
        ctx.font = '13px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'right';
        ctx.fillText('+' + formatNumber(Math.round(optimalData.extraPayment)) + ' ₽ к\u00A0текущему', width - sidePadding, y);

        y += 22;

        // Savings
        ctx.font = '13px system-ui, -apple-system, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillStyle = colors.forest;
        const savingsText = 'Экономия: ' + formatNumber(Math.round(optimalData.savings)) + ' ₽';
        ctx.fillText(savingsText, sidePadding, y);

        // Time saved
        ctx.fillStyle = colors.warmGray;
        const savingsWidth = ctx.measureText(savingsText).width;
        ctx.fillText('   •   Срок: −' + optimalData.yearsSaved + ' ' + pluralizeYears(optimalData.yearsSaved), sidePadding + savingsWidth, y);
      }

      // Chart
      y += 20;
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(sidePadding, y);
      ctx.lineTo(width - sidePadding, y);
      ctx.stroke();

      y += 30;
      ctx.font = 'bold 16px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.textAlign = 'left';
      // Use dynamic title based on current chart view mode
      const chartTitle = chartViewMode === 'all' ? 'Выплаты за\u00A0все\u00A0годы' : `Выплаты за\u00A0${chartViewMode}\u00A0год`;
      ctx.fillText(chartTitle, sidePadding, y);

      const chartMargin = { left: 70, right: sidePadding, top: y + 25, bottom: 50 };
      const chartWidth = width - chartMargin.left - chartMargin.right;

      const maxPayment = Math.max(...chartData.map(d => d.total));
      const yAxisMax = Math.ceil(maxPayment / 10000) * 10000;

      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const lineY = chartMargin.top + chartBarHeight - (chartBarHeight * i / 4);
        ctx.beginPath();
        ctx.moveTo(chartMargin.left, lineY);
        ctx.lineTo(width - chartMargin.right, lineY);
        ctx.stroke();

        const labelValue = (yAxisMax / 4) * i;
        ctx.font = '11px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'right';
        ctx.fillText(formatShortAmount(labelValue), chartMargin.left - 8, lineY + 4);
      }

      const numBars = chartData.length;
      const barWidth = chartWidth / numBars;
      const barPadding = barWidth * 0.15;

      chartData.forEach((data, i) => {
        const x = chartMargin.left + i * barWidth + barPadding;
        const rectWidth = barWidth - barPadding * 2;

        const principalHeight = (data.principal / yAxisMax) * chartBarHeight;
        const interestHeight = (data.interest / yAxisMax) * chartBarHeight;

        const principalY = chartMargin.top + chartBarHeight - principalHeight;
        const interestY = principalY - interestHeight;

        ctx.fillStyle = colors.terracottaLight;
        ctx.beginPath();
        ctx.roundRect(x, interestY, rectWidth, interestHeight, [3, 3, 0, 0]);
        ctx.fill();

        ctx.fillStyle = colors.forest;
        ctx.beginPath();
        ctx.roundRect(x, principalY, rectWidth, principalHeight, [0, 0, 3, 3]);
        ctx.fill();

        const showLabel = numBars <= 15 || i % Math.ceil(numBars / 10) === 0 || i === numBars - 1;
        if (showLabel) {
          ctx.font = '11px system-ui, -apple-system, sans-serif';
          ctx.fillStyle = colors.warmGray;
          ctx.textAlign = 'center';
          ctx.fillText(data.year, x + rectWidth / 2, chartMargin.top + chartBarHeight + 18);
        }
      });

      // Legend
      const legendY = chartMargin.top + chartBarHeight + 45;
      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.textAlign = 'left';

      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(width / 2 - 140, legendY - 10, 14, 14, 3);
      ctx.fill();
      ctx.fillStyle = colors.charcoal;
      ctx.fillText('Основной долг', width / 2 - 120, legendY + 1);

      ctx.fillStyle = colors.terracottaLight;
      ctx.beginPath();
      ctx.roundRect(width / 2 + 30, legendY - 10, 14, 14, 3);
      ctx.fill();
      ctx.fillStyle = colors.charcoal;
      ctx.fillText('Переплата', width / 2 + 50, legendY + 1);

      // Footer
      const footerTop = legendY + 35;
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(sidePadding, footerTop);
      ctx.lineTo(width - sidePadding, footerTop);
      ctx.stroke();

      const footerCenterY = footerTop + 30;
      const logoSize = 28;
      const logoX = sidePadding;
      const logoY = footerCenterY - logoSize / 2;

      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(logoX, logoY, logoSize, logoSize, 5);
      ctx.fill();

      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1.8;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(logoX + 5, logoY + 14);
      ctx.lineTo(logoX + 14, logoY + 7);
      ctx.lineTo(logoX + 23, logoY + 14);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(logoX + 7, logoY + 13);
      ctx.lineTo(logoX + 7, logoY + 21);
      ctx.lineTo(logoX + 21, logoY + 21);
      ctx.lineTo(logoX + 21, logoY + 13);
      ctx.stroke();

      ctx.strokeStyle = colors.goldLight;
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(logoX + 9, logoY + 19);
      ctx.lineTo(logoX + 13, logoY + 15);
      ctx.lineTo(logoX + 16, logoY + 17);
      ctx.lineTo(logoX + 20, logoY + 13);
      ctx.stroke();

      ctx.fillStyle = colors.goldLight;
      ctx.beginPath();
      ctx.arc(logoX + 20, logoY + 13, 1.5, 0, Math.PI * 2);
      ctx.fill();

      ctx.font = 'bold 16px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.forest;
      ctx.textAlign = 'left';
      ctx.fillText('Честный ипотечный калькулятор', logoX + logoSize + 12, footerCenterY + 5);

      return canvas;
    }

    downloadBtn.addEventListener('click', () => {
      const canvas = generateImage();
      const link = document.createElement('a');
      link.download = 'ипотечный-расчёт.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // Share functionality
    const shareBtn = document.getElementById('share-btn');
    const shareDropdown = document.getElementById('share-dropdown');
    const copyLinkBtn = document.getElementById('copy-link-btn');

    // Move dropdown to body to escape overflow:hidden
    document.body.appendChild(shareDropdown);

    function toggleShareDropdown(open) {
      const isOpen = open !== undefined ? open : !shareDropdown.classList.contains('active');
      if (isOpen) {
        const rect = shareBtn.getBoundingClientRect();
        shareDropdown.style.top = (rect.bottom + 8) + 'px';
        shareDropdown.style.left = rect.left + 'px';
        shareDropdown.classList.add('active');
        shareBtn.setAttribute('aria-expanded', 'true');
      } else {
        shareDropdown.classList.remove('active');
        shareBtn.setAttribute('aria-expanded', 'false');
      }
    }

    shareBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleShareDropdown();
    });

    shareDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    document.addEventListener('click', (e) => {
      if (!shareBtn.contains(e.target) && !shareDropdown.contains(e.target)) {
        toggleShareDropdown(false);
      }
    });

    // Close dropdown on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && shareDropdown.classList.contains('active')) {
        toggleShareDropdown(false);
        shareBtn.focus();
      }
    });

    window.addEventListener('scroll', () => {
      if (shareDropdown.classList.contains('active')) {
        const rect = shareBtn.getBoundingClientRect();
        shareDropdown.style.top = (rect.bottom + 8) + 'px';
        shareDropdown.style.left = rect.left + 'px';
      }
    }, { passive: true });

    copyLinkBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        copyLinkBtn.innerHTML = `
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <span>Скопировано!</span>
        `;
        copyLinkBtn.classList.add('copied');
        setTimeout(() => {
          copyLinkBtn.innerHTML = `
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            <span>Копировать ссылку</span>
          `;
          copyLinkBtn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });

    // URL state management
    function updateURL() {
      const { propertyPrice, downPayment, interestRate, term, rawTerm, paymentType } = getValues();
      const params = new URLSearchParams();
      params.set('price', propertyPrice);
      params.set('down', downPayment);
      params.set('rate', interestRate);
      params.set('term', rawTerm);
      if (useCustomTerm && termUnit === 'months') {
        params.set('termUnit', 'months');
      } else {
        params.delete('termUnit');
      }
      params.set('type', paymentType);

      // Save start date to URL
      params.set('startDay', selectedDay);
      params.set('startMonth', selectedMonth);
      params.set('startYear', selectedYear);

      // Save early repayments to URL
      if (earlyRepayments.length > 0) {
        // Format: month,amount,type,frequency,amountType;...
        const earlyStr = earlyRepayments.map(r =>
          `${r.month},${r.amount},${r.type},${r.frequency},${r.amountType || 'extra'}`
        ).join(';');
        params.set('early', earlyStr);
      }

      // Save chart view mode to URL
      if (chartViewMode !== 'all') {
        params.set('chartView', chartViewMode);
      }

      const newURL = window.location.pathname + '?' + params.toString();
      history.replaceState(null, '', newURL);

      // Save to localStorage
      localStorage.setItem('calculator-state', JSON.stringify({
        propertyPrice,
        downPayment,
        interestRate,
        term: rawTerm,
        termUnit: useCustomTerm ? termUnit : undefined,
        paymentType,
        startDay: selectedDay,
        startMonth: selectedMonth,
        startYear: selectedYear,
        earlyRepayments,
        chartViewMode
      }));

      // Update share links
      const termText = useCustomTerm && termUnit === 'months'
        ? `${rawTerm} ${pluralizeMonths(rawTerm)}`
        : `${rawTerm} ${pluralizeYears(rawTerm)}`;
      const shareText = `Ипотечный калькулятор: ${formatNumber(propertyPrice)} ₽, ставка ${interestRate}%, срок ${termText}`;
      const shareURL = window.location.href;

      document.getElementById('share-telegram').href = `https://t.me/share/url?url=${encodeURIComponent(shareURL)}&text=${encodeURIComponent(shareText)}`;
      document.getElementById('share-whatsapp').href = `https://wa.me/?text=${encodeURIComponent(shareText + '\n' + shareURL)}`;
      document.getElementById('share-vk').href = `https://vk.com/share.php?url=${encodeURIComponent(shareURL)}&title=${encodeURIComponent(shareText)}`;
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      const hasURLParams = params.has('price') || params.has('early');

      // Try localStorage if no URL params
      if (!hasURLParams) {
        const saved = localStorage.getItem('calculator-state');
        if (saved) {
          try {
            const state = JSON.parse(saved);
            propertyPriceInput.value = formatNumber(state.propertyPrice);
            propertyPriceRange.value = state.propertyPrice;
            downPaymentInput.value = formatNumber(state.downPayment);
            downPaymentRange.value = state.downPayment;
            interestRateInput.value = state.interestRate;
            interestRateRange.value = state.interestRate;

            const termRadio = document.querySelector(`input[name="term"][value="${state.term}"]`);
            if (termRadio && !state.termUnit) {
              termRadio.checked = true;
            } else {
              useCustomTerm = true;
              termCustomInput.value = state.term;
              termCustomWrapper.classList.add('active');
              termRadios.forEach(r => r.checked = false);
              if (state.termUnit) {
                termUnit = state.termUnit;
              }
              updateTermUnitUI();
            }

            const typeRadio = document.querySelector(`input[name="payment-type"][value="${state.paymentType}"]`);
            if (typeRadio) typeRadio.checked = true;

            // Load start date from localStorage
            if (state.startDay !== undefined && state.startMonth !== undefined && state.startYear !== undefined) {
              selectedDay = state.startDay;
              selectedMonth = state.startMonth;
              selectedYear = state.startYear;
            }

            // Load early repayments from localStorage
            if (state.earlyRepayments && state.earlyRepayments.length > 0) {
              // Load chart view mode from localStorage
              if (state.chartViewMode !== undefined) {
                chartViewMode = state.chartViewMode;
              }
              return state.earlyRepayments;
            }

            // Load chart view mode from localStorage (when no early repayments)
            if (state.chartViewMode !== undefined) {
              chartViewMode = state.chartViewMode;
            }
          } catch (e) {
            console.error('Failed to load from localStorage:', e);
          }
        }
        return null;
      }

      if (params.has('price')) {
        propertyPriceInput.value = formatNumber(parseInt(params.get('price')));
        propertyPriceRange.value = parseInt(params.get('price'));
      }
      if (params.has('down')) {
        downPaymentInput.value = formatNumber(parseInt(params.get('down')));
        downPaymentRange.value = parseInt(params.get('down'));
      }
      if (params.has('rate')) {
        interestRateInput.value = parseFloat(params.get('rate'));
        interestRateRange.value = parseFloat(params.get('rate'));
      }
      if (params.has('term')) {
        const term = parseInt(params.get('term'));
        const urlTermUnit = params.get('termUnit');
        const radio = document.querySelector(`input[name="term"][value="${term}"]`);
        if (radio && !urlTermUnit) {
          radio.checked = true;
        } else {
          useCustomTerm = true;
          termCustomInput.value = term;
          termCustomWrapper.classList.add('active');
          termRadios.forEach(r => r.checked = false);
          if (urlTermUnit) {
            termUnit = urlTermUnit;
          }
          updateTermUnitUI();
        }
      }
      if (params.has('type')) {
        const type = params.get('type');
        const radio = document.querySelector(`input[name="payment-type"][value="${type}"]`);
        if (radio) radio.checked = true;
      }

      // Load start date from URL
      if (params.has('startDay') && params.has('startMonth') && params.has('startYear')) {
        selectedDay = parseInt(params.get('startDay'));
        selectedMonth = parseInt(params.get('startMonth'));
        selectedYear = parseInt(params.get('startYear'));
      }

      // Load early repayments from URL
      if (params.has('early')) {
        const earlyStr = params.get('early');
        const loadedRepayments = [];
        earlyStr.split(';').forEach(item => {
          const [month, amount, type, frequency, amountType] = item.split(',');
          if (month && amount) {
            loadedRepayments.push({
              id: repaymentIdCounter++,
              month: parseInt(month),
              amount: parseInt(amount),
              type: type || 'reduce-term',
              frequency: frequency || 'once',
              amountType: amountType || 'extra'
            });
          }
        });
        // Load chart view mode from URL
        if (params.has('chartView')) {
          const chartView = params.get('chartView');
          chartViewMode = chartView === 'all' ? 'all' : parseInt(chartView);
        }

        return loadedRepayments;
      }

      // Load chart view mode from URL (when no early repayments)
      if (params.has('chartView')) {
        const chartView = params.get('chartView');
        chartViewMode = chartView === 'all' ? 'all' : parseInt(chartView);
      }

      return null;
    }

    // Initialize
    const loadedRepayments = loadFromURL();
    // Scroll wheels to selected date (either loaded or current)
    setTimeout(() => scrollWheelsToSelectedDate(), 0);
    updateDownPaymentRange();

    // Load early repayments or add default
    if (loadedRepayments && loadedRepayments.length > 0) {
      const { term } = getValues();
      loadedRepayments.forEach((rep, index) => {
        const wrapper = createRepaymentItem(rep.id, term);
        const item = wrapper.querySelector('.bento-early-item');
        // Set values
        item.querySelector('.repayment-month').value = rep.month;
        item.querySelector('.repayment-amount').value = formatNumber(rep.amount);
        item.querySelector('.repayment-type').value = rep.type || 'reduce-term';
        item.querySelector('.repayment-frequency').value = rep.frequency;
        item.querySelector('.repayment-amount-type').value = rep.amountType || 'extra';

        // Sync custom month dropdown
        const monthDropdown = item.querySelector('.month-dropdown');
        if (monthDropdown) {
          syncMonthDropdown(monthDropdown, rep.month);
        }

        // Update payment number hint
        const paymentNumberHint = item.querySelector('.repayment-payment-number');
        if (paymentNumberHint) {
          paymentNumberHint.textContent = '№ ' + rep.month;
        }

        // Update amount type toggle UI
        const amountTypeBtns = item.querySelectorAll('.repayment-amount-type-btn');
        amountTypeBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.amountType === (rep.amountType || 'extra'));
        });
        const amountTypeToggle = item.querySelector('.repayment-amount-type-toggle');
        if (amountTypeToggle) {
          amountTypeToggle.classList.toggle('total', rep.amountType === 'total');
        }

        // Update effect toggle UI
        const effectBtns = item.querySelectorAll('.repayment-effect-btn');
        effectBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.effect === (rep.type || 'reduce-term'));
        });
        const effectToggle = item.querySelector('.repayment-effect-toggle');
        if (effectToggle) {
          effectToggle.classList.toggle('reduce-payment', rep.type === 'reduce-payment');
        }

        // Update frequency toggle UI
        const frequencyBtns = item.querySelectorAll('.repayment-frequency-btn');
        frequencyBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.frequency === rep.frequency);
        });
        const frequencyToggle = item.querySelector('.repayment-frequency-toggle');
        if (frequencyToggle) {
          frequencyToggle.classList.toggle('monthly', rep.frequency === 'monthly');
        }
        bentoEarlyList.insertBefore(wrapper, bentoEarlyEmpty);
        // Show immediately for initial load
        wrapper.classList.add('visible');
        // Add gap for items after the first
        if (index > 0) {
          wrapper.classList.add('has-gap');
        }
        // Add to earlyRepayments array directly
        if (rep.amount > 0) {
          earlyRepayments.push(rep);
        }
      });
      updateEmptyState();
    } else {
      addEarlyRepaymentItem();
    }

    // Single initial calculation after early repayments are loaded
    updateCalculations();

    // Resize handler for responsive chart
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
        const loanAmount = Math.max(0, propertyPrice - downPayment);
        updateScheduleChart(loanAmount, interestRate, term, paymentType);
      }, 150);
    });
  </script>
</body>
</html>
