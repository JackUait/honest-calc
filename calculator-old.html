<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Формула ипотеки — рассчитайте платёж онлайн</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="description" content="Рассчитайте ежемесячный платёж по ипотеке быстро и просто">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%232D4A3E'/%3E%3Cpath d='M5 15L16 6L27 15' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M8 13V24C8 24.5 8.5 25 9 25H23C23.5 25 24 24.5 24 24V13' stroke='white' stroke-width='2.5' stroke-linecap='round' fill='none'/%3E%3Cpath d='M12 22L14.5 18L17.5 20L21 15' stroke='%23F0C864' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Ccircle cx='21' cy='15' r='1.5' fill='%23F0C864'/%3E%3C/svg%3E">

  <!-- Fonts: Warm, readable choices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,400;7..72,500;7..72,600;7..72,700&family=Onest:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Warm, trustworthy palette */
      --cream: #FDF8F3;
      --cream-dark: #F5EDE4;
      --terracotta: #C65D3B;
      --terracotta-light: #E07B5A;
      --terracotta-dark: #A44D2F;
      --forest: #2D4A3E;
      --forest-light: #3D6353;
      --charcoal: #2C2C2C;
      --warm-gray: #6B6560;
      --gold: #D4A03C;
      --gold-light: #F0C864;

      /* Typography scale - generous for accessibility */
      --text-xs: clamp(0.875rem, 0.8rem + 0.25vw, 1rem);
      --text-sm: clamp(1rem, 0.9rem + 0.35vw, 1.125rem);
      --text-base: clamp(1.125rem, 1rem + 0.5vw, 1.375rem);
      --text-lg: clamp(1.375rem, 1.2rem + 0.75vw, 1.75rem);
      --text-xl: clamp(1.75rem, 1.5rem + 1vw, 2.5rem);
      --text-2xl: clamp(2.25rem, 1.8rem + 1.5vw, 3.5rem);

      /* Spacing */
      --space-xs: clamp(0.5rem, 0.4rem + 0.25vw, 0.75rem);
      --space-sm: clamp(0.75rem, 0.6rem + 0.5vw, 1.25rem);
      --space-md: clamp(1rem, 0.8rem + 0.75vw, 1.75rem);
      --space-lg: clamp(1.5rem, 1.2rem + 1vw, 2.5rem);
      --space-xl: clamp(2rem, 1.5rem + 1.5vw, 4rem);

      /* Borders & shadows */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --shadow-soft: 0 4px 20px rgba(44, 44, 44, 0.08);
      --shadow-medium: 0 8px 40px rgba(44, 44, 44, 0.12);
      --shadow-strong: 0 16px 60px rgba(44, 44, 44, 0.16);
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--text-base);
      line-height: 1.6;
      color: var(--charcoal);
      background: var(--cream);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Decorative background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(198, 93, 59, 0.04) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(45, 74, 62, 0.04) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(212, 160, 60, 0.03) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--forest);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-weight: 600;
      z-index: 1000;
      transition: top 0.3s ease;
    }

    .skip-link:focus {
      top: var(--space-sm);
    }

    /* Header */
    header {
      padding: var(--space-md) var(--space-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      gap: var(--space-md);
    }

    .logo {
      font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      flex-shrink: 0;
      letter-spacing: -0.02em;
    }

    .logo-icon {
      width: 52px;
      height: 52px;
      background: linear-gradient(145deg, var(--forest) 0%, var(--forest-light) 100%);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 32px;
      height: 32px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      line-height: 1.2;
    }

    .logo-subtitle {
      font-size: 13px;
      font-weight: 400;
      color: var(--warm-gray);
    }

    /* Header navigation */
    .header-nav {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .header-nav a {
      color: var(--warm-gray);
      text-decoration: none;
      font-size: var(--text-xs);
      font-weight: 500;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      transition: color 0.2s ease, background 0.2s ease;
    }

    .header-nav a:hover {
      color: var(--forest);
      background: rgba(45, 74, 62, 0.06);
    }

    /* Key rate badge */
    .key-rate {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(198, 93, 59, 0.08);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      color: var(--terracotta);
      font-weight: 500;
      flex-shrink: 0;
      text-decoration: none;
      transition: background 0.2s ease;
    }

    .key-rate:hover {
      background: rgba(198, 93, 59, 0.15);
    }

    .key-rate-label {
      color: var(--warm-gray);
    }

    .key-rate-value {
      font-weight: 700;
    }

    .key-rate-date {
      font-size: 0.85em;
      color: var(--warm-gray);
      opacity: 0.8;
    }

    @media (max-width: 700px) {
      header {
        flex-wrap: wrap;
        gap: var(--space-sm);
      }

      .logo span:not(.logo-icon) {
        display: none;
      }

      .header-nav {
        order: 3;
        width: 100%;
        justify-content: center;
        border-top: 1px solid var(--cream-dark);
        padding-top: var(--space-sm);
        margin-top: var(--space-xs);
      }

      .key-rate {
        margin-left: auto;
      }
    }

    /* Main container */
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: var(--space-lg);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Calculator card */
    .calculator-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-medium);
      overflow: hidden;
      animation: fadeInUp 0.8s ease-out 0.2s backwards;
      scroll-margin-top: var(--space-lg);
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: 600px;
    }

    @media (max-width: 900px) {
      .calculator-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Input section */
    .input-section {
      padding: var(--space-xl);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .section-title {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
      margin-bottom: var(--space-xs);
    }

    /* Form groups */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .form-label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--charcoal);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .form-label .icon {
      width: 24px;
      height: 24px;
      fill: var(--terracotta);
      flex-shrink: 0;
    }

    /* Input wrapper with suffix */
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-field {
      width: 100%;
      font-family: inherit;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--charcoal);
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      padding-right: 80px;
      transition: all 0.25s ease;
      outline: none;
    }

    .input-field:hover {
      background: var(--cream-dark);
    }

    .input-field:focus {
      background: white;
      border-color: var(--terracotta);
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .input-field::placeholder {
      color: var(--warm-gray);
      font-weight: 400;
    }

    .input-suffix {
      position: absolute;
      right: var(--space-md);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--warm-gray);
      pointer-events: none;
    }

    /* Range slider */
    .range-wrapper {
      margin-top: var(--space-xs);
    }

    .range-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      background: var(--cream-dark);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 4px solid white;
      box-shadow: var(--shadow-soft);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .range-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-medium);
    }

    .range-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 4px solid white;
      box-shadow: var(--shadow-soft);
      transition: transform 0.2s ease;
    }

    .range-slider:focus::-webkit-slider-thumb {
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.3);
    }

    .range-labels {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-xs);
      font-size: var(--text-xs);
      color: var(--warm-gray);
    }

    /* Term selector pills */
    .term-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-xs);
    }

    @media (max-width: 500px) {
      .term-selector {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .term-option {
      position: relative;
    }

    .term-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .term-option label {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-sm);
      min-height: 56px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .term-option label:hover {
      background: var(--cream-dark);
    }

    .term-option input[type="radio"]:focus + label {
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .term-option input[type="radio"]:checked + label {
      background: var(--terracotta);
      color: white;
      border-color: var(--terracotta);
    }

    /* Custom term input */
    .term-custom-wrapper {
      grid-column: span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm);
      min-height: 56px;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      transition: all 0.25s ease;
      cursor: pointer;
    }

    .term-custom-wrapper:focus-within {
      background: white;
      border-color: var(--terracotta);
      box-shadow: 0 0 0 4px rgba(198, 93, 59, 0.15);
    }

    .term-custom-wrapper.active {
      background: var(--terracotta);
      border-color: var(--terracotta);
    }

    .term-custom-input {
      width: 60px;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      background: transparent;
      border: none;
      outline: none;
      text-align: center;
    }

    .term-custom-wrapper.active .term-custom-input {
      color: white;
    }

    .term-custom-wrapper.active .term-custom-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .term-custom-label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--warm-gray);
      white-space: nowrap;
    }

    .term-custom-wrapper.active .term-custom-label {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Payment type toggle (in result section - dark theme) */
    .payment-type-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      padding: 4px;
      gap: 4px;
      margin-bottom: var(--space-lg);
    }

    .payment-type-option {
      flex: 1;
      position: relative;
    }

    .payment-type-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .payment-type-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-sm) var(--space-xs);
      min-height: 64px;
      background: transparent;
      border: 2px solid transparent;
      border-radius: calc(var(--radius-md) - 4px);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .payment-type-option label:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .payment-type-option input[type="radio"]:focus + label {
      box-shadow: 0 0 0 4px rgba(240, 200, 100, 0.3);
    }

    .payment-type-option input[type="radio"]:checked + label {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--gold-light);
    }

    .payment-type-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 2px;
    }

    .payment-type-desc {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.3;
    }

    .payment-type-option input[type="radio"]:checked + label .payment-type-name {
      color: var(--gold-light);
    }

    .payment-type-option input[type="radio"]:checked + label .payment-type-desc {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Result section */
    .result-section {
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      padding: var(--space-xl);
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    /* Decorative circles in result section */
    .result-section::before,
    .result-section::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
    }

    .result-section::before {
      width: 300px;
      height: 300px;
      background: white;
      top: -100px;
      right: -100px;
    }

    .result-section::after {
      width: 200px;
      height: 200px;
      background: var(--gold);
      bottom: -50px;
      left: -50px;
    }

    .result-content {
      position: relative;
      z-index: 1;
    }

    /* Main payment highlight block */
    .payment-highlight {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      border: 1px solid rgba(255, 255, 255, 0.15);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .payment-highlight::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--gold-light), var(--gold));
    }

    .result-title {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-sm);
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-sm);
    }

    .result-value {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-2xl);
      font-weight: 700;
      color: white;
      margin-bottom: var(--space-xs);
      line-height: 1.1;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
    }

    .result-value .currency {
      font-size: 0.6em;
      color: var(--gold-light);
    }

    .result-period {
      font-size: var(--text-sm);
      color: rgba(255, 255, 255, 0.7);
    }

    .result-range {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.6);
      margin-top: var(--space-xs);
    }

    /* Result breakdown */
    .result-breakdown {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      padding-top: var(--space-lg);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .breakdown-label {
      font-size: var(--text-sm);
      color: rgba(255, 255, 255, 0.8);
    }

    .breakdown-value {
      font-size: var(--text-base);
      font-weight: 600;
      color: white;
    }

    .breakdown-item.highlight .breakdown-value {
      color: var(--gold-light);
    }

    /* Pie chart visualization */
    .pie-chart-container {
      margin-top: var(--space-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-md);
    }

    .pie-chart-wrapper {
      position: relative;
      width: 200px;
      height: 200px;
    }

    .pie-chart {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      filter: drop-shadow(0 4px 16px rgba(0, 0, 0, 0.2));
    }

    .pie-ring {
      fill: none;
      stroke-width: 20;
      transition: stroke-dasharray 0.6s ease-out;
    }

    .pie-ring-interest {
      stroke: rgba(255, 255, 255, 0.35);
    }

    .pie-ring-principal {
      stroke: var(--gold-light);
    }

    .pie-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }

    .pie-percent-principal {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--gold-light);
      line-height: 1;
    }

    .pie-percent-label {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
    }

    .pie-chart-legend {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      width: 100%;
      padding: var(--space-md);
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-md);
    }

    .legend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .legend-label {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-sm);
      color: rgba(255, 255, 255, 0.9);
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-dot.principal {
      background: var(--gold-light);
      box-shadow: 0 2px 8px rgba(240, 200, 100, 0.4);
    }

    .legend-dot.interest {
      background: rgba(255, 255, 255, 0.35);
    }

    .legend-value {
      display: flex;
      align-items: baseline;
      gap: var(--space-xs);
    }

    .legend-amount {
      font-size: var(--text-sm);
      font-weight: 600;
      color: white;
    }

    .legend-percent {
      font-size: var(--text-xs);
      font-weight: 700;
      color: white;
      min-width: 50px;
      text-align: right;
    }

    /* Download button */
    .download-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      margin-top: var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .download-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .download-btn:active {
      transform: scale(0.98);
    }

    .download-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Action buttons container */
    .action-buttons {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
    }

    .action-buttons .download-btn {
      margin-top: 0;
      flex: 1;
    }

    /* Share wrapper */
    .share-wrapper {
      position: relative;
      flex: 1;
    }

    /* Share button */
    .share-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: rgba(255, 255, 255, 0.15);
      color: white;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .share-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .share-btn:active {
      transform: scale(0.98);
    }

    .share-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Share dropdown */
    .share-dropdown {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      padding: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: opacity 0.15s ease, visibility 0.15s ease, transform 0.15s ease;
      z-index: 1000;
    }

    .share-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      color: var(--charcoal);
      cursor: pointer;
      transition: background 0.15s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .share-option:hover {
      background: var(--cream);
    }

    .share-option svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .share-option.copy svg {
      fill: var(--warm-gray);
    }

    .share-option.telegram svg {
      fill: #0088cc;
    }

    .share-option.whatsapp svg {
      fill: #25D366;
    }

    .share-option.vk svg {
      fill: #0077FF;
    }

    .share-option.copied {
      color: var(--forest);
    }

    .share-option.copied svg {
      fill: var(--forest);
    }

    /* CTA button */
    .cta-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      margin-top: var(--space-lg);
      padding: var(--space-md) var(--space-lg);
      background: var(--gold);
      color: var(--charcoal);
      font-family: inherit;
      font-size: var(--text-base);
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.25s ease;
      text-decoration: none;
    }

    .cta-button:hover {
      background: var(--gold-light);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(212, 160, 60, 0.4);
    }

    .cta-button:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(212, 160, 60, 0.5);
    }

    .cta-button:active {
      transform: translateY(0);
    }

    /* Tips section */
    .tips-section {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      animation: fadeInUp 0.8s ease-out 0.4s backwards;
    }

    .tips-title {
      font-family: 'Literata', Georgia, serif;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--forest);
      margin-bottom: var(--space-md);
      scroll-margin-top: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .tips-title svg {
      width: 28px;
      height: 28px;
      fill: var(--gold);
    }

    .tips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
    }

    .tip-card {
      padding: var(--space-md);
      background: var(--cream);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--terracotta);
    }

    .tip-card h3 {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: var(--space-xs);
    }

    .tip-card p {
      font-size: var(--text-xs);
      color: var(--warm-gray);
      line-height: 1.5;
    }

    /* Footer */
    footer {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      text-align: center;
      color: var(--warm-gray);
      font-size: var(--text-xs);
    }

    footer a {
      color: var(--terracotta);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Accessibility: Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus visible for better keyboard navigation */
    :focus-visible {
      outline: 3px solid var(--terracotta);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .input-field {
        border: 2px solid var(--charcoal);
      }

      .term-option label {
        border: 2px solid var(--charcoal);
      }
    }

    /* Schedule section */
    .schedule-section {
      margin-top: var(--space-xl);
    }

    /* Schedule chart */
    .schedule-chart {
      background: var(--cream);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
      scroll-margin-top: var(--space-lg);
    }

    .chart-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: var(--space-md);
    }

    .chart-container {
      position: relative;
      height: 240px;
      width: 100%;
    }

    .chart-svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .chart-area-principal {
      fill: var(--gold);
      animation: chartBarGrow 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .chart-area-interest {
      fill: var(--terracotta-light);
      animation: chartBarGrow 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    /* Animation for chart bars growing from bottom */
    @keyframes chartBarGrow {
      from {
        transform: scaleY(0);
        opacity: 0;
      }
      to {
        transform: scaleY(1);
        opacity: 1;
      }
    }

    /* Disable animations for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .chart-area-principal,
      .chart-area-interest {
        animation: none;
      }
    }

    .chart-grid-line {
      stroke: var(--cream-dark);
      stroke-width: 1;
    }

    .chart-axis-label {
      font-size: 10px;
      fill: var(--warm-gray);
      font-family: inherit;
    }

    .chart-axis-label-y {
      text-anchor: end;
    }

    .chart-axis-label-x {
      text-anchor: middle;
    }

    .chart-year-label {
      font-size: 9px;
      fill: var(--warm-gray);
      font-family: inherit;
      text-anchor: middle;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-lg);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid var(--cream-dark);
      justify-content: center;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-sm);
      color: var(--charcoal);
    }

    .chart-legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .chart-legend-dot.principal {
      background: var(--gold);
    }

    .chart-legend-dot.interest {
      background: var(--terracotta-light);
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      background: var(--charcoal);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 100;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .chart-tooltip.visible {
      opacity: 1;
    }

    .chart-tooltip-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: white;
    }

    .chart-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: var(--space-md);
      line-height: 1.5;
    }

    .chart-tooltip-label {
      color: rgba(255, 255, 255, 0.7);
    }

    .chart-tooltip-value {
      font-weight: 500;
    }

    .chart-tooltip-value.principal {
      color: var(--gold-light);
    }

    .chart-tooltip-value.interest {
      color: var(--terracotta-light);
    }

    /* Chart bar hover effect */
    .chart-bar-group {
      cursor: pointer;
    }

    .chart-bar-group:hover .chart-area-principal,
    .chart-bar-group:hover .chart-area-interest {
      filter: brightness(1.1);
    }

    /* Schedule table */
    .schedule-table-wrapper {
      background: white;
      border-radius: var(--radius-md);
      border: 1px solid var(--cream-dark);
      overflow: hidden;
    }

    .schedule-table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--cream);
      border-bottom: 1px solid var(--cream-dark);
    }

    .schedule-table-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
    }

    .schedule-view-toggle {
      display: flex;
      background: white;
      padding: 5px;
      border-radius: var(--radius-md);
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .schedule-view-toggle::before {
      content: '';
      position: absolute;
      top: 5px;
      left: 5px;
      width: calc(50% - 5px);
      height: calc(100% - 10px);
      background: var(--terracotta);
      border-radius: calc(var(--radius-md) - 5px);
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      box-shadow: 0 2px 4px rgba(198, 93, 59, 0.3);
    }

    .schedule-view-toggle.monthly-view::before {
      left: calc(50% + 0px);
    }

    .view-toggle-btn {
      flex: 1;
      padding: var(--space-xs) var(--space-sm);
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      background: transparent;
      border: none;
      border-radius: calc(var(--radius-md) - 5px);
      color: var(--warm-gray);
      cursor: pointer;
      transition: color 0.2s ease;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      text-align: center;
    }

    .view-toggle-btn:hover:not(.active) {
      color: var(--charcoal);
    }

    .view-toggle-btn.active {
      color: white;
    }

    .schedule-table-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-xs);
    }

    .schedule-table th {
      position: sticky;
      top: 0;
      background: var(--cream);
      padding: var(--space-sm);
      text-align: right;
      font-weight: 600;
      color: var(--charcoal);
      border-bottom: 1px solid var(--cream-dark);
    }

    .schedule-table th:first-child {
      text-align: left;
    }

    .schedule-table td {
      padding: var(--space-sm);
      text-align: right;
      color: var(--charcoal);
      border-bottom: 1px solid var(--cream);
    }

    .schedule-table td:first-child {
      text-align: left;
      color: var(--warm-gray);
    }

    .schedule-table tr:hover td {
      background: var(--cream);
    }

    .schedule-table .principal-cell {
      color: var(--gold);
      font-weight: 500;
    }

    .schedule-table .interest-cell {
      color: var(--terracotta);
    }

    .schedule-table .balance-cell {
      color: var(--forest);
      font-weight: 600;
    }

    /* Early payment star with tooltip */
    .early-payment-star {
      color: var(--gold);
      cursor: help;
      font-size: 0.9em;
    }

    .early-payment-tooltip {
      position: fixed;
      background: var(--charcoal);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: var(--text-xs);
      white-space: nowrap;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .early-payment-tooltip.visible {
      opacity: 1;
    }

    .early-payment-tooltip::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 100%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--charcoal);
    }

    /* Table resize handle */
    .schedule-table-resize-handle {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 24px;
      cursor: ns-resize;
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      transition: background 0.15s ease;
      user-select: none;
    }

    .schedule-table-resize-handle:hover,
    .schedule-table-resize-handle.dragging {
      background: var(--cream-dark);
    }

    .resize-handle-bar {
      width: 40px;
      height: 4px;
      background: rgba(107, 101, 96, 0.3);
      border-radius: 2px;
      transition: background 0.15s ease, width 0.15s ease;
    }

    .schedule-table-resize-handle:hover .resize-handle-bar,
    .schedule-table-resize-handle.dragging .resize-handle-bar {
      background: rgba(107, 101, 96, 0.5);
      width: 60px;
    }

    /* Mobile schedule */
    @media (max-width: 600px) {
      .schedule-table th,
      .schedule-table td {
        padding: var(--space-xs);
        font-size: 0.75rem;
      }

      .chart-container {
        height: 200px;
      }

      .schedule-table-resize-handle {
        height: 32px;
      }

      .resize-handle-bar {
        width: 60px;
        height: 5px;
      }
    }

    /* Early repayment section */
    .early-repayment-section {
      margin-top: var(--space-lg);
      background: white;
      border-radius: var(--radius-md);
      border: 1px solid var(--cream-dark);
    }

    .early-repayment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--cream);
      border-bottom: 1px solid var(--cream-dark);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }

    .early-repayment-header:hover {
      background: var(--cream-dark);
    }

    .early-repayment-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--charcoal);
    }

    .early-repayment-title svg {
      width: 22px;
      height: 22px;
      fill: var(--forest);
    }

    .early-repayment-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-xs);
      color: var(--warm-gray);
    }

    .early-repayment-toggle svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
      transition: transform 0.3s ease;
    }

    .early-repayment-section.open .early-repayment-toggle svg {
      transform: rotate(180deg);
    }

    .early-repayment-content {
      display: none;
      padding: var(--space-md);
      overflow: visible;
    }

    .early-repayment-section.open .early-repayment-content {
      display: block;
    }

    /* Early repayment list */
    .early-repayments-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
      overflow: visible;
    }

    .early-repayment-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background: var(--cream);
      border-radius: var(--radius-sm);
      align-items: center;
      position: relative;
    }

    @media (max-width: 700px) {
      .early-repayment-item {
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xs);
      }

      .early-repayment-item > *:last-child {
        grid-column: span 2;
        justify-self: end;
      }
    }

    .early-repayment-item-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .early-repayment-item-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--warm-gray);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .early-repayment-item-input {
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
    }

    .early-repayment-item-input:focus {
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(198, 93, 59, 0.1);
    }

    .early-repayment-item-select {
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease;
      width: 100%;
    }

    .early-repayment-item-select:focus {
      border-color: var(--forest);
    }

    /* Custom dropdown for desktop */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }

    /* Hide native select on desktop, show custom dropdown */
    @media (hover: hover) and (pointer: fine) {
      .custom-dropdown .early-repayment-item-select {
        display: none;
      }
    }

    /* Show native select on mobile/touch devices */
    @media (hover: none), (pointer: coarse) {
      .custom-dropdown-trigger {
        display: none !important;
      }
      .custom-dropdown-menu {
        display: none !important;
      }
    }

    .custom-dropdown-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      gap: 8px;
    }

    .custom-dropdown-trigger:hover {
      border-color: var(--forest);
    }

    .custom-dropdown-trigger:focus,
    .custom-dropdown.open .custom-dropdown-trigger {
      border-color: var(--terracotta);
      box-shadow: 0 0 0 3px rgba(198, 93, 59, 0.1);
    }

    .custom-dropdown-trigger-text {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .custom-dropdown-trigger-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--warm-gray);
      transition: transform 0.2s ease;
    }

    .custom-dropdown.open .custom-dropdown-trigger-icon {
      transform: rotate(180deg);
    }

    .custom-dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      min-width: 100%;
      background: white;
      border: 1px solid var(--cream-dark);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-medium);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
      overflow: hidden;
    }

    .custom-dropdown.open .custom-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-dropdown-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .custom-dropdown-option:hover {
      background: var(--cream);
    }

    .custom-dropdown-option.selected {
      background: rgba(45, 74, 62, 0.08);
    }

    .custom-dropdown-option-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      color: var(--forest);
    }

    .custom-dropdown-option-content {
      flex: 1;
      min-width: 0;
    }

    .custom-dropdown-option-title {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--charcoal);
    }

    .custom-dropdown-option-desc {
      font-size: 12px;
      color: var(--warm-gray);
      margin-top: 2px;
    }

    .custom-dropdown-option-check {
      width: 16px;
      height: 16px;
      color: var(--terracotta);
      opacity: 0;
      flex-shrink: 0;
    }

    .custom-dropdown-option.selected .custom-dropdown-option-check {
      opacity: 1;
    }

    /* Month dropdown specific styles */
    .month-dropdown .custom-dropdown-menu {
      max-height: 320px;
      overflow-y: auto;
      min-width: 260px;
    }

    .month-dropdown .custom-dropdown-option {
      padding: var(--space-sm);
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      position: relative;
    }

    .month-dropdown .custom-dropdown-option .custom-dropdown-option-check {
      position: absolute;
      right: var(--space-sm);
      top: 50%;
      transform: translateY(-50%);
    }

    .month-option-main {
      display: flex;
      align-items: baseline;
      gap: 8px;
      width: 100%;
    }

    .month-option-date {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--charcoal);
    }

    .month-option-payment {
      font-size: 11px;
      color: var(--warm-gray);
      background: var(--cream);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .month-option-balance {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .month-option-remaining {
      font-size: 12px;
      color: var(--forest);
      font-weight: 500;
    }

    .month-option-progress {
      font-size: 11px;
      color: var(--warm-gray);
    }

    .month-dropdown .custom-dropdown-option:hover .month-option-remaining {
      color: var(--forest-light);
    }

    .month-dropdown .custom-dropdown-option.selected .month-option-payment {
      background: rgba(198, 93, 59, 0.1);
      color: var(--terracotta);
    }

    .month-dropdown-year-divider {
      padding: 8px var(--space-sm);
      font-size: 11px;
      font-weight: 600;
      color: var(--warm-gray);
      background: var(--cream);
      border-top: 1px solid var(--cream-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* Hide native select on desktop for month dropdown */
    @media (hover: hover) and (pointer: fine) {
      .month-dropdown .early-repayment-item-select {
        display: none;
      }
    }

    /* Show native select on mobile/touch devices */
    @media (hover: none), (pointer: coarse) {
      .month-dropdown .custom-dropdown-trigger {
        display: none !important;
      }
      .month-dropdown .custom-dropdown-menu {
        display: none !important;
      }
    }

    /* Frequency toggle (one-time / monthly) */
    .repayment-frequency-toggle {
      display: flex;
      background: white;
      padding: 3px;
      border-radius: var(--radius-sm);
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .repayment-frequency-toggle::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: calc(50% - 3px);
      height: calc(100% - 6px);
      background: var(--forest);
      border-radius: calc(var(--radius-sm) - 3px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      box-shadow: 0 2px 4px rgba(45, 74, 62, 0.3);
    }

    .repayment-frequency-toggle.monthly::before {
      transform: translateX(100%);
    }

    .repayment-frequency-btn {
      flex: 1;
      padding: 6px 10px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 500;
      color: var(--warm-gray);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.2s ease;
      white-space: nowrap;
      position: relative;
      z-index: 1;
    }

    .repayment-frequency-btn:hover:not(.active) {
      color: var(--charcoal);
    }

    .repayment-frequency-btn.active {
      color: white;
    }

    /* Adjust grid for 5 columns on desktop */
    @media (min-width: 701px) {
      .early-repayment-item {
        grid-template-columns: minmax(100px, 1fr) minmax(100px, 1fr) minmax(120px, 1fr) minmax(160px, 1.2fr) auto;
      }
    }

    .early-repayment-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--warm-gray);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
      align-self: end;
      margin-bottom: 4px;
    }

    .early-repayment-remove:hover {
      background: rgba(198, 93, 59, 0.1);
      color: var(--terracotta);
    }

    .early-repayment-remove svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Add repayment button */
    .add-repayment-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: var(--cream);
      color: var(--forest);
      font-family: inherit;
      font-size: var(--text-xs);
      font-weight: 600;
      border: 2px dashed var(--cream-dark);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-repayment-btn:hover {
      background: var(--cream-dark);
      border-color: var(--forest);
    }

    .add-repayment-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Early repayment summary */
    .early-repayment-summary {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      border-radius: var(--radius-md);
      color: white;
    }

    .early-repayment-summary-title {
      font-size: var(--text-xs);
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .early-repayment-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }

    @media (max-width: 500px) {
      .early-repayment-summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .early-repayment-summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .early-repayment-summary-label {
      font-size: var(--text-xs);
      color: rgba(255, 255, 255, 0.7);
    }

    .early-repayment-summary-value {
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .early-repayment-summary-value.positive {
      color: var(--gold-light);
    }

    /* Empty state */
    .early-repayments-empty {
      text-align: center;
      padding: var(--space-md);
      color: var(--warm-gray);
      font-size: var(--text-xs);
    }

    /* Footer */
    footer {
      max-width: 1100px;
      margin: 0 auto;
      padding: var(--space-lg);
      text-align: center;
    }

    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) 0;
      border-top: 1px solid var(--cream-dark);
    }

    .footer-author {
      font-size: var(--text-sm);
      color: var(--warm-gray);
    }

    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--terracotta);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .footer-link:hover {
      color: var(--terracotta-dark);
    }

    .footer-link svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* Watermark for screenshots */
    .watermark {
      position: fixed;
      bottom: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-sm);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      font-size: 13px;
      font-weight: 500;
      color: var(--warm-gray);
      text-decoration: none;
      z-index: 100;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .watermark:hover {
      background: white;
      color: var(--terracotta);
    }

    .watermark svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    @media print {
      .watermark {
        position: absolute;
      }
    }
  </style>
</head>
<body>
  <a href="#calculator" class="skip-link">Перейти к калькулятору</a>

  <header>
    <a href="#" class="logo">
      <span class="logo-icon">
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none">
          <path d="M4 12L12 5L20 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M6 11V18C6 18.5 6.5 19 7 19H17C17.5 19 18 18.5 18 18V11" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 17L11 14L13 15.5L15 12" stroke="#F0C864" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="15" cy="12" r="1" fill="#F0C864"/>
        </svg>
      </span>
      <span class="logo-text">
        <span class="logo-title">Формула ипотеки</span>
        <span class="logo-subtitle">Ипотечный калькулятор</span>
      </span>
    </a>
    <nav class="header-nav">
      <a href="#calculator">Калькулятор</a>
      <a href="#schedule-chart">График</a>
      <a href="#tips-heading">Советы</a>
    </nav>
    <a href="https://cbr.ru/hd_base/KeyRate/" target="_blank" rel="noopener noreferrer" class="key-rate" title="Проверить актуальную ставку на сайте ЦБ РФ">
      <span class="key-rate-label">Ставка ЦБ:</span>
      <span class="key-rate-value" id="key-rate-value">16%</span>
      <span class="key-rate-date" id="key-rate-date">от 22.12.25</span>
    </a>
  </header>

  <main>
    <article class="calculator-card" id="calculator" role="region" aria-label="Калькулятор ипотеки">
      <div class="calculator-grid">
        <section class="input-section" aria-label="Параметры ипотеки">
          <h2 class="section-title">Параметры кредита</h2>

          <!-- Property Price -->
          <div class="form-group">
            <label class="form-label" for="property-price">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              Стоимость недвижимости
            </label>
            <div class="input-wrapper">
              <input
                type="text"
                id="property-price"
                class="input-field"
                inputmode="numeric"
                value="5 000 000"
                aria-describedby="price-hint"
              >
              <span class="input-suffix">₽</span>
            </div>
            <div class="range-wrapper">
              <input
                type="range"
                id="property-price-range"
                class="range-slider"
                min="500000"
                max="50000000"
                step="100000"
                value="5000000"
                aria-label="Стоимость недвижимости"
              >
              <div class="range-labels">
                <span>500 тыс.</span>
                <span>50 млн.</span>
              </div>
            </div>
          </div>

          <!-- Down Payment -->
          <div class="form-group">
            <label class="form-label" for="down-payment">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
              </svg>
              Первоначальный взнос
            </label>
            <div class="input-wrapper">
              <input
                type="text"
                id="down-payment"
                class="input-field"
                inputmode="numeric"
                value="1 000 000"
              >
              <span class="input-suffix">₽</span>
            </div>
            <div class="range-wrapper">
              <input
                type="range"
                id="down-payment-range"
                class="range-slider"
                min="0"
                max="5000000"
                step="50000"
                value="1000000"
                aria-label="Первоначальный взнос"
              >
              <div class="range-labels">
                <span>0%</span>
                <span id="down-payment-percent">20%</span>
              </div>
            </div>
          </div>

          <!-- Interest Rate -->
          <div class="form-group">
            <label class="form-label" for="interest-rate">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7.5 11C9.43 11 11 9.43 11 7.5S9.43 4 7.5 4 4 5.57 4 7.5 5.57 11 7.5 11zm0-5C8.33 6 9 6.67 9 7.5S8.33 9 7.5 9 6 8.33 6 7.5 6.67 6 7.5 6zM4.0025 18.5832L18.5858 3.9999l1.4143 1.4142L5.4167 19.9974l-1.4142-1.4142zM16.5 13c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5zm0 5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
              Процентная ставка
            </label>
            <div class="input-wrapper">
              <input
                type="text"
                id="interest-rate"
                class="input-field"
                inputmode="decimal"
                value="18"
              >
              <span class="input-suffix">% годовых</span>
            </div>
            <div class="range-wrapper">
              <input
                type="range"
                id="interest-rate-range"
                class="range-slider"
                min="1"
                max="30"
                step="0.1"
                value="18"
                aria-label="Процентная ставка"
              >
              <div class="range-labels">
                <span>1%</span>
                <span>30%</span>
              </div>
            </div>
          </div>

          <!-- Loan Term -->
          <div class="form-group">
            <label class="form-label">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
              </svg>
              Срок кредита
            </label>
            <div class="term-selector" role="radiogroup" aria-label="Выберите срок кредита">
              <div class="term-option">
                <input type="radio" name="term" id="term-5" value="5">
                <label for="term-5">5 лет</label>
              </div>
              <div class="term-option">
                <input type="radio" name="term" id="term-10" value="10">
                <label for="term-10">10 лет</label>
              </div>
              <div class="term-option">
                <input type="radio" name="term" id="term-15" value="15">
                <label for="term-15">15 лет</label>
              </div>
              <div class="term-option">
                <input type="radio" name="term" id="term-20" value="20" checked>
                <label for="term-20">20 лет</label>
              </div>
              <div class="term-option">
                <input type="radio" name="term" id="term-25" value="25">
                <label for="term-25">25 лет</label>
              </div>
              <div class="term-option">
                <input type="radio" name="term" id="term-30" value="30">
                <label for="term-30">30 лет</label>
              </div>
              <div class="term-custom-wrapper" id="term-custom-wrapper">
                <input
                  type="text"
                  class="term-custom-input"
                  id="term-custom"
                  inputmode="numeric"
                  placeholder="—"
                  maxlength="2"
                  aria-label="Свой срок кредита"
                >
                <span class="term-custom-label">лет</span>
              </div>
            </div>
          </div>
        </section>

        <section class="result-section" aria-label="Результаты расчёта" aria-live="polite">
          <div class="result-content">
            <!-- Payment Type Toggle -->
            <div class="payment-type-toggle" role="radiogroup" aria-label="Выберите тип платежа">
              <div class="payment-type-option">
                <input type="radio" name="payment-type" id="payment-annuity" value="annuity" checked>
                <label for="payment-annuity">
                  <span class="payment-type-name">Аннуитетный</span>
                  <span class="payment-type-desc">равные платежи</span>
                </label>
              </div>
              <div class="payment-type-option">
                <input type="radio" name="payment-type" id="payment-differentiated" value="differentiated">
                <label for="payment-differentiated">
                  <span class="payment-type-name">Дифференцированный</span>
                  <span class="payment-type-desc">убывающие платежи</span>
                </label>
              </div>
            </div>

            <div class="payment-highlight">
              <p class="result-title">Ежемесячный платёж</p>
              <p class="result-value" id="monthly-payment">
                <span id="payment-amount">65 394</span>
                <span class="currency">₽</span>
              </p>
              <p class="result-period" id="payment-type-label">Аннуитетный платёж</p>
              <p class="result-range" id="payment-range" style="display: none;"></p>
            </div>

            <div class="result-breakdown">
              <div class="breakdown-item">
                <span class="breakdown-label">Сумма кредита</span>
                <span class="breakdown-value" id="loan-amount">4 000 000 ₽</span>
              </div>
              <div class="breakdown-item">
                <span class="breakdown-label">Общая сумма выплат</span>
                <span class="breakdown-value" id="total-payment">15 694 560 ₽</span>
              </div>
              <div class="breakdown-item highlight">
                <span class="breakdown-label">Переплата по кредиту</span>
                <span class="breakdown-value" id="total-interest">11 694 560 ₽</span>
              </div>
            </div>

            <div class="pie-chart-container" aria-label="Диаграмма распределения платежей">
              <div class="pie-chart-wrapper">
                <svg class="pie-chart" viewBox="0 0 100 100" aria-hidden="true">
                  <circle class="pie-ring pie-ring-interest" cx="50" cy="50" r="40"/>
                  <circle class="pie-ring pie-ring-principal" id="pie-principal" cx="50" cy="50" r="40"/>
                </svg>
                <div class="pie-center-text">
                  <div class="pie-percent-principal" id="pie-percent-display">25.5%</div>
                  <div class="pie-percent-label">основной долг</div>
                </div>
              </div>
              <div class="pie-chart-legend">
                <div class="legend-row">
                  <span class="legend-label">
                    <span class="legend-dot principal"></span>
                    Основной долг
                  </span>
                  <span class="legend-value">
                    <span class="legend-amount" id="legend-principal-amount">4 000 000 ₽</span>
                    <span class="legend-percent" id="legend-principal-percent">25.5%</span>
                  </span>
                </div>
                <div class="legend-row">
                  <span class="legend-label">
                    <span class="legend-dot interest"></span>
                    Проценты
                  </span>
                  <span class="legend-value">
                    <span class="legend-amount" id="legend-interest-amount">11 694 560 ₽</span>
                    <span class="legend-percent" id="legend-interest-percent">74.5%</span>
                  </span>
                </div>
              </div>
            </div>

            <div class="action-buttons">
              <button type="button" class="download-btn" id="download-btn" aria-label="Скачать расчёт как картинку">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Скачать
              </button>

              <div class="share-wrapper">
                <button type="button" class="share-btn" id="share-btn" aria-label="Поделиться расчётом">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                  </svg>
                  Поделиться
                </button>
                <div class="share-dropdown" id="share-dropdown">
                  <button type="button" class="share-option copy" id="copy-link-btn">
                    <svg viewBox="0 0 24 24">
                      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                    <span>Копировать ссылку</span>
                  </button>
                  <a href="#" class="share-option telegram" id="share-telegram" target="_blank" rel="noopener">
                    <svg viewBox="0 0 24 24">
                      <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                    </svg>
                    <span>Telegram</span>
                  </a>
                  <a href="#" class="share-option whatsapp" id="share-whatsapp" target="_blank" rel="noopener">
                    <svg viewBox="0 0 24 24">
                      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    <span>WhatsApp</span>
                  </a>
                  <a href="#" class="share-option vk" id="share-vk" target="_blank" rel="noopener">
                    <svg viewBox="0 0 24 24">
                      <path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4.03 8.57 4.03 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.864 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.744c.372 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.813-.542 1.254-1.406 2.151-3.574 2.151-3.574.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/>
                    </svg>
                    <span>ВКонтакте</span>
                  </a>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
    </article>

    <!-- Early Repayment Section -->
    <div class="early-repayment-section" id="early-repayment-section">
      <div class="early-repayment-header" id="early-repayment-header">
        <div class="early-repayment-title">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Досрочное погашение
        </div>
        <div class="early-repayment-toggle">
          <span>Добавить</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
          </svg>
        </div>
      </div>
      <div class="early-repayment-content">
        <div class="early-repayments-list" id="early-repayments-list">
          <div class="early-repayments-empty" id="early-repayments-empty">
            Добавьте досрочные погашения, чтобы увидеть экономию
          </div>
        </div>
        <button type="button" class="add-repayment-btn" id="add-repayment-btn">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          Добавить платёж
        </button>

        <div class="early-repayment-summary" id="early-repayment-summary" style="display: none;">
          <div class="early-repayment-summary-title">Выгода от досрочных погашений</div>
          <div class="early-repayment-summary-grid">
            <div class="early-repayment-summary-item">
              <span class="early-repayment-summary-label">Новый срок кредита</span>
              <span class="early-repayment-summary-value" id="summary-new-term">—</span>
            </div>
            <div class="early-repayment-summary-item">
              <span class="early-repayment-summary-label">Сокращение срока</span>
              <span class="early-repayment-summary-value positive" id="summary-term-saved">—</span>
            </div>
            <div class="early-repayment-summary-item">
              <span class="early-repayment-summary-label">Новая переплата</span>
              <span class="early-repayment-summary-value" id="summary-new-interest">—</span>
            </div>
            <div class="early-repayment-summary-item">
              <span class="early-repayment-summary-label">Экономия на процентах</span>
              <span class="early-repayment-summary-value positive" id="summary-interest-saved">—</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule Section -->
    <section class="schedule-section" aria-label="График погашения кредита">
      <!-- Chart -->
      <div class="schedule-chart" id="schedule-chart">
        <h3 class="chart-title">Структура ежемесячного платежа по годам</h3>
        <div class="chart-container">
          <svg class="chart-svg" id="schedule-chart-svg" viewBox="0 0 650 240">
            <!-- Chart will be drawn by JS -->
          </svg>
          <div class="chart-tooltip" id="chart-tooltip"></div>
          <div class="early-payment-tooltip" id="early-payment-tooltip"></div>
        </div>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-dot principal"></span>
            Основной долг
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-dot interest"></span>
            Проценты
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="schedule-table-wrapper">
        <div class="schedule-table-header">
          <h3 class="schedule-table-title">Детализация платежей</h3>
          <div class="schedule-view-toggle">
            <button class="view-toggle-btn active" data-view="yearly" type="button">По годам</button>
            <button class="view-toggle-btn" data-view="monthly" type="button">По месяцам</button>
          </div>
        </div>
        <div class="schedule-table-container" id="schedule-table-container">
          <table class="schedule-table" id="schedule-table">
            <thead>
              <tr>
                <th>Период</th>
                <th>Платёж</th>
                <th>Основной долг</th>
                <th>Проценты</th>
                <th>Остаток</th>
              </tr>
            </thead>
            <tbody id="schedule-table-body">
              <!-- Rows will be generated by JS -->
            </tbody>
          </table>
        </div>
        <div class="schedule-table-resize-handle" id="table-resize-handle">
          <div class="resize-handle-bar"></div>
        </div>
      </div>
    </section>

    <section class="tips-section" aria-labelledby="tips-heading">
      <h2 class="tips-title" id="tips-heading">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Полезные советы
      </h2>
      <div class="tips-grid">
        <article class="tip-card">
          <h3>Первоначальный взнос</h3>
          <p>Чем больше первоначальный взнос, тем меньше переплата по кредиту. Рекомендуется вносить не менее 20% от стоимости жилья.</p>
        </article>
        <article class="tip-card">
          <h3>Сравнивайте предложения</h3>
          <p>Разница в ставке даже в 0.5% может сэкономить сотни тысяч рублей за весь срок кредита. Изучите предложения нескольких банков.</p>
        </article>
        <article class="tip-card">
          <h3>Досрочное погашение</h3>
          <p>Большинство банков позволяют досрочно погашать ипотеку без штрафов. Это значительно сокращает переплату по процентам.</p>
        </article>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <p class="footer-author">Made by Евгений Пятков</p>
      <a href="https://t.me/that_ai_guy" target="_blank" rel="noopener noreferrer" class="footer-link">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
        </svg>
        @that_ai_guy
      </a>
    </div>
  </footer>

  <!-- Watermark for screenshots -->
  <a href="https://t.me/that_ai_guy" target="_blank" rel="noopener noreferrer" class="watermark">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
    </svg>
    @that_ai_guy
  </a>

  <script>
    // ===== FETCH KEY RATE FROM CBR =====
    (async function fetchKeyRate() {
      const rateEl = document.getElementById('key-rate-value');
      const dateEl = document.getElementById('key-rate-date');

      try {
        // Try multiple CORS proxies
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateStr = `${day}/${month}/${year}`;

        const cbrUrl = `https://www.cbr.ru/scripts/XML_KeyRate.asp?date_req1=01/01/${year}&date_req2=${dateStr}`;

        const proxies = [
          `https://corsproxy.io/?${encodeURIComponent(cbrUrl)}`,
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(cbrUrl)}`,
        ];

        let xmlText = null;
        for (const proxyUrl of proxies) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(proxyUrl, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (response.ok) {
              const text = await response.text();
              if (text.includes('<Record')) {
                xmlText = text;
                break;
              }
            }
          } catch (err) {
            continue;
          }
        }

        if (!xmlText) throw new Error('All proxies failed');

        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, 'text/xml');

        const records = xml.querySelectorAll('Record');
        if (records.length === 0) throw new Error('No data');

        // Get current rate from the last record
        const lastRecord = records[records.length - 1];
        const currentRate = lastRecord.querySelector('Rate')?.textContent?.replace(',', '.');

        // Find when this rate was first set (date of change)
        let changeDateRaw = lastRecord.getAttribute('Date');
        for (let i = records.length - 1; i >= 0; i--) {
          const record = records[i];
          const rate = record.querySelector('Rate')?.textContent?.replace(',', '.');
          if (rate !== currentRate) {
            // Previous record had different rate, so next one is when it changed
            if (i + 1 < records.length) {
              changeDateRaw = records[i + 1].getAttribute('Date');
            }
            break;
          }
          changeDateRaw = record.getAttribute('Date');
        }

        if (currentRate && changeDateRaw) {
          const dateParts = changeDateRaw.split('.');
          const shortDate = `${dateParts[0]}.${dateParts[1]}.${dateParts[2].slice(-2)}`;

          rateEl.textContent = `${parseFloat(currentRate)}%`;
          dateEl.textContent = `от ${shortDate}`;
        }
      } catch (e) {
        // Fallback values already in HTML
        console.log('Using fallback key rate:', e.message);
      }
    })();

    // Format number with spaces as thousand separators
    function formatNumber(num) {
      return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Parse formatted number back to integer
    function parseFormattedNumber(str) {
      return parseInt(str.replace(/\s/g, ''), 10) || 0;
    }

    // Calculate monthly payment (annuity formula)
    function calculateAnnuityPayment(principal, annualRate, years) {
      if (principal <= 0 || annualRate <= 0 || years <= 0) return 0;

      const monthlyRate = annualRate / 100 / 12;
      const numberOfPayments = years * 12;

      const monthlyPayment = principal *
        (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) /
        (Math.pow(1 + monthlyRate, numberOfPayments) - 1);

      return monthlyPayment;
    }

    // Calculate differentiated payment (returns first, last, and total)
    function calculateDifferentiatedPayment(principal, annualRate, years) {
      if (principal <= 0 || annualRate <= 0 || years <= 0) {
        return { first: 0, last: 0, total: 0, totalInterest: 0 };
      }

      const monthlyRate = annualRate / 100 / 12;
      const numberOfPayments = years * 12;
      const principalPart = principal / numberOfPayments;

      let totalPayment = 0;
      let remainingPrincipal = principal;
      let firstPayment = 0;
      let lastPayment = 0;

      for (let month = 1; month <= numberOfPayments; month++) {
        const interestPart = remainingPrincipal * monthlyRate;
        const monthlyPayment = principalPart + interestPart;

        if (month === 1) firstPayment = monthlyPayment;
        if (month === numberOfPayments) lastPayment = monthlyPayment;

        totalPayment += monthlyPayment;
        remainingPrincipal -= principalPart;
      }

      return {
        first: firstPayment,
        last: lastPayment,
        total: totalPayment,
        totalInterest: totalPayment - principal
      };
    }

    // DOM elements
    const propertyPriceInput = document.getElementById('property-price');
    const propertyPriceRange = document.getElementById('property-price-range');
    const downPaymentInput = document.getElementById('down-payment');
    const downPaymentRange = document.getElementById('down-payment-range');
    const downPaymentPercent = document.getElementById('down-payment-percent');
    const interestRateInput = document.getElementById('interest-rate');
    const interestRateRange = document.getElementById('interest-rate-range');
    const termRadios = document.querySelectorAll('input[name="term"]');

    // Result elements
    const paymentAmountEl = document.getElementById('payment-amount');
    const loanAmountEl = document.getElementById('loan-amount');
    const totalPaymentEl = document.getElementById('total-payment');
    const totalInterestEl = document.getElementById('total-interest');
    const paymentTypeLabelEl = document.getElementById('payment-type-label');
    const paymentRangeEl = document.getElementById('payment-range');

    // Payment type radios
    const paymentTypeRadios = document.querySelectorAll('input[name="payment-type"]');

    // Pie chart elements
    const piePrincipalEl = document.getElementById('pie-principal');
    const piePercentDisplayEl = document.getElementById('pie-percent-display');
    const legendPrincipalAmountEl = document.getElementById('legend-principal-amount');
    const legendPrincipalPercentEl = document.getElementById('legend-principal-percent');
    const legendInterestAmountEl = document.getElementById('legend-interest-amount');
    const legendInterestPercentEl = document.getElementById('legend-interest-percent');

    // Circle circumference for r=40
    const circumference = 2 * Math.PI * 40;

    // Custom term elements
    const termCustomWrapper = document.getElementById('term-custom-wrapper');
    const termCustomInput = document.getElementById('term-custom');
    let useCustomTerm = false;

    // Get current values
    function getValues() {
      const propertyPrice = parseFormattedNumber(propertyPriceInput.value);
      const downPayment = parseFormattedNumber(downPaymentInput.value);
      const interestRate = parseFloat(interestRateInput.value.replace(',', '.')) || 0;

      let term;
      if (useCustomTerm && termCustomInput.value) {
        term = parseInt(termCustomInput.value, 10) || 20;
        term = Math.max(1, Math.min(50, term)); // Limit 1-50 years
      } else {
        const checkedRadio = document.querySelector('input[name="term"]:checked');
        term = checkedRadio ? parseInt(checkedRadio.value, 10) : 20;
      }

      const paymentTypeRadio = document.querySelector('input[name="payment-type"]:checked');
      const paymentType = paymentTypeRadio ? paymentTypeRadio.value : 'annuity';

      return { propertyPrice, downPayment, interestRate, term, paymentType };
    }

    // Update all calculations
    function updateCalculations() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();

      // Calculate loan amount
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      let monthlyPayment, totalPayment, totalInterest;

      if (paymentType === 'differentiated') {
        // Differentiated payment
        const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
        monthlyPayment = diff.first; // Show first (highest) payment
        totalPayment = diff.total;
        totalInterest = diff.totalInterest;

        // Update labels for differentiated
        paymentTypeLabelEl.textContent = 'Первый платёж';
        paymentRangeEl.style.display = 'block';
        paymentRangeEl.textContent = `от ${formatNumber(diff.last)} ₽ до ${formatNumber(diff.first)} ₽`;
      } else {
        // Annuity payment
        monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        totalPayment = monthlyPayment * term * 12;
        totalInterest = totalPayment - loanAmount;

        // Update labels for annuity
        paymentTypeLabelEl.textContent = 'Аннуитетный платёж';
        paymentRangeEl.style.display = 'none';
      }

      // Update display
      paymentAmountEl.textContent = formatNumber(monthlyPayment);
      loanAmountEl.textContent = formatNumber(loanAmount) + ' ₽';
      totalPaymentEl.textContent = formatNumber(totalPayment) + ' ₽';
      totalInterestEl.textContent = formatNumber(totalInterest) + ' ₽';

      // Update pie chart
      if (totalPayment > 0) {
        const principalPercent = (loanAmount / totalPayment) * 100;
        const interestPercent = 100 - principalPercent;

        // Calculate stroke-dasharray for donut chart
        const principalDash = (principalPercent / 100) * circumference;
        piePrincipalEl.style.strokeDasharray = `${principalDash} ${circumference}`;

        // Update center percentage display
        piePercentDisplayEl.textContent = principalPercent.toFixed(1) + '%';

        // Update legend
        legendPrincipalAmountEl.textContent = formatNumber(loanAmount) + ' ₽';
        legendPrincipalPercentEl.textContent = principalPercent.toFixed(1) + '%';
        legendInterestAmountEl.textContent = formatNumber(totalInterest) + ' ₽';
        legendInterestPercentEl.textContent = interestPercent.toFixed(1) + '%';
      }

      // Update down payment range max and percent
      downPaymentRange.max = propertyPrice;
      if (propertyPrice > 0) {
        const percent = Math.round((downPayment / propertyPrice) * 100);
        downPaymentPercent.textContent = percent + '%';
      }

      // Update schedule chart and table
      updateSchedule();

      // Save to localStorage
      saveToStorage();
    }

    // Sync input with range slider
    function syncInputWithRange(input, range, isRate = false) {
      input.addEventListener('input', () => {
        if (isRate) {
          const value = parseFloat(input.value.replace(',', '.')) || 0;
          range.value = value;
        } else {
          const value = parseFormattedNumber(input.value);
          range.value = value;
          input.value = formatNumber(value);
        }
        updateCalculations();
      });

      range.addEventListener('input', () => {
        if (isRate) {
          input.value = range.value;
        } else {
          input.value = formatNumber(parseInt(range.value, 10));
        }
        updateCalculations();
      });

      // Format on blur
      if (!isRate) {
        input.addEventListener('blur', () => {
          const value = parseFormattedNumber(input.value);
          input.value = formatNumber(value);
        });
      }
    }

    // Initialize syncing
    syncInputWithRange(propertyPriceInput, propertyPriceRange);
    syncInputWithRange(downPaymentInput, downPaymentRange);
    syncInputWithRange(interestRateInput, interestRateRange, true);

    // Payment type selection
    paymentTypeRadios.forEach(radio => {
      radio.addEventListener('change', updateCalculations);
    });

    // Term selection
    termRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        useCustomTerm = false;
        termCustomWrapper.classList.remove('active');
        termCustomInput.value = '';
        updateCalculations();
      });
    });

    // Custom term input
    termCustomWrapper.addEventListener('click', () => {
      termCustomInput.focus();
    });

    termCustomInput.addEventListener('focus', () => {
      useCustomTerm = true;
      termCustomWrapper.classList.add('active');
      // Uncheck all radio buttons
      termRadios.forEach(radio => radio.checked = false);
    });

    termCustomInput.addEventListener('input', () => {
      // Only allow numbers
      termCustomInput.value = termCustomInput.value.replace(/\D/g, '');
      // Limit to max 30 years
      const value = parseInt(termCustomInput.value, 10);
      if (value > 30) {
        termCustomInput.value = '30';
      }
      updateCalculations();
    });

    termCustomInput.addEventListener('blur', () => {
      if (!termCustomInput.value) {
        // If empty, revert to default
        useCustomTerm = false;
        termCustomWrapper.classList.remove('active');
        document.getElementById('term-20').checked = true;
        updateCalculations();
      }
    });

    // ===== SCHEDULE SECTION =====
    const scheduleChartSvg = document.getElementById('schedule-chart-svg');
    const scheduleTableBody = document.getElementById('schedule-table-body');
    const scheduleTableContainer = document.getElementById('schedule-table-container');
    const tableResizeHandle = document.getElementById('table-resize-handle');
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    const chartTooltip = document.getElementById('chart-tooltip');
    const chartContainer = scheduleChartSvg.parentElement;
    const earlyPaymentTooltip = document.getElementById('early-payment-tooltip');

    let currentView = 'yearly';
    let currentSchedule = null; // Store current schedule for view switching

    // Early payment star tooltip handlers
    function showEarlyPaymentTooltip(e) {
      const star = e.target;
      const text = star.getAttribute('data-tooltip');
      if (!text) return;

      earlyPaymentTooltip.textContent = text;
      earlyPaymentTooltip.classList.add('visible');

      const rect = star.getBoundingClientRect();
      const tooltipRect = earlyPaymentTooltip.getBoundingClientRect();

      let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
      let top = rect.top - tooltipRect.height - 10;

      // Keep tooltip within viewport
      if (left < 10) left = 10;
      if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
      }
      if (top < 10) {
        top = rect.bottom + 10;
        earlyPaymentTooltip.style.setProperty('--arrow-position', 'top');
      }

      earlyPaymentTooltip.style.left = left + 'px';
      earlyPaymentTooltip.style.top = top + 'px';
    }

    function hideEarlyPaymentTooltip() {
      earlyPaymentTooltip.classList.remove('visible');
    }

    // Use event delegation for dynamically created stars
    scheduleTableBody.addEventListener('mouseenter', (e) => {
      if (e.target.classList.contains('early-payment-star')) {
        showEarlyPaymentTooltip(e);
      }
    }, true);

    scheduleTableBody.addEventListener('mouseleave', (e) => {
      if (e.target.classList.contains('early-payment-star')) {
        hideEarlyPaymentTooltip();
      }
    }, true);

    // Table resize functionality
    const MIN_TABLE_HEIGHT = 150;
    const MAX_TABLE_HEIGHT = 800;
    const DEFAULT_TABLE_HEIGHT = 400;

    // Restore saved table height from localStorage
    const savedTableHeight = localStorage.getItem('scheduleTableHeight');
    if (savedTableHeight) {
      const height = parseInt(savedTableHeight);
      if (height >= MIN_TABLE_HEIGHT && height <= MAX_TABLE_HEIGHT) {
        scheduleTableContainer.style.maxHeight = height + 'px';
      }
    }

    let isResizing = false;
    let startY = 0;
    let startHeight = 0;

    function startResize(e) {
      isResizing = true;
      startY = e.clientY || e.touches[0].clientY;
      startHeight = scheduleTableContainer.offsetHeight;
      tableResizeHandle.classList.add('dragging');
      document.body.style.cursor = 'ns-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    }

    function doResize(e) {
      if (!isResizing) return;
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      if (clientY === undefined) return;

      const deltaY = clientY - startY;
      let newHeight = startHeight + deltaY;

      // Clamp to min/max
      newHeight = Math.max(MIN_TABLE_HEIGHT, Math.min(MAX_TABLE_HEIGHT, newHeight));

      scheduleTableContainer.style.maxHeight = newHeight + 'px';
    }

    function stopResize() {
      if (!isResizing) return;
      isResizing = false;
      tableResizeHandle.classList.remove('dragging');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';

      // Save height to localStorage
      const currentHeight = scheduleTableContainer.offsetHeight;
      localStorage.setItem('scheduleTableHeight', currentHeight.toString());
    }

    // Mouse events
    tableResizeHandle.addEventListener('mousedown', startResize);
    document.addEventListener('mousemove', doResize);
    document.addEventListener('mouseup', stopResize);

    // Touch events for mobile
    tableResizeHandle.addEventListener('touchstart', startResize, { passive: false });
    document.addEventListener('touchmove', doResize, { passive: true });
    document.addEventListener('touchend', stopResize);
    document.addEventListener('touchcancel', stopResize);

    // Chart tooltip functionality
    function showChartTooltip(e, barGroup) {
      const year = barGroup.dataset.year;
      const principal = parseInt(barGroup.dataset.principal);
      const interest = parseInt(barGroup.dataset.interest);
      const total = parseInt(barGroup.dataset.total);
      const yearPrincipal = parseInt(barGroup.dataset.yearPrincipal);
      const yearInterest = parseInt(barGroup.dataset.yearInterest);
      const balance = parseInt(barGroup.dataset.balance);

      chartTooltip.innerHTML = `
        <div class="chart-tooltip-title">${year}-й год</div>
        <div class="chart-tooltip-row">
          <span class="chart-tooltip-label">Платёж/мес:</span>
          <span class="chart-tooltip-value">${formatNumber(total)} ₽</span>
        </div>
        <div class="chart-tooltip-row">
          <span class="chart-tooltip-label">Основной долг:</span>
          <span class="chart-tooltip-value principal">${formatNumber(principal)} ₽</span>
        </div>
        <div class="chart-tooltip-row">
          <span class="chart-tooltip-label">Проценты:</span>
          <span class="chart-tooltip-value interest">${formatNumber(interest)} ₽</span>
        </div>
        <div class="chart-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.15);">
          <span class="chart-tooltip-label">За год:</span>
          <span class="chart-tooltip-value">${formatNumber(yearPrincipal + yearInterest)} ₽</span>
        </div>
        <div class="chart-tooltip-row">
          <span class="chart-tooltip-label">Остаток:</span>
          <span class="chart-tooltip-value">${formatNumber(balance)} ₽</span>
        </div>
      `;

      // Position tooltip
      const containerRect = chartContainer.getBoundingClientRect();
      const svgRect = scheduleChartSvg.getBoundingClientRect();
      const tooltipWidth = chartTooltip.offsetWidth || 180;
      const tooltipHeight = chartTooltip.offsetHeight || 150;

      let left = e.clientX - containerRect.left + 15;
      let top = e.clientY - containerRect.top - tooltipHeight / 2;

      // Keep tooltip within container bounds
      if (left + tooltipWidth > containerRect.width) {
        left = e.clientX - containerRect.left - tooltipWidth - 15;
      }
      if (top < 0) top = 10;
      if (top + tooltipHeight > containerRect.height) {
        top = containerRect.height - tooltipHeight - 10;
      }

      chartTooltip.style.left = left + 'px';
      chartTooltip.style.top = top + 'px';
      chartTooltip.classList.add('visible');
    }

    function hideChartTooltip() {
      chartTooltip.classList.remove('visible');
    }

    // Attach tooltip events using event delegation
    scheduleChartSvg.addEventListener('mousemove', (e) => {
      const barGroup = e.target.closest('.chart-bar-group');
      if (barGroup) {
        showChartTooltip(e, barGroup);
      } else {
        hideChartTooltip();
      }
    });

    scheduleChartSvg.addEventListener('mouseleave', hideChartTooltip);

    // View toggle
    const scheduleViewToggle = document.querySelector('.schedule-view-toggle');
    viewToggleBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        viewToggleBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        // Toggle class for sliding animation
        scheduleViewToggle.classList.toggle('monthly-view', btn.dataset.view === 'monthly');
        updateScheduleTable();
      });
    });

    // Generate full payment schedule
    function generateSchedule(principal, annualRate, years, paymentType) {
      const monthlyRate = annualRate / 100 / 12;
      const totalMonths = years * 12;
      const schedule = [];
      let balance = principal;

      if (paymentType === 'annuity') {
        const monthlyPayment = calculateAnnuityPayment(principal, annualRate, years);

        for (let month = 1; month <= totalMonths; month++) {
          const interestPayment = balance * monthlyRate;
          const principalPayment = monthlyPayment - interestPayment;
          balance = Math.max(0, balance - principalPayment);

          schedule.push({
            month,
            year: Math.ceil(month / 12),
            payment: monthlyPayment,
            principal: principalPayment,
            interest: interestPayment,
            balance
          });
        }
      } else {
        // Differentiated
        const principalPart = principal / totalMonths;

        for (let month = 1; month <= totalMonths; month++) {
          const interestPayment = balance * monthlyRate;
          const payment = principalPart + interestPayment;
          balance = Math.max(0, balance - principalPart);

          schedule.push({
            month,
            year: Math.ceil(month / 12),
            payment,
            principal: principalPart,
            interest: interestPayment,
            balance
          });
        }
      }

      return schedule;
    }

    // Aggregate schedule by year
    function aggregateByYear(schedule) {
      const years = {};

      schedule.forEach(item => {
        if (!years[item.year]) {
          years[item.year] = {
            year: item.year,
            payment: 0,
            principal: 0,
            interest: 0,
            balance: 0,
            monthCount: 0,
            earlyPayment: 0
          };
        }
        years[item.year].payment += item.payment;
        years[item.year].principal += item.principal;
        years[item.year].interest += item.interest;
        years[item.year].balance = item.balance;
        years[item.year].monthCount++;
        if (item.earlyPayment) {
          years[item.year].earlyPayment += item.earlyPayment;
        }
      });

      return Object.values(years);
    }

    // Format amount for axis labels (short form)
    function formatShortAmount(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace('.0', '') + ' млн';
      } else if (num >= 1000) {
        return Math.round(num / 1000) + ' тыс';
      }
      return Math.round(num).toString();
    }

    // Draw stacked area chart with axes
    function drawChart(schedule, initialPrincipal) {
      const yearlyData = aggregateByYear(schedule);
      const svgWidth = 650;
      const svgHeight = 240;
      const margin = { top: 20, right: 20, bottom: 35, left: 70 };

      const chartWidth = svgWidth - margin.left - margin.right;
      const chartHeight = svgHeight - margin.top - margin.bottom;
      const bottomY = margin.top + chartHeight; // Base line for animation origin

      // Show average monthly principal and interest for each year
      // Use actual month count (last year may have fewer than 12 months)
      const monthlyData = yearlyData.map(d => ({
        year: d.year,
        principal: d.principal / d.monthCount,
        interest: d.interest / d.monthCount,
        total: (d.principal + d.interest) / d.monthCount
      }));

      // Find max monthly payment for Y axis
      const maxPayment = Math.max(...monthlyData.map(d => d.total));
      // Round up to nice number for axis
      const yAxisMax = Math.ceil(maxPayment / 10000) * 10000;

      const numYears = monthlyData.length;
      const barWidth = chartWidth / numYears;

      let html = '';

      // Grid lines and Y axis labels
      const yTicks = 5;
      for (let i = 0; i <= yTicks; i++) {
        const value = (yAxisMax / yTicks) * i;
        const y = margin.top + chartHeight - (chartHeight * i / yTicks);

        // Grid line
        html += `<line class="chart-grid-line" x1="${margin.left}" y1="${y}" x2="${svgWidth - margin.right}" y2="${y}"/>`;

        // Y axis label
        html += `<text class="chart-axis-label chart-axis-label-y" x="${margin.left - 8}" y="${y + 4}">${formatShortAmount(value)} ₽</text>`;
      }

      // Build stacked bars with tooltips
      monthlyData.forEach((data, i) => {
        const x = margin.left + i * barWidth + barWidth * 0.1;
        const rectWidth = barWidth * 0.8;

        const principalHeight = (data.principal / yAxisMax) * chartHeight;
        const interestHeight = (data.interest / yAxisMax) * chartHeight;

        const principalY = margin.top + chartHeight - principalHeight;
        const interestY = principalY - interestHeight;

        // Animation delay for staggered effect
        const animDelay = i * 0.04;
        const centerX = x + rectWidth / 2;

        // Group for hover effect with data attributes for tooltip
        const yearData = yearlyData[i];
        html += `<g class="chart-bar-group"
          data-year="${data.year}"
          data-principal="${Math.round(data.principal)}"
          data-interest="${Math.round(data.interest)}"
          data-total="${Math.round(data.total)}"
          data-year-principal="${Math.round(yearData.principal)}"
          data-year-interest="${Math.round(yearData.interest)}"
          data-balance="${Math.round(yearData.balance)}">`;

        // Invisible rect for better hover area
        html += `<rect x="${x}" y="${interestY}" width="${rectWidth}" height="${principalHeight + interestHeight}" fill="transparent"/>`;
        // Interest on top (darker) - rounded only at top
        if (interestHeight > 0) {
          html += `<path class="chart-area-interest" style="transform-origin: ${centerX}px ${bottomY}px; animation-delay: ${animDelay}s" d="
            M${x + 3},${interestY}
            Q${x},${interestY} ${x},${interestY + 3}
            L${x},${interestY + interestHeight}
            L${x + rectWidth},${interestY + interestHeight}
            L${x + rectWidth},${interestY + 3}
            Q${x + rectWidth},${interestY} ${x + rectWidth - 3},${interestY}
            Z"/>`;
        }
        // Principal on bottom (lighter) - rounded only at bottom
        html += `<path class="chart-area-principal" style="transform-origin: ${centerX}px ${bottomY}px; animation-delay: ${animDelay}s" d="
          M${x},${principalY}
          L${x},${margin.top + chartHeight - 3}
          Q${x},${margin.top + chartHeight} ${x + 3},${margin.top + chartHeight}
          L${x + rectWidth - 3},${margin.top + chartHeight}
          Q${x + rectWidth},${margin.top + chartHeight} ${x + rectWidth},${margin.top + chartHeight - 3}
          L${x + rectWidth},${principalY}
          Z"/>`;
        html += `</g>`;

        // X axis year label (show every year for short terms, skip for long)
        const showLabel = numYears <= 15 || i % 2 === 0 || i === numYears - 1;
        if (showLabel) {
          html += `<text class="chart-year-label" x="${x + rectWidth / 2}" y="${svgHeight - margin.bottom + 16}">${data.year}</text>`;
        }
      });

      // X axis label
      html += `<text class="chart-axis-label chart-axis-label-x" x="${margin.left + chartWidth / 2}" y="${svgHeight - 5}">Год кредита</text>`;

      scheduleChartSvg.innerHTML = html;
    }

    // Update schedule table
    function updateScheduleTable() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      if (loanAmount <= 0 || interestRate <= 0 || term <= 0) {
        scheduleTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--warm-gray);">Введите параметры кредита</td></tr>';
        return;
      }

      // Use stored schedule if available (includes early repayments), otherwise generate new
      const schedule = currentSchedule || generateSchedule(loanAmount, interestRate, term, paymentType);
      const data = currentView === 'yearly' ? aggregateByYear(schedule) : schedule;

      let html = '';
      data.forEach(item => {
        const period = currentView === 'yearly' ? `${item.year} год` : `${item.month} мес.`;
        const hasEarly = item.earlyPayment && item.earlyPayment > 0;
        const earlyTooltip = hasEarly ? `Досрочное погашение: ${formatNumber(item.earlyPayment)} ₽` : '';
        html += `
          <tr${hasEarly ? ' style="background: rgba(212, 160, 60, 0.08);"' : ''}>
            <td>${period}${hasEarly ? ` <span class="early-payment-star" data-tooltip="${earlyTooltip}">★</span>` : ''}</td>
            <td>${formatNumber(item.payment)} ₽</td>
            <td class="principal-cell">${formatNumber(item.principal)} ₽</td>
            <td class="interest-cell">${formatNumber(item.interest)} ₽</td>
            <td class="balance-cell">${formatNumber(item.balance)} ₽</td>
          </tr>
        `;
      });

      scheduleTableBody.innerHTML = html;
    }

    // Update full schedule (chart + table)
    function updateSchedule() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      if (loanAmount <= 0 || interestRate <= 0 || term <= 0) {
        scheduleChartSvg.innerHTML = '';
        scheduleTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--warm-gray);">Введите параметры кредита</td></tr>';
        currentSchedule = null;
        return;
      }

      const schedule = generateSchedule(loanAmount, interestRate, term, paymentType);
      currentSchedule = schedule; // Store for view switching
      drawChart(schedule, loanAmount);
      updateScheduleTable();
    }

    // ===== LOCAL STORAGE =====
    const STORAGE_KEY = 'mortgage-calculator-data';

    function saveToStorage() {
      const data = {
        propertyPrice: parseFormattedNumber(propertyPriceInput.value),
        downPayment: parseFormattedNumber(downPaymentInput.value),
        interestRate: interestRateInput.value,
        term: useCustomTerm ? termCustomInput.value : null,
        termRadio: useCustomTerm ? null : document.querySelector('input[name="term"]:checked')?.value,
        paymentType: document.querySelector('input[name="payment-type"]:checked')?.value || 'annuity',
        earlyRepayments: getEarlyRepaymentsData()
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        // localStorage may be unavailable (private browsing, etc.)
      }
    }

    // Helper to get early repayments from DOM
    function getEarlyRepaymentsData() {
      const list = document.getElementById('early-repayments-list');
      if (!list) return [];
      const items = list.querySelectorAll('.early-repayment-item');
      const data = [];
      items.forEach(item => {
        const month = parseInt(item.querySelector('.repayment-month').value, 10);
        const amount = parseFormattedNumber(item.querySelector('.repayment-amount').value);
        const type = item.querySelector('.repayment-type').value;
        const frequency = item.querySelector('.repayment-frequency').value;
        data.push({ month, amount, type, frequency });
      });
      return data;
    }

    function loadFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return false;

        const data = JSON.parse(stored);

        // Restore property price
        if (data.propertyPrice) {
          propertyPriceInput.value = formatNumber(data.propertyPrice);
          propertyPriceRange.value = data.propertyPrice;
        }

        // Restore down payment
        if (data.downPayment !== undefined) {
          downPaymentInput.value = formatNumber(data.downPayment);
          downPaymentRange.value = data.downPayment;
        }

        // Restore interest rate
        if (data.interestRate) {
          interestRateInput.value = data.interestRate;
          interestRateRange.value = parseFloat(data.interestRate.replace(',', '.')) || 18;
        }

        // Restore term
        if (data.term) {
          // Custom term
          useCustomTerm = true;
          termCustomWrapper.classList.add('active');
          termCustomInput.value = data.term;
          termRadios.forEach(radio => radio.checked = false);
        } else if (data.termRadio) {
          // Radio term
          const radio = document.getElementById('term-' + data.termRadio);
          if (radio) radio.checked = true;
        }

        // Restore payment type
        if (data.paymentType) {
          const radio = document.getElementById('payment-' + data.paymentType);
          if (radio) radio.checked = true;
        }

        // Restore early repayments (will be handled after DOM is ready)
        if (data.earlyRepayments && data.earlyRepayments.length > 0) {
          window._pendingEarlyRepayments = data.earlyRepayments;
        }

        return true;
      } catch (e) {
        return false;
      }
    }

    // Handle keyboard input for formatted fields
    [propertyPriceInput, downPaymentInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        // Allow only numbers, backspace, delete, arrows
        if (!/[\d]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
          // Allow navigation keys
          if (!['ArrowLeft', 'ArrowRight', 'Home', 'End', 'Tab'].includes(e.key)) {
            e.preventDefault();
          }
        }
      });
    });

    // ===== URL SHARING =====
    function saveToUrl() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const params = new URLSearchParams();
      params.set('p', propertyPrice);
      params.set('d', downPayment);
      params.set('r', interestRate);
      params.set('t', term);
      params.set('type', paymentType === 'differentiated' ? 'diff' : 'ann');

      // Add early repayments if any
      const earlyData = getEarlyRepaymentsData();
      if (earlyData.length > 0) {
        // Compact format: month,amount,type,frequency|month,amount,type,frequency
        const erStr = earlyData.map(er =>
          `${er.month},${er.amount},${er.type === 'reduce-term' ? 't' : 'p'},${er.frequency === 'monthly' ? 'm' : 'o'}`
        ).join('|');
        params.set('er', erStr);
      }

      const newUrl = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newUrl);
    }

    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('p')) return false;

      const propertyPrice = parseInt(params.get('p'), 10);
      const downPayment = parseInt(params.get('d'), 10) || 0;
      const rate = params.get('r') || '18';
      const term = parseInt(params.get('t'), 10) || 20;
      const paymentType = params.get('type') === 'diff' ? 'differentiated' : 'annuity';

      // Restore values
      if (propertyPrice) {
        propertyPriceInput.value = formatNumber(propertyPrice);
        propertyPriceRange.value = propertyPrice;
      }

      downPaymentInput.value = formatNumber(downPayment);
      downPaymentRange.value = downPayment;

      interestRateInput.value = rate;
      interestRateRange.value = parseFloat(rate.replace(',', '.')) || 18;

      // Set term
      const termRadio = document.getElementById('term-' + term);
      if (termRadio) {
        termRadio.checked = true;
      } else {
        useCustomTerm = true;
        termCustomWrapper.classList.add('active');
        termCustomInput.value = term;
        termRadios.forEach(radio => radio.checked = false);
      }

      // Set payment type
      const paymentRadio = document.getElementById('payment-' + paymentType);
      if (paymentRadio) paymentRadio.checked = true;

      // Parse early repayments from URL
      const erStr = params.get('er');
      if (erStr) {
        const earlyData = erStr.split('|').map(part => {
          const [month, amount, type, frequency] = part.split(',');
          return {
            month: parseInt(month, 10),
            amount: parseInt(amount, 10),
            type: type === 't' ? 'reduce-term' : 'reduce-payment',
            frequency: frequency === 'm' ? 'monthly' : 'once'
          };
        });
        window._pendingEarlyRepayments = earlyData;
      }

      return true;
    }

    // Load from URL first (has priority), then localStorage
    let isInitializing = true;
    if (!loadFromUrl()) {
      loadFromStorage();
    }

    // Initial calculation
    updateCalculations();

    // Update URL when values change (debounced)
    let urlUpdateTimeout;
    const originalUpdateCalculations = updateCalculations;
    updateCalculations = function() {
      originalUpdateCalculations();
      if (!isInitializing) {
        clearTimeout(urlUpdateTimeout);
        urlUpdateTimeout = setTimeout(saveToUrl, 300);
      }
    };

    // ===== DOWNLOAD IMAGE =====
    const downloadBtn = document.getElementById('download-btn');

    function generateImage() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      let monthlyPaymentDisplay, totalPayment, totalInterest;
      let paymentLabel;
      let firstPayment, lastPayment;

      if (paymentType === 'differentiated') {
        const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
        firstPayment = diff.first;
        lastPayment = diff.last;
        monthlyPaymentDisplay = formatNumber(firstPayment) + ' → ' + formatNumber(lastPayment);
        totalPayment = diff.total;
        totalInterest = diff.totalInterest;
        paymentLabel = 'Дифференцированный (от первого к последнему)';
      } else {
        const monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        monthlyPaymentDisplay = formatNumber(monthlyPayment);
        totalPayment = monthlyPayment * term * 12;
        totalInterest = totalPayment - loanAmount;
        paymentLabel = 'Аннуитетный платёж';
      }

      const principalPercent = totalPayment > 0 ? (loanAmount / totalPayment) * 100 : 0;
      const interestPercent = 100 - principalPercent;

      // Site colors
      const colors = {
        cream: '#FDF8F3',
        creamDark: '#F5EDE4',
        terracotta: '#C65D3B',
        terracottaLight: '#E07B5A',
        forest: '#2D4A3E',
        charcoal: '#2C2C2C',
        warmGray: '#6B6560',
        gold: '#D4A03C',
        goldLight: '#F0C864'
      };

      // Generate schedule data for chart
      const schedule = generateSchedule(loanAmount, interestRate, term, paymentType);
      const yearlyData = aggregateByYear(schedule);
      const chartData = yearlyData.map(d => ({
        year: d.year,
        principal: d.principal / 12,
        interest: d.interest / 12,
        total: (d.principal + d.interest) / 12
      }));

      // Layout constants - LARGER TEXT
      const width = 600;
      const headerHeight = 160;
      const summaryHeight = 180; // Pie chart + summary section
      const detailsCount = 5;
      const detailLineHeight = 32;
      const chartBarHeight = 200;
      const pieRadius = 55;
      const pieRingWidth = 16;

      // Calculate dynamic height
      const detailsHeight = detailsCount * detailLineHeight + 35;
      const dividerSpace = 40;
      const chartTitleHeight = 20;
      const chartLegendHeight = 45;
      const footerHeight = 50;
      const bottomPadding = 20;

      const height = headerHeight + summaryHeight + detailsHeight + dividerSpace + chartTitleHeight + chartBarHeight + chartLegendHeight + footerHeight + bottomPadding;

      // Create canvas with calculated height
      const canvas = document.createElement('canvas');
      const scale = 2; // For retina
      canvas.width = width * scale;
      canvas.height = height * scale;
      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);

      // Background
      ctx.fillStyle = colors.cream;
      ctx.fillRect(0, 0, width, height);

      // Header section with forest background
      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(0, 0, width, headerHeight, [0, 0, 24, 24]);
      ctx.fill();

      // Title
      ctx.fillStyle = 'white';
      ctx.font = 'bold 22px system-ui, -apple-system, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Расчёт ипотеки', width / 2, 38);

      // Monthly payment - handle differentiated display
      const paymentFontSize = paymentType === 'differentiated' ? 36 : 48;
      ctx.font = `bold ${paymentFontSize}px system-ui, -apple-system, sans-serif`;
      ctx.fillText(monthlyPaymentDisplay + ' ₽/мес', width / 2, 100);

      ctx.font = '14px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
      ctx.fillText(paymentLabel, width / 2, 130);

      // === SUMMARY SECTION with Pie Chart ===
      let y = headerHeight + 30;

      // Pie chart on the left
      const pieCenterX = 100;
      const pieCenterY = y + pieRadius + 10;

      // Interest ring (background - full circle)
      ctx.beginPath();
      ctx.arc(pieCenterX, pieCenterY, pieRadius, 0, Math.PI * 2);
      ctx.strokeStyle = colors.terracottaLight;
      ctx.lineWidth = pieRingWidth;
      ctx.stroke();

      // Principal arc (gold)
      const principalAngle = (principalPercent / 100) * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(pieCenterX, pieCenterY, pieRadius, -Math.PI / 2, -Math.PI / 2 + principalAngle);
      ctx.strokeStyle = colors.gold;
      ctx.lineWidth = pieRingWidth;
      ctx.stroke();

      // Summary text on the right of pie chart
      const summaryX = 190;
      ctx.textAlign = 'left';

      // Total payment
      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Всего выплатите за ' + term + ' ' + (term === 1 ? 'год' : term < 5 ? 'года' : 'лет'), summaryX, y + 10);

      ctx.font = 'bold 28px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.fillText(formatNumber(totalPayment) + ' ₽', summaryX, y + 45);

      // Two columns: Principal and Interest
      const col1X = summaryX;
      const col2X = summaryX + 170;
      const rowY = y + 80;

      // Principal column
      ctx.fillStyle = colors.gold;
      ctx.beginPath();
      ctx.roundRect(col1X, rowY, 14, 14, 3);
      ctx.fill();

      ctx.font = '12px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Тело кредита', col1X + 20, rowY + 11);

      ctx.font = 'bold 18px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.fillText(formatNumber(loanAmount) + ' ₽', col1X, rowY + 38);

      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.gold;
      ctx.fillText(principalPercent.toFixed(1) + '%', col1X, rowY + 58);

      // Interest column
      ctx.fillStyle = colors.terracottaLight;
      ctx.beginPath();
      ctx.roundRect(col2X, rowY, 14, 14, 3);
      ctx.fill();

      ctx.font = '12px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.warmGray;
      ctx.fillText('Переплата', col2X + 20, rowY + 11);

      ctx.font = 'bold 18px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.terracotta;
      ctx.fillText(formatNumber(totalInterest) + ' ₽', col2X, rowY + 38);

      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.terracottaLight;
      ctx.fillText(interestPercent.toFixed(1) + '%', col2X, rowY + 58);

      // === DETAILS SECTION ===
      y = headerHeight + summaryHeight + 10;

      // Divider
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, y);
      ctx.lineTo(width - 30, y);
      ctx.stroke();

      y += 30;

      // Details - condensed list
      const details = [
        ['Стоимость недвижимости', formatNumber(propertyPrice) + ' ₽'],
        ['Первоначальный взнос', formatNumber(downPayment) + ' ₽ (' + Math.round(downPayment / propertyPrice * 100) + '%)'],
        ['Сумма кредита', formatNumber(loanAmount) + ' ₽'],
        ['Процентная ставка', interestRate + '% годовых'],
        ['Срок кредита', term + ' ' + (term === 1 ? 'год' : term < 5 ? 'года' : 'лет') + ' (' + (term * 12) + ' мес.)'],
      ];

      details.forEach(([label, value]) => {
        ctx.font = '15px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'left';
        ctx.fillText(label, 30, y);

        ctx.font = 'bold 15px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.charcoal;
        ctx.textAlign = 'right';
        ctx.fillText(value, width - 30, y);

        y += detailLineHeight;
      });

      // === CHART SECTION ===
      y += 15;

      // Divider before chart
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, y);
      ctx.lineTo(width - 30, y);
      ctx.stroke();

      y += 25;
      ctx.font = 'bold 16px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.charcoal;
      ctx.textAlign = 'left';
      ctx.fillText('Структура ежемесячного платежа по годам', 30, y);

      // Draw stacked bar chart
      const chartMargin = { left: 70, right: 30, top: y + 20, bottom: 50 };
      const chartWidth = width - chartMargin.left - chartMargin.right;

      // Find max payment for scale
      const maxPayment = Math.max(...chartData.map(d => d.total));
      const yAxisMax = Math.ceil(maxPayment / 10000) * 10000;

      // Draw grid lines
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const lineY = chartMargin.top + chartBarHeight - (chartBarHeight * i / 4);
        ctx.beginPath();
        ctx.moveTo(chartMargin.left, lineY);
        ctx.lineTo(width - chartMargin.right, lineY);
        ctx.stroke();

        // Y axis labels
        const labelValue = (yAxisMax / 4) * i;
        ctx.font = '11px system-ui, -apple-system, sans-serif';
        ctx.fillStyle = colors.warmGray;
        ctx.textAlign = 'right';
        ctx.fillText(formatShortAmount(labelValue), chartMargin.left - 8, lineY + 4);
      }

      // Draw bars
      const numBars = chartData.length;
      const barWidth = chartWidth / numBars;
      const barPadding = barWidth * 0.15;

      chartData.forEach((data, i) => {
        const x = chartMargin.left + i * barWidth + barPadding;
        const rectWidth = barWidth - barPadding * 2;

        const principalHeight = (data.principal / yAxisMax) * chartBarHeight;
        const interestHeight = (data.interest / yAxisMax) * chartBarHeight;

        const principalY = chartMargin.top + chartBarHeight - principalHeight;
        const interestY = principalY - interestHeight;

        // Interest bar (top)
        ctx.fillStyle = colors.terracottaLight;
        ctx.beginPath();
        ctx.roundRect(x, interestY, rectWidth, interestHeight, [3, 3, 0, 0]);
        ctx.fill();

        // Principal bar (bottom)
        ctx.fillStyle = colors.gold;
        ctx.beginPath();
        ctx.roundRect(x, principalY, rectWidth, principalHeight, [0, 0, 3, 3]);
        ctx.fill();

        // X axis labels (show every few years for long terms)
        const showLabel = numBars <= 15 || i % Math.ceil(numBars / 10) === 0 || i === numBars - 1;
        if (showLabel) {
          ctx.font = '11px system-ui, -apple-system, sans-serif';
          ctx.fillStyle = colors.warmGray;
          ctx.textAlign = 'center';
          ctx.fillText(data.year, x + rectWidth / 2, chartMargin.top + chartBarHeight + 18);
        }
      });

      // Chart legend
      const legendY = chartMargin.top + chartBarHeight + 42;
      ctx.font = '13px system-ui, -apple-system, sans-serif';
      ctx.textAlign = 'left';

      // Principal legend
      ctx.fillStyle = colors.gold;
      ctx.beginPath();
      ctx.roundRect(width / 2 - 140, legendY - 10, 14, 14, 3);
      ctx.fill();
      ctx.fillStyle = colors.charcoal;
      ctx.fillText('Основной долг', width / 2 - 120, legendY + 1);

      // Interest legend
      ctx.fillStyle = colors.terracottaLight;
      ctx.beginPath();
      ctx.roundRect(width / 2 + 30, legendY - 10, 14, 14, 3);
      ctx.fill();
      ctx.fillStyle = colors.charcoal;
      ctx.fillText('Проценты', width / 2 + 50, legendY + 1);

      // Footer with branding - clean separated section
      const footerTop = legendY + 25; // Position below legend

      // Footer separator line
      ctx.strokeStyle = colors.creamDark;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, footerTop);
      ctx.lineTo(width - 30, footerTop);
      ctx.stroke();

      const footerCenterY = footerTop + 25;

      // Logo icon (small house with chart)
      const logoSize = 28;
      const logoX = 30;
      const logoY = footerCenterY - logoSize / 2;

      // Draw logo background
      ctx.fillStyle = colors.forest;
      ctx.beginPath();
      ctx.roundRect(logoX, logoY, logoSize, logoSize, 5);
      ctx.fill();

      // Draw house roof
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1.8;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(logoX + 5, logoY + 14);
      ctx.lineTo(logoX + 14, logoY + 7);
      ctx.lineTo(logoX + 23, logoY + 14);
      ctx.stroke();

      // Draw house body
      ctx.beginPath();
      ctx.moveTo(logoX + 7, logoY + 13);
      ctx.lineTo(logoX + 7, logoY + 21);
      ctx.lineTo(logoX + 21, logoY + 21);
      ctx.lineTo(logoX + 21, logoY + 13);
      ctx.stroke();

      // Draw chart line inside house
      ctx.strokeStyle = colors.goldLight;
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(logoX + 9, logoY + 19);
      ctx.lineTo(logoX + 13, logoY + 15);
      ctx.lineTo(logoX + 16, logoY + 17);
      ctx.lineTo(logoX + 20, logoY + 13);
      ctx.stroke();

      // Chart dot
      ctx.fillStyle = colors.goldLight;
      ctx.beginPath();
      ctx.arc(logoX + 20, logoY + 13, 1.5, 0, Math.PI * 2);
      ctx.fill();

      // Brand name
      ctx.font = 'bold 16px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = colors.forest;
      ctx.textAlign = 'left';
      ctx.fillText('Формула ипотеки', logoX + logoSize + 12, footerCenterY + 5);

      // Telegram handle on the right with icon
      const tgText = '@that_ai_guy';
      ctx.font = '13px system-ui, -apple-system, sans-serif';
      const tgTextWidth = ctx.measureText(tgText).width;
      const tgRightX = width - 30;

      // Draw telegram icon (paper plane)
      const tgIconSize = 14;
      const tgIconX = tgRightX - tgTextWidth - tgIconSize - 8;
      const tgIconY = footerCenterY - tgIconSize / 2;

      ctx.fillStyle = colors.warmGray;
      ctx.beginPath();
      // Paper plane shape - scaled properly
      ctx.moveTo(tgIconX, tgIconY + tgIconSize * 0.4);
      ctx.lineTo(tgIconX + tgIconSize, tgIconY);
      ctx.lineTo(tgIconX + tgIconSize * 0.45, tgIconY + tgIconSize);
      ctx.lineTo(tgIconX + tgIconSize * 0.35, tgIconY + tgIconSize * 0.55);
      ctx.closePath();
      ctx.fill();

      // Inner fold
      ctx.beginPath();
      ctx.moveTo(tgIconX + tgIconSize * 0.35, tgIconY + tgIconSize * 0.55);
      ctx.lineTo(tgIconX + tgIconSize * 0.6, tgIconY + tgIconSize * 0.45);
      ctx.lineTo(tgIconX + tgIconSize * 0.45, tgIconY + tgIconSize);
      ctx.fillStyle = colors.creamDark;
      ctx.fill();

      // Telegram username
      ctx.fillStyle = colors.warmGray;
      ctx.textAlign = 'right';
      ctx.fillText(tgText, tgRightX, footerCenterY + 5);

      return canvas;
    }

    downloadBtn.addEventListener('click', () => {
      const canvas = generateImage();
      const link = document.createElement('a');
      link.download = 'mortgage-calculation.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ===== SHARE FUNCTIONALITY =====
    const shareBtn = document.getElementById('share-btn');
    const shareDropdown = document.getElementById('share-dropdown');
    const copyLinkBtn = document.getElementById('copy-link-btn');
    const shareTelegram = document.getElementById('share-telegram');
    const shareWhatsapp = document.getElementById('share-whatsapp');
    const shareVk = document.getElementById('share-vk');

    // Generate share text
    function getShareText() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      let paymentText;
      if (paymentType === 'differentiated') {
        const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
        paymentText = `${formatNumber(diff.first)} → ${formatNumber(diff.last)} ₽/мес (дифф.)`;
      } else {
        const payment = calculateAnnuityPayment(loanAmount, interestRate, term);
        paymentText = `${formatNumber(payment)} ₽/мес`;
      }

      return `Расчёт ипотеки: ${paymentText}\n` +
             `Сумма: ${formatNumber(loanAmount)} ₽, ставка ${interestRate}%, срок ${term} лет`;
    }

    // Position dropdown relative to button
    function positionDropdown() {
      const btnRect = shareBtn.getBoundingClientRect();
      const dropdownWidth = shareDropdown.offsetWidth || 160;
      shareDropdown.style.top = (btnRect.bottom + 6) + 'px';
      // Center dropdown under button
      shareDropdown.style.left = (btnRect.left + btnRect.width / 2 - dropdownWidth / 2) + 'px';
    }

    // Toggle dropdown
    shareBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isActive = shareDropdown.classList.contains('active');

      if (!isActive) {
        // Position dropdown
        positionDropdown();

        // Update share links before showing
        const shareUrl = window.location.href;
        const shareText = getShareText();

        shareTelegram.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
        shareWhatsapp.href = `https://wa.me/?text=${encodeURIComponent(shareText + '\n' + shareUrl)}`;
        shareVk.href = `https://vk.com/share.php?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareText)}`;
      }

      shareDropdown.classList.toggle('active');
    });

    // Reposition on scroll/resize
    window.addEventListener('scroll', () => {
      if (shareDropdown.classList.contains('active')) {
        positionDropdown();
      }
    });
    window.addEventListener('resize', () => {
      if (shareDropdown.classList.contains('active')) {
        positionDropdown();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const shareWrapper = document.querySelector('.share-wrapper');
      if (!shareWrapper.contains(e.target)) {
        shareDropdown.classList.remove('active');
      }
    });

    // Prevent dropdown from closing when clicking inside dropdown
    shareDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Copy link functionality
    copyLinkBtn.addEventListener('click', async () => {
      const shareUrl = window.location.href;

      try {
        await navigator.clipboard.writeText(shareUrl);

        // Show success state
        const span = copyLinkBtn.querySelector('span');
        const originalText = span.textContent;
        copyLinkBtn.classList.add('copied');
        span.textContent = 'Скопировано!';

        // Reset after 2 seconds
        setTimeout(() => {
          copyLinkBtn.classList.remove('copied');
          span.textContent = originalText;
        }, 2000);
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = shareUrl;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        const span = copyLinkBtn.querySelector('span');
        const originalText = span.textContent;
        copyLinkBtn.classList.add('copied');
        span.textContent = 'Скопировано!';

        setTimeout(() => {
          copyLinkBtn.classList.remove('copied');
          span.textContent = originalText;
        }, 2000);
      }
    });

    // Close dropdown after clicking on social share link
    [shareTelegram, shareWhatsapp, shareVk].forEach(link => {
      link.addEventListener('click', () => {
        setTimeout(() => {
          shareDropdown.classList.remove('active');
        }, 100);
      });
    });

    // ===== EARLY REPAYMENT FUNCTIONALITY =====
    const earlyRepaymentSection = document.getElementById('early-repayment-section');
    const earlyRepaymentHeader = document.getElementById('early-repayment-header');
    const earlyRepaymentsList = document.getElementById('early-repayments-list');
    const earlyRepaymentsEmpty = document.getElementById('early-repayments-empty');
    const addRepaymentBtn = document.getElementById('add-repayment-btn');
    const earlyRepaymentSummary = document.getElementById('early-repayment-summary');

    // Summary elements
    const summaryNewTerm = document.getElementById('summary-new-term');
    const summaryTermSaved = document.getElementById('summary-term-saved');
    const summaryNewInterest = document.getElementById('summary-new-interest');
    const summaryInterestSaved = document.getElementById('summary-interest-saved');

    // Store early repayments
    let earlyRepayments = [];
    let repaymentIdCounter = 0;

    // Toggle section open/close
    earlyRepaymentHeader.addEventListener('click', () => {
      const wasOpen = earlyRepaymentSection.classList.contains('open');
      earlyRepaymentSection.classList.toggle('open');

      // Auto-create first repayment item when opening empty section
      if (!wasOpen) {
        const items = earlyRepaymentsList.querySelectorAll('.early-repayment-item');
        if (items.length === 0) {
          const { term } = getValues();
          const id = repaymentIdCounter++;
          const item = createRepaymentItem(id, term);
          earlyRepaymentsList.insertBefore(item, earlyRepaymentsEmpty);
          updateEmptyState();
        }
        // Show summary block immediately when opening
        earlyRepaymentSummary.style.display = 'block';
      }
    });

    // Generate month options based on term
    const monthNames = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];

    function generateMonthOptions(term) {
      const totalMonths = term * 12;
      const now = new Date();
      let options = '';
      for (let m = 1; m <= totalMonths; m++) {
        const futureDate = new Date(now.getFullYear(), now.getMonth() + m, 1);
        const monthName = monthNames[futureDate.getMonth()];
        const year = futureDate.getFullYear();
        options += `<option value="${m}">${monthName} ${year} (${m}-й платёж)</option>`;
      }
      return options;
    }

    // Generate custom dropdown options for month selector with balance info
    function generateMonthDropdownOptions(term) {
      const totalMonths = term * 12;
      const now = new Date();

      // Get current calculation params to show balance
      const { propertyPrice, downPayment, interestRate, paymentType } = getValues();
      const amount = Math.max(0, propertyPrice - downPayment);
      const rate = interestRate;

      // Calculate schedule to get balance at each month
      const monthlyRate = rate / 100 / 12;
      let balance = amount;
      const balances = [amount]; // Balance before payment 1

      if (paymentType === 'annuity') {
        const monthlyPayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) /
                               (Math.pow(1 + monthlyRate, totalMonths) - 1);
        for (let m = 1; m <= totalMonths; m++) {
          const interest = balance * monthlyRate;
          const principal = monthlyPayment - interest;
          balance = Math.max(0, balance - principal);
          balances.push(balance);
        }
      } else {
        const monthlyPrincipal = amount / totalMonths;
        for (let m = 1; m <= totalMonths; m++) {
          balance = Math.max(0, balance - monthlyPrincipal);
          balances.push(balance);
        }
      }

      let options = '';
      let currentYear = null;

      for (let m = 1; m <= totalMonths; m++) {
        const futureDate = new Date(now.getFullYear(), now.getMonth() + m, 1);
        const monthName = monthNames[futureDate.getMonth()];
        const year = futureDate.getFullYear();
        const selected = m === 1 ? ' selected' : '';

        // Add year divider if year changed
        if (year !== currentYear) {
          if (currentYear !== null) {
            options += `<div class="month-dropdown-year-divider">${year} год</div>`;
          }
          currentYear = year;
        }

        // Balance before this payment
        const balanceAtMonth = Math.round(balances[m - 1]);
        const paidPercent = Math.round((1 - balanceAtMonth / amount) * 100);

        options += `
          <div class="custom-dropdown-option${selected}" data-value="${m}" role="option">
            <div class="month-option-main">
              <span class="month-option-date">${monthName} ${year}</span>
              <span class="month-option-payment">${m}-й платёж</span>
            </div>
            <div class="month-option-balance">
              <span class="month-option-remaining">Остаток: ${formatNumber(balanceAtMonth)} ₽</span>
              <span class="month-option-progress">${paidPercent}% выплачено</span>
            </div>
            <svg class="custom-dropdown-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>`;
      }
      return options;
    }

    // Get month display text
    function getMonthDisplayText(monthValue) {
      const now = new Date();
      const futureDate = new Date(now.getFullYear(), now.getMonth() + parseInt(monthValue), 1);
      const monthName = monthNames[futureDate.getMonth()];
      const year = futureDate.getFullYear();
      return `${monthName} ${year} (${monthValue}-й)`;
    }

    // Custom dropdown labels
    const dropdownLabels = {
      'reduce-term': 'Уменьшить срок',
      'reduce-payment': 'Уменьшить платёж'
    };

    // Sync custom dropdown UI with value
    function syncCustomDropdown(dropdown, value) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger-text');
      const options = dropdown.querySelectorAll('.custom-dropdown-option');

      dropdown.dataset.value = value;
      trigger.textContent = dropdownLabels[value];

      options.forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.value === value);
      });
    }

    // Sync month dropdown UI with value
    function syncMonthDropdown(dropdown, value) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger-text');
      const options = dropdown.querySelectorAll('.custom-dropdown-option');
      const menu = dropdown.querySelector('.custom-dropdown-menu');

      dropdown.dataset.value = value;
      trigger.textContent = getMonthDisplayText(value);

      options.forEach(opt => {
        const isSelected = opt.dataset.value === String(value);
        opt.classList.toggle('selected', isSelected);
        // Scroll selected option into view
        if (isSelected && menu) {
          setTimeout(() => {
            opt.scrollIntoView({ block: 'nearest' });
          }, 0);
        }
      });
    }

    // Initialize month dropdown behavior
    function initMonthDropdown(dropdown, nativeSelect) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger');
      const menu = dropdown.querySelector('.custom-dropdown-menu');
      const options = dropdown.querySelectorAll('.custom-dropdown-option');

      // Toggle dropdown on trigger click
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = dropdown.classList.contains('open');
        closeAllDropdowns();

        if (!isOpen) {
          dropdown.classList.add('open');
          // Scroll to selected option when opening
          const selectedOpt = menu.querySelector('.custom-dropdown-option.selected');
          if (selectedOpt) {
            setTimeout(() => {
              selectedOpt.scrollIntoView({ block: 'nearest' });
            }, 0);
          }
        }
      });

      // Handle option selection
      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const value = option.dataset.value;

          // Update native select
          nativeSelect.value = value;

          // Sync dropdown
          syncMonthDropdown(dropdown, value);

          // Close dropdown
          dropdown.classList.remove('open');

          // Trigger change event
          nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });

      // Keyboard navigation
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('open');
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          if (!dropdown.classList.contains('open')) {
            dropdown.classList.add('open');
          } else {
            const currentValue = parseInt(dropdown.dataset.value);
            const maxMonths = options.length;
            const newValue = e.key === 'ArrowDown'
              ? Math.min(currentValue + 1, maxMonths)
              : Math.max(currentValue - 1, 1);

            if (newValue !== currentValue) {
              nativeSelect.value = newValue;
              syncMonthDropdown(dropdown, newValue);
              nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        }
      });
    }

    // Close all open dropdowns
    function closeAllDropdowns() {
      document.querySelectorAll('.custom-dropdown.open').forEach(d => {
        d.classList.remove('open');
      });
    }

    // Initialize custom dropdown behavior
    function initCustomDropdown(dropdown, nativeSelect) {
      const trigger = dropdown.querySelector('.custom-dropdown-trigger');
      const menu = dropdown.querySelector('.custom-dropdown-menu');
      const options = dropdown.querySelectorAll('.custom-dropdown-option');

      // Toggle dropdown on trigger click
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = dropdown.classList.contains('open');
        closeAllDropdowns();

        if (!isOpen) {
          dropdown.classList.add('open');
        }
      });

      // Handle option selection
      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const value = option.dataset.value;

          // Update native select
          nativeSelect.value = value;

          // Sync custom dropdown
          syncCustomDropdown(dropdown, value);

          // Close dropdown
          dropdown.classList.remove('open');

          // Trigger change event
          nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });

      // Keyboard navigation
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('open');
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          if (!dropdown.classList.contains('open')) {
            dropdown.classList.add('open');
          } else {
            // Find current selected and move to next/prev
            const currentValue = dropdown.dataset.value;
            const values = ['reduce-term', 'reduce-payment'];
            const currentIndex = values.indexOf(currentValue);
            const newIndex = e.key === 'ArrowDown'
              ? Math.min(currentIndex + 1, values.length - 1)
              : Math.max(currentIndex - 1, 0);

            if (newIndex !== currentIndex) {
              const newValue = values[newIndex];
              nativeSelect.value = newValue;
              syncCustomDropdown(dropdown, newValue);
              nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        }
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.custom-dropdown')) {
        closeAllDropdowns();
      }
    });

    // Create repayment item HTML
    function createRepaymentItem(id, term) {
      const div = document.createElement('div');
      div.className = 'early-repayment-item';
      div.dataset.id = id;
      div.innerHTML = `
        <div class="early-repayment-item-field">
          <span class="early-repayment-item-label">Когда внести</span>
          <div class="custom-dropdown month-dropdown" data-value="1">
            <!-- Native select for mobile -->
            <select class="early-repayment-item-select repayment-month">
              ${generateMonthOptions(term)}
            </select>
            <!-- Custom dropdown trigger for desktop -->
            <button type="button" class="custom-dropdown-trigger" aria-haspopup="listbox">
              <span class="custom-dropdown-trigger-text">${getMonthDisplayText(1)}</span>
              <svg class="custom-dropdown-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <!-- Custom dropdown menu for desktop -->
            <div class="custom-dropdown-menu" role="listbox">
              ${generateMonthDropdownOptions(term)}
            </div>
          </div>
        </div>
        <div class="early-repayment-item-field">
          <span class="early-repayment-item-label">Сумма</span>
          <input type="text" class="early-repayment-item-input repayment-amount" placeholder="100 000" inputmode="numeric">
        </div>
        <div class="early-repayment-item-field">
          <span class="early-repayment-item-label">Периодичность</span>
          <div class="repayment-frequency-toggle">
            <button type="button" class="repayment-frequency-btn active" data-frequency="once">Разово</button>
            <button type="button" class="repayment-frequency-btn" data-frequency="monthly">Ежемесячно</button>
          </div>
          <input type="hidden" class="repayment-frequency" value="once">
        </div>
        <div class="early-repayment-item-field">
          <span class="early-repayment-item-label">Эффект</span>
          <div class="custom-dropdown" data-value="reduce-term">
            <!-- Native select for mobile -->
            <select class="early-repayment-item-select repayment-type">
              <option value="reduce-term">Уменьшить срок</option>
              <option value="reduce-payment">Уменьшить платёж</option>
            </select>
            <!-- Custom dropdown trigger for desktop -->
            <button type="button" class="custom-dropdown-trigger" aria-haspopup="listbox">
              <span class="custom-dropdown-trigger-text">Уменьшить срок</span>
              <svg class="custom-dropdown-trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <!-- Custom dropdown menu for desktop -->
            <div class="custom-dropdown-menu" role="listbox">
              <div class="custom-dropdown-option selected" data-value="reduce-term" role="option">
                <svg class="custom-dropdown-option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 8 14"></polyline>
                </svg>
                <div class="custom-dropdown-option-content">
                  <div class="custom-dropdown-option-title">Уменьшить срок</div>
                  <div class="custom-dropdown-option-desc">Быстрее погасите кредит</div>
                </div>
                <svg class="custom-dropdown-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <div class="custom-dropdown-option" data-value="reduce-payment" role="option">
                <svg class="custom-dropdown-option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <div class="custom-dropdown-option-content">
                  <div class="custom-dropdown-option-title">Уменьшить платёж</div>
                  <div class="custom-dropdown-option-desc">Снизите ежемесячную нагрузку</div>
                </div>
                <svg class="custom-dropdown-option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="early-repayment-remove" title="Удалить">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      `;

      // Add event listeners
      const amountInput = div.querySelector('.repayment-amount');
      const monthSelect = div.querySelector('.repayment-month');
      const typeSelect = div.querySelector('.repayment-type');
      const frequencyInput = div.querySelector('.repayment-frequency');
      const frequencyBtns = div.querySelectorAll('.repayment-frequency-btn');
      const removeBtn = div.querySelector('.early-repayment-remove');
      const monthDropdown = div.querySelector('.month-dropdown');
      const typeDropdown = div.querySelector('.custom-dropdown:not(.month-dropdown)');

      // Format amount on input
      amountInput.addEventListener('input', () => {
        const value = parseFormattedNumber(amountInput.value);
        if (value > 0) {
          amountInput.value = formatNumber(value);
        }
        updateEarlyRepaymentData();
      });

      // Listen for changes
      monthSelect.addEventListener('change', () => {
        // Sync month dropdown with native select
        syncMonthDropdown(monthDropdown, monthSelect.value);
        updateEarlyRepaymentData();
      });
      typeSelect.addEventListener('change', () => {
        // Sync custom dropdown with native select
        syncCustomDropdown(typeDropdown, typeSelect.value);
        updateEarlyRepaymentData();
      });

      // Frequency toggle
      const frequencyToggle = div.querySelector('.repayment-frequency-toggle');
      frequencyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          frequencyBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          frequencyInput.value = btn.dataset.frequency;
          // Toggle class for sliding animation
          frequencyToggle.classList.toggle('monthly', btn.dataset.frequency === 'monthly');
          updateEarlyRepaymentData();
        });
      });

      // Initialize custom dropdown behavior for month selector
      initMonthDropdown(monthDropdown, monthSelect);

      // Initialize custom dropdown behavior for type selector
      initCustomDropdown(typeDropdown, typeSelect);

      // Remove button
      removeBtn.addEventListener('click', () => {
        const index = earlyRepayments.findIndex(r => r.id === id);
        if (index !== -1) {
          earlyRepayments.splice(index, 1);
        }
        div.remove();
        updateEmptyState();
        updateEarlyRepaymentCalculations();
        // Save after removal
        saveToStorage();
        saveToUrl();
      });

      return div;
    }

    // Update empty state visibility
    function updateEmptyState() {
      const items = earlyRepaymentsList.querySelectorAll('.early-repayment-item');
      earlyRepaymentsEmpty.style.display = items.length === 0 ? 'block' : 'none';
    }

    // Collect repayment data from DOM
    function updateEarlyRepaymentData() {
      const items = earlyRepaymentsList.querySelectorAll('.early-repayment-item');
      earlyRepayments = [];

      items.forEach(item => {
        const id = parseInt(item.dataset.id, 10);
        const month = parseInt(item.querySelector('.repayment-month').value, 10);
        const amount = parseFormattedNumber(item.querySelector('.repayment-amount').value);
        const type = item.querySelector('.repayment-type').value;
        const frequency = item.querySelector('.repayment-frequency').value;

        if (amount > 0) {
          earlyRepayments.push({ id, month, amount, type, frequency });
        }
      });

      updateEarlyRepaymentCalculations();
      // Save to storage and URL when early repayments change (but not during init)
      if (!isInitializing) {
        saveToStorage();
        saveToUrl();
      }
    }

    // Add repayment button click
    addRepaymentBtn.addEventListener('click', () => {
      const { term } = getValues();
      const id = repaymentIdCounter++;
      const item = createRepaymentItem(id, term);
      earlyRepaymentsList.insertBefore(item, earlyRepaymentsEmpty);
      updateEmptyState();
    });

    // Calculate schedule with early repayments
    function generateScheduleWithEarlyRepayments(principal, annualRate, years, paymentType, repayments) {
      const monthlyRate = annualRate / 100 / 12;
      let totalMonths = years * 12;
      const originalTotalMonths = totalMonths;
      const schedule = [];
      let balance = principal;
      let currentMonthlyPayment = paymentType === 'annuity'
        ? calculateAnnuityPayment(principal, annualRate, years)
        : principal / totalMonths;

      // Sort repayments by month first to ensure consistent processing
      const sortedRepayments = [...repayments].sort((a, b) => a.month - b.month);

      // Expand monthly repayments into individual months
      const expandedRepayments = [];
      sortedRepayments.forEach(r => {
        if (r.frequency === 'monthly') {
          // Add repayment for each month starting from specified month until end
          for (let m = r.month; m <= originalTotalMonths; m++) {
            expandedRepayments.push({
              ...r,
              month: m,
              isMonthly: true
            });
          }
        } else {
          expandedRepayments.push({ ...r, isMonthly: false });
        }
      });

      // Group by month and sum amounts (in case multiple repayments on same month)
      const repaymentsByMonth = {};
      expandedRepayments.forEach(r => {
        if (!repaymentsByMonth[r.month]) {
          repaymentsByMonth[r.month] = { amount: 0, type: r.type };
        }
        repaymentsByMonth[r.month].amount += r.amount;
        // If any repayment wants reduce-term, use that
        if (r.type === 'reduce-term') {
          repaymentsByMonth[r.month].type = 'reduce-term';
        }
      });

      let month = 0;
      let totalInterestPaid = 0;
      let totalPrincipalPaid = 0;

      while (balance > 0.01 && month < totalMonths) {
        month++;

        // Calculate interest for this month
        const interestPayment = balance * monthlyRate;

        // For differentiated, recalculate principal part
        let principalPayment;
        if (paymentType === 'annuity') {
          principalPayment = currentMonthlyPayment - interestPayment;
        } else {
          principalPayment = principal / (years * 12); // Fixed principal part
        }

        // Ensure we don't pay more than balance
        if (principalPayment > balance) {
          principalPayment = balance;
        }

        const regularPayment = principalPayment + interestPayment;

        // Check for early repayments this month
        let earlyPayment = 0;
        const repaymentThisMonth = repaymentsByMonth[month];

        if (repaymentThisMonth && balance > 0) {
          // Early payment can't exceed remaining balance after regular principal payment
          const maxEarlyPayment = Math.max(0, balance - principalPayment);
          earlyPayment = Math.min(repaymentThisMonth.amount, maxEarlyPayment);

          if (repaymentThisMonth.type === 'reduce-term' && paymentType === 'annuity') {
            // After early payment, recalculate remaining term at same payment
            const newBalance = balance - principalPayment - earlyPayment;
            if (newBalance > 0 && monthlyRate > 0) {
              // Calculate new remaining months
              // Formula: n = log(PMT / (PMT - PV * r)) / log(1 + r)
              // Only valid when PMT > PV * r (payment covers interest)
              const monthlyInterestOnBalance = newBalance * monthlyRate;
              if (currentMonthlyPayment > monthlyInterestOnBalance) {
                const newMonths = Math.ceil(
                  Math.log(currentMonthlyPayment / (currentMonthlyPayment - monthlyInterestOnBalance)) /
                  Math.log(1 + monthlyRate)
                );
                if (isFinite(newMonths) && newMonths > 0) {
                  totalMonths = month + newMonths;
                }
              }
            }
          } else if (repaymentThisMonth.type === 'reduce-payment' && paymentType === 'annuity') {
            // Recalculate payment for remaining term
            const newBalance = balance - principalPayment - earlyPayment;
            const remainingMonths = totalMonths - month;
            if (newBalance > 0 && remainingMonths > 0) {
              currentMonthlyPayment = calculateAnnuityPayment(newBalance, annualRate, remainingMonths / 12);
            }
          }
        }

        balance = Math.max(0, balance - principalPayment - earlyPayment);
        totalInterestPaid += interestPayment;
        totalPrincipalPaid += principalPayment + earlyPayment;

        schedule.push({
          month,
          year: Math.ceil(month / 12),
          payment: regularPayment + earlyPayment,
          principal: principalPayment + earlyPayment,
          interest: interestPayment,
          earlyPayment,
          balance
        });
      }

      return {
        schedule,
        totalMonths: month,
        totalInterest: totalInterestPaid
      };
    }

    // Update early repayment calculations and summary
    function updateEarlyRepaymentCalculations() {
      const { propertyPrice, downPayment, interestRate, term, paymentType } = getValues();
      const loanAmount = Math.max(0, propertyPrice - downPayment);

      if (loanAmount <= 0 || interestRate <= 0 || term <= 0 || earlyRepayments.length === 0) {
        // Keep summary visible if section is open, just show placeholder values
        if (earlyRepaymentSection.classList.contains('open')) {
          earlyRepaymentSummary.style.display = 'block';
          summaryNewTerm.textContent = '—';
          summaryTermSaved.textContent = '—';
          summaryNewInterest.textContent = '—';
          summaryInterestSaved.textContent = '—';
        } else {
          earlyRepaymentSummary.style.display = 'none';
        }
        // Reset schedule to normal
        updateSchedule();
        return;
      }

      // Calculate without early repayments
      let originalTotalInterest;
      if (paymentType === 'annuity') {
        const monthlyPayment = calculateAnnuityPayment(loanAmount, interestRate, term);
        originalTotalInterest = monthlyPayment * term * 12 - loanAmount;
      } else {
        const diff = calculateDifferentiatedPayment(loanAmount, interestRate, term);
        originalTotalInterest = diff.totalInterest;
      }
      const originalTermMonths = term * 12;

      // Calculate with early repayments
      const result = generateScheduleWithEarlyRepayments(
        loanAmount,
        interestRate,
        term,
        paymentType,
        earlyRepayments
      );

      const newTermMonths = result.totalMonths;
      const newTotalInterest = result.totalInterest;

      // Calculate savings
      const monthsSaved = originalTermMonths - newTermMonths;
      const interestSaved = originalTotalInterest - newTotalInterest;

      // Update summary display
      const formatTermText = (months) => {
        const years = Math.floor(months / 12);
        const remainingMonths = months % 12;
        if (years === 0) return `${remainingMonths} мес.`;
        if (remainingMonths === 0) return `${years} ${years === 1 ? 'год' : years < 5 ? 'года' : 'лет'}`;
        return `${years} ${years === 1 ? 'год' : years < 5 ? 'года' : 'лет'} ${remainingMonths} мес.`;
      };

      summaryNewTerm.textContent = formatTermText(newTermMonths);
      summaryTermSaved.textContent = monthsSaved > 0 ? `−${formatTermText(monthsSaved)}` : '—';
      summaryNewInterest.textContent = formatNumber(newTotalInterest) + ' ₽';
      summaryInterestSaved.textContent = interestSaved > 0 ? `−${formatNumber(interestSaved)} ₽` : '—';

      earlyRepaymentSummary.style.display = 'block';

      // Update chart and table with new schedule
      currentSchedule = result.schedule; // Store for view switching
      drawChartWithSchedule(result.schedule, loanAmount);
      updateScheduleTableWithSchedule(result.schedule);
    }

    // Draw chart with custom schedule
    function drawChartWithSchedule(schedule, initialPrincipal) {
      const yearlyData = aggregateByYear(schedule);
      const svgWidth = 650;
      const svgHeight = 240;
      const margin = { top: 20, right: 20, bottom: 35, left: 70 };

      const chartWidth = svgWidth - margin.left - margin.right;
      const chartHeight = svgHeight - margin.top - margin.bottom;
      const bottomY = margin.top + chartHeight; // Base line for animation origin

      // Use actual month count (last year may have fewer than 12 months)
      const monthlyData = yearlyData.map(d => ({
        year: d.year,
        principal: d.principal / d.monthCount,
        interest: d.interest / d.monthCount,
        total: (d.principal + d.interest) / d.monthCount
      }));

      const maxPayment = Math.max(...monthlyData.map(d => d.total));
      const yAxisMax = Math.ceil(maxPayment / 10000) * 10000;

      const numYears = monthlyData.length;
      const barWidth = chartWidth / numYears;

      let html = '';

      // Grid lines and Y axis labels
      const yTicks = 5;
      for (let i = 0; i <= yTicks; i++) {
        const value = (yAxisMax / yTicks) * i;
        const y = margin.top + chartHeight - (chartHeight * i / yTicks);
        html += `<line class="chart-grid-line" x1="${margin.left}" y1="${y}" x2="${svgWidth - margin.right}" y2="${y}"/>`;
        html += `<text class="chart-axis-label chart-axis-label-y" x="${margin.left - 8}" y="${y + 4}">${formatShortAmount(value)} ₽</text>`;
      }

      // Build stacked bars with tooltips
      monthlyData.forEach((data, i) => {
        const x = margin.left + i * barWidth + barWidth * 0.1;
        const rectWidth = barWidth * 0.8;

        const principalHeight = (data.principal / yAxisMax) * chartHeight;
        const interestHeight = (data.interest / yAxisMax) * chartHeight;

        const principalY = margin.top + chartHeight - principalHeight;
        const interestY = principalY - interestHeight;

        // Animation delay for staggered effect
        const animDelay = i * 0.04;
        const centerX = x + rectWidth / 2;

        // Group for hover effect with data attributes for tooltip
        const yearData = yearlyData[i];
        html += `<g class="chart-bar-group"
          data-year="${data.year}"
          data-principal="${Math.round(data.principal)}"
          data-interest="${Math.round(data.interest)}"
          data-total="${Math.round(data.total)}"
          data-year-principal="${Math.round(yearData.principal)}"
          data-year-interest="${Math.round(yearData.interest)}"
          data-balance="${Math.round(yearData.balance)}">`;

        // Invisible rect for better hover area
        html += `<rect x="${x}" y="${interestY}" width="${rectWidth}" height="${principalHeight + interestHeight}" fill="transparent"/>`;
        // Interest on top (darker) - rounded only at top
        if (interestHeight > 0) {
          html += `<path class="chart-area-interest" style="transform-origin: ${centerX}px ${bottomY}px; animation-delay: ${animDelay}s" d="
            M${x + 3},${interestY}
            Q${x},${interestY} ${x},${interestY + 3}
            L${x},${interestY + interestHeight}
            L${x + rectWidth},${interestY + interestHeight}
            L${x + rectWidth},${interestY + 3}
            Q${x + rectWidth},${interestY} ${x + rectWidth - 3},${interestY}
            Z"/>`;
        }
        // Principal on bottom (lighter) - rounded only at bottom
        html += `<path class="chart-area-principal" style="transform-origin: ${centerX}px ${bottomY}px; animation-delay: ${animDelay}s" d="
          M${x},${principalY}
          L${x},${margin.top + chartHeight - 3}
          Q${x},${margin.top + chartHeight} ${x + 3},${margin.top + chartHeight}
          L${x + rectWidth - 3},${margin.top + chartHeight}
          Q${x + rectWidth},${margin.top + chartHeight} ${x + rectWidth},${margin.top + chartHeight - 3}
          L${x + rectWidth},${principalY}
          Z"/>`;
        html += `</g>`;

        const showLabel = numYears <= 15 || i % 2 === 0 || i === numYears - 1;
        if (showLabel) {
          html += `<text class="chart-year-label" x="${x + rectWidth / 2}" y="${svgHeight - margin.bottom + 16}">${data.year}</text>`;
        }
      });

      html += `<text class="chart-axis-label chart-axis-label-x" x="${margin.left + chartWidth / 2}" y="${svgHeight - 5}">Год кредита</text>`;

      scheduleChartSvg.innerHTML = html;
    }

    // Update table with custom schedule
    function updateScheduleTableWithSchedule(schedule) {
      const data = currentView === 'yearly' ? aggregateByYear(schedule) : schedule;

      let html = '';
      data.forEach(item => {
        const period = currentView === 'yearly' ? `${item.year} год` : `${item.month} мес.`;
        const hasEarly = item.earlyPayment && item.earlyPayment > 0;
        const earlyTooltip = hasEarly ? `Досрочное погашение: ${formatNumber(item.earlyPayment)} ₽` : '';
        html += `
          <tr${hasEarly ? ' style="background: rgba(212, 160, 60, 0.08);"' : ''}>
            <td>${period}${hasEarly ? ` <span class="early-payment-star" data-tooltip="${earlyTooltip}">★</span>` : ''}</td>
            <td>${formatNumber(item.payment)} ₽</td>
            <td class="principal-cell">${formatNumber(item.principal)} ₽</td>
            <td class="interest-cell">${formatNumber(item.interest)} ₽</td>
            <td class="balance-cell">${formatNumber(item.balance)} ₽</td>
          </tr>
        `;
      });

      scheduleTableBody.innerHTML = html;
    }

    // Update term month options when term changes
    function updateRepaymentMonthOptions() {
      const { term } = getValues();
      const items = earlyRepaymentsList.querySelectorAll('.early-repayment-item');
      items.forEach(item => {
        const monthSelect = item.querySelector('.repayment-month');
        const monthDropdown = item.querySelector('.month-dropdown');
        const currentValue = monthSelect.value;

        // Update native select options
        monthSelect.innerHTML = generateMonthOptions(term);

        // Update custom dropdown options
        if (monthDropdown) {
          const menu = monthDropdown.querySelector('.custom-dropdown-menu');
          if (menu) {
            menu.innerHTML = generateMonthDropdownOptions(term);
            // Re-attach event listeners for new options
            const newOptions = menu.querySelectorAll('.custom-dropdown-option');
            newOptions.forEach(option => {
              option.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const value = option.dataset.value;
                monthSelect.value = value;
                syncMonthDropdown(monthDropdown, value);
                monthDropdown.classList.remove('open');
                monthSelect.dispatchEvent(new Event('change', { bubbles: true }));
              });
            });
          }
        }

        // Try to restore previous value if still valid
        if (currentValue <= term * 12) {
          monthSelect.value = currentValue;
          if (monthDropdown) {
            syncMonthDropdown(monthDropdown, currentValue);
          }
        }
      });
      updateEarlyRepaymentData();
    }

    // Hook into term changes
    termRadios.forEach(radio => {
      radio.addEventListener('change', updateRepaymentMonthOptions);
    });
    termCustomInput.addEventListener('input', updateRepaymentMonthOptions);

    // Re-calculate early repayments when main values change
    const originalUpdateCalcForEarly = updateCalculations;
    updateCalculations = function() {
      originalUpdateCalcForEarly();
      if (earlyRepayments.length > 0) {
        updateEarlyRepaymentCalculations();
      }
      // Also save to storage when values change
      saveToStorage();
    };

    // Restore pending early repayments from URL or localStorage
    if (window._pendingEarlyRepayments && window._pendingEarlyRepayments.length > 0) {
      const { term } = getValues();
      window._pendingEarlyRepayments.forEach(er => {
        const id = repaymentIdCounter++;
        const item = createRepaymentItem(id, term);
        earlyRepaymentsList.insertBefore(item, earlyRepaymentsEmpty);

        // Set values
        const monthSelect = item.querySelector('.repayment-month');
        const monthDropdown = item.querySelector('.month-dropdown');
        const amountInput = item.querySelector('.repayment-amount');
        const typeSelect = item.querySelector('.repayment-type');
        const frequencyInput = item.querySelector('.repayment-frequency');
        const frequencyBtns = item.querySelectorAll('.repayment-frequency-btn');
        const frequencyToggle = item.querySelector('.repayment-frequency-toggle');
        const typeDropdown = item.querySelector('.custom-dropdown:not(.month-dropdown)');

        if (er.month <= term * 12) {
          monthSelect.value = er.month;
          if (monthDropdown) {
            syncMonthDropdown(monthDropdown, er.month);
          }
        }
        if (er.amount > 0) {
          amountInput.value = formatNumber(er.amount);
        }
        typeSelect.value = er.type;
        syncCustomDropdown(typeDropdown, er.type);
        frequencyInput.value = er.frequency;

        // Update frequency toggle UI
        frequencyBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.frequency === er.frequency);
        });
        frequencyToggle.classList.toggle('monthly', er.frequency === 'monthly');
      });

      updateEmptyState();
      // Open the section if there are repayments
      earlyRepaymentSection.classList.add('open');
      earlyRepaymentSummary.style.display = 'block';
      updateEarlyRepaymentData();
      delete window._pendingEarlyRepayments;
    }

    // Initialization complete, allow URL updates
    isInitializing = false;

    // Final schedule update to ensure chart and table are rendered
    // This handles the case when early repayments exist and override the initial schedule
    if (earlyRepayments.length > 0) {
      updateEarlyRepaymentCalculations();
    } else {
      updateSchedule();
    }
  </script>
</body>
</html>
